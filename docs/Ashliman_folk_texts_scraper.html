
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ashliman “Folklore and Mythology Electronic Texts” Scraper &#8212; Story Notes - Technical Recipes</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Multilingual Folk Tale Database (MFTD)" href="MFTD-Multilingual_Folk_Tale_Database.html" />
    <link rel="prev" title="Identifying Common Refrains / Repeating Phrases In Lang’s Fairy Story Collections" href="lang-fairy-books-db_PART_4.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Story Notes - Technical Recipes</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="preface.html">
                    Preface
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="how-to-read-this-book.html">
   How To Read This Book (Do Not Be Afraid)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="running-the-book-code.html">
   Invoking the Incantations Contained in This Book
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Story Collection Scrapers and Search
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="lang-fairy-books-db.html">
   A Full Text Searchable Database of Lang’s Fairy Books
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lang-fairy-books-db_PART_2.html">
   Finding Book Index-Like Things In Lang’s Fairy Stories…
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lang-fairy-books-db_PART_3.html">
   Annotating Lang’s Fairy Tales With Wikipedia Links
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lang-fairy-books-db_PART_4.html">
   Identifying Common Refrains / Repeating Phrases In Lang’s Fairy Story Collections
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Ashliman “Folklore and Mythology Electronic Texts” Scraper
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="MFTD-Multilingual_Folk_Tale_Database.html">
   Multilingual Folk Tale Database (MFTD)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Duncan_Williamson_Tobar_Audio.html">
   Duncan Williamson Audio Recordings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="gibbs_tiny_tales.html">
   Gibbs Tiny Tales Collection
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Notes &amp; Queries
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Notes_and_Queries_DB.html">
   Exploring Notes &amp; Queries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Notes_and_Queries_DB_PART_2.html">
   Generating a Full Text Searchable Database for
   <em>
    Notes &amp; Queries
   </em>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Notes_and_Queries_DB_PART_3.html">
   Building a 19th c. Notes &amp; Queries Full Text Search Engine
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Notes_and_Queries_DB_PART_4.html">
   Creating a 19th c. Notes &amp; Queries Index Database
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Advanced Search Techniques
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Lang_Doc2Vec.html">
   Doc2Vec Searching of Lang Database
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tale Types
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Missouri_Tale_Types.html">
   Tale Types Scraper
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Thompson_Motif_Index.html">
   Thompson Motif Index
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Wikipedia and DBPedia
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="DBPedia_Aarne-Thompson-Uther_Search.html">
   Aarne-Thompson-Uther (ATU) Search
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/psychemedia/storynotes/main?urlpath=lab/tree/./Ashliman_folk_texts_scraper.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="./lite/retro/notebooks?path=./Ashliman_folk_texts_scraper.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch via RetroLite"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_jupyterlite.svg">
  </span>
<span class="headerbtn__text-container">RetroLite</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/psychemedia/storynotes"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-a-simple-database">
   Create a Simple Database
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Ashliman “Folklore and Mythology Electronic Texts” Scraper</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-a-simple-database">
   Create a Simple Database
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="ashliman-folklore-and-mythology-electronic-texts-scraper">
<h1>Ashliman “Folklore and Mythology Electronic Texts” Scraper<a class="headerlink" href="#ashliman-folklore-and-mythology-electronic-texts-scraper" title="Permalink to this headline">#</a></h1>
<p>A scraper to grab all the stories edited / translated by D. L. Ashliman that are referenced from <a class="reference external" href="https://sites.pitt.edu/~dash/folktexts.html">https://sites.pitt.edu/~dash/folktexts.html</a> .</p>
<p>Note that these are <em>Copyright D. L. Ashliman, University of Pittsburgh, 1996-2022</em>.</p>
<p>My intention is to create personal collection of these stories to support personal search and discovery of stories.</p>
<p>The stories appear to have been added to the website over several years. Whilst there is a lot of structure that we can can exploit to extract the story texts, there may be some stories that arenlt extracted correctly, or even at all.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">story_list_url</span> <span class="o">=</span> <span class="s2">&quot;https://sites.pitt.edu/~dash/folktexts.html&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>The stories are collected on thematic / story type pages that are referenced from <a class="reference external" href="https://sites.pitt.edu/~dash/folktexts.html">https://sites.pitt.edu/~dash/folktexts.html</a>.</p>
<p>Let’s start by grabbing links to all those pages; we’ll use <code class="docutils literal notranslate"><span class="pre">requests-cache</span></code> to cache the pages so we donlt repeatedly hit the website as we test the script…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Suppress any warnings</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="c1"># We wouldn&#39;t normally do this but it makes the book output cleaner in a couple of places...</span>

<span class="c1">#%pip install requests-HTML</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="n">requests_cache</span><span class="o">.</span><span class="n">install_cache</span><span class="p">(</span><span class="s1">&#39;web_cache&#39;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;sqlite&#39;</span><span class="p">,</span> <span class="n">expire_after</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">requests_html</span> <span class="kn">import</span> <span class="n">HTMLSession</span>
 
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://sites.pitt.edu/~dash/folktexts.html&quot;</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">HTMLSession</span><span class="p">()</span>
<span class="n">index_response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="c1"># Clean the set of links to just the links we are interested in</span>
<span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">index_response</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">absolute_links</span> <span class="k">if</span> \
         <span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>
<span class="c1"># Note that the order of the links is not guaranteed, so we&#39;ll sort them to fix the order</span>
<span class="n">links</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<span class="n">links</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;https://sites.pitt.edu/~dash/abduct.html&#39;,
 &#39;https://sites.pitt.edu/~dash/aesopold.html&#39;,
 &#39;https://sites.pitt.edu/~dash/aesopskids.html&#39;]
</pre></div>
</div>
</div>
</div>
<p>The story pages have a consistent form, so if we inspect one of the pages, we should be able to generate some sort of template for scraping all the pages.</p>
<p>First of all, grab a story page:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">page_response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s see if we can extract some information from the header at the top of the page:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the head information</span>
<span class="c1"># This works for many pages, but not all..</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">page_response</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">header</span><span class="p">:</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">page_response</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//h1[@align=&quot;CENTER&quot;]&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">header</span><span class="p">:</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">full_text</span>

<span class="n">header</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\nAbducted by Aliens  \nEdited by\n\n\nD. L. Ashliman  \n© 1999-2021\n&#39;
</pre></div>
</div>
</div>
</div>
<p>The general category is given in the first line:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">category</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">category</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Abducted by Aliens&#39;
</pre></div>
</div>
</div>
</div>
<p>We may also have subheader content:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># eg https://sites.pitt.edu/~dash/type1586.html</span>
<span class="n">subheading</span> <span class="o">=</span> <span class="n">page_response</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//p[@align=&quot;CENTER&quot;]&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">subheading</span><span class="p">:</span>
    <span class="n">subheading</span> <span class="o">=</span> <span class="n">subheading</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>

<span class="n">subheading</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<p>Some page URLs are ATU codes; we can co-ot these as low hanging fruit if we canlt otherwise access the ATU reference:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="n">url_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^type(?P&lt;atu&gt;[\da-zA-Z]+)\.html&quot;</span>

<span class="n">_url</span> <span class="o">=</span> <span class="s1">&#39;https://sites.pitt.edu/~dash/type1586.html&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="c1">#links[12].split(&#39;/&#39;)[-1]</span>
<span class="n">matches</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">url_regex</span><span class="p">,</span> <span class="n">_url</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>

<span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
    <span class="n">atu</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;atu&quot;</span><span class="p">)</span>

<span class="n">atu</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;1586&#39;
</pre></div>
</div>
</div>
</div>
<p>In some headers, there may be an indication of the Aarne-Thompson-Uther story type. If the tale type is described in a conventional way, we can easily extract it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="n">regex</span><span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^.*Aarne-Thompson-Uther type (?P&lt;atu&gt;[\da-zA-Z]+).*&quot;</span>

<span class="n">matches</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">page_response</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">full_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>

<span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
    <span class="n">atu</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;atu&quot;</span><span class="p">)</span>

<span class="n">atu</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;1586&#39;
</pre></div>
</div>
</div>
</div>
<p>Inspection of the page response HTML suggests that stories are separated by the repeated <code class="docutils literal notranslate"><span class="pre">&lt;hr/&gt;&lt;hr/&gt;</span></code> element. We can also find a break before the first tale as <code class="docutils literal notranslate"><span class="pre">\n\n&lt;hr/&gt;\n\n&lt;p&gt;\n</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the full HTML text</span>
<span class="n">html</span> <span class="o">=</span> <span class="n">page_response</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">)</span>
<span class="c1"># In some cases, the page may not be in an HTML tag but may just be body content</span>
<span class="k">if</span> <span class="n">html</span><span class="p">:</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">html</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">page_response</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">html</span>
    <span class="c1"># This pages are old so patch them</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;hr&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;hr/&gt;&quot;</span><span class="p">)</span>

<span class="c1"># Split out the section containing the stories</span>
<span class="n">stories_html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&lt;hr/&gt;</span><span class="se">\n</span><span class="s2">&lt;p&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Chunk the stories</span>
<span class="n">story_chunks</span> <span class="o">=</span> <span class="n">stories_html</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;hr/&gt;&lt;hr/&gt;&quot;</span><span class="p">)</span>
<span class="c1"># Some old pages may just carry one story with no splits</span>
<span class="c1"># If there is only one item, use that...</span>
<span class="n">story_chunks</span> <span class="o">=</span> <span class="n">story_chunks</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">story_chunks</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">story_chunks</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Preview the text in the first item</span>
<span class="n">story_chunks</span><span class="p">[:</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">][:</span><span class="mi">500</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;&lt;body text=&quot;#000000&quot; link=&quot;#0000ff&quot; vlink=&quot;#800080&quot; bgcolor=&quot;#eeffee&quot;&gt;\n&lt;hr/&gt;\n&lt;center&gt;\n&lt;h1&gt;Abducted by Aliens &lt;/h1&gt; \nEdited by&lt;br/&gt;\n&lt;a href=&quot;http://www.pitt.edu/~dash/ashliman.html&quot;&gt;&lt;img src=&quot;dash.gif&quot; align=&quot;top&quot; border=&quot;2&quot; width=&quot;42&quot; height=&quot;38&quot;/&gt;&lt;br/&gt;\n\nD. L. Ashliman&lt;/a&gt;&lt;br/&gt;  \n© 1999-2021\n&lt;/center&gt;\n&lt;p&gt;\nThe aliens in the legends that follow are not those from outer space, but\nrather underground people from our own earth: fairies, trolls, elves, and\nthe like.\n&lt;p&gt;\n&lt;hr/&gt;\n&lt;h2&gt;&lt;a name=&quot;contents&quot;&gt;Co&#39;
</pre></div>
</div>
</div>
</div>
<p>Each chunk may have additional information after the story, separated by a single <code class="docutils literal notranslate"><span class="pre">&lt;hr/&gt;</span></code>. So lets split each stroy into a 2-tuple for now of the form <code class="docutils literal notranslate"><span class="pre">(story,</span> <span class="pre">additional_info)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">story_chunk_tuples</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">story_chunk</span> <span class="ow">in</span> <span class="n">story_chunks</span><span class="p">:</span>
    <span class="n">story_chunk_items</span> <span class="o">=</span> <span class="n">story_chunk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;hr/&gt;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">story_chunk_items</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">story_chunk_tuples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">story_chunk_items</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">story_chunk_items</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
    
<span class="n">story_chunk_tuples</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;\n&lt;h2&gt;&lt;a name=&quot;brosnan&quot;&gt;Taken by the Good People&lt;/a&gt;&lt;/h2&gt;\n&lt;h3&gt;Ireland&lt;/h3&gt;\nI was serving my time to the cattle trade, with a man the name of Lynch --\nGod be good to him! I suppose I was no more than twelve years of age at\nthe time. \&#39;Twas a very out of the way place and mountainy. \n&lt;p&gt;\nWell, not far from my master\&#39;s house there was a family of the Brogans.\n\&#39;Twas the will of God that Mrs. Brogan took sick, and there was a baby\nborn, but the poor woman died. Well, the sister, a younger girl than the\nwoman that died, came to nurse the child. After some time she began to\nlook very delicate and uneasy. The naghbours were beginning to talk amongs\nthemselves about her, and it came to Brogan\&#39;s ears, and, begor, it made\nhim vexed. So he asked the sister what was up with her.\n&lt;p&gt;\n&quot;Well, John,&quot; says she, &quot;I did not like to tell you, but Ellie&quot; -- that\nwas the name of the dead woman -- &quot;comes every night, and takes the baby\nand nurses it, and goes away without a word.&quot;\n&lt;p&gt;\n&quot;By my word,&quot; says John, &quot;she is not dead at all, but taken, and I will\nwatch her to-night.&quot;\n&lt;p&gt;\nGood enough, he remained up, and about 12 o\&#39;clock in she came, and he put\nhis arms around her, but as he said, felt no substance.\n&lt;p&gt;\n&quot;You can\&#39;t keep me now,&quot; says she, &quot;for I\&#39;m married agin; but if you come\nto the Bottle Hill field to-morrow night, there will be about 40 of us\ngoin\&#39; t\&#39;words Blarney, and we will all be on horses, with our husbands.\nAll the horses will be white, and I and my man will be last. Bring a hazel\nstick woud [with] you and strike the horse on the right side, and I will\nfall off. Just as I fall, ketch me with all your might. You will know my\nman, for he is the only one of them that has a red head.&quot;\n&lt;p&gt;\nWell, he went, and he must have a great heart, for on they come, gallopin\&#39;\nlike mad. Just as the man with the red head\&#39;s horse came he stood one-side\nand struck. She fell and he gripped her like iron. Well, such a hullabaloo\nas there was, was never heard, and all the other men makin\&#39; game of the\nred-headed man.\n&lt;p&gt;\nWell, he brought her home, and they lived for years after, and had a good\nfamily, and were the happiest people around the place. I often see some of\nher children; of course they are all married now, and gone here and there,\nbut that\&#39;s as true as my name is Tim Brosnan.  &lt;p&gt;\n&#39;,
  &#39;\n&lt;ul&gt;\n&lt;li&gt;Source (Internet Archive): &quot;Folk-Tales from County Limerick collected by Miss D. Knox,&quot;\n&lt;a target=&quot;_blank&quot; href=&quot;https://archive.org/stream/folklore28folkuoft#page/n4/mode/1up&quot;&gt;&lt;i&gt;Folk-Lore: A Quarterly Review of Myth, Tradition, Institution, &amp;amp;\nCustom&lt;/i&gt;&lt;/a&gt; (London: Folk-Lore Society, 1917), v. 28, &lt;a target=&quot;_blank&quot; href=&quot;https://archive.org/stream/folklore28folkuoft#page/218/mode/2up&quot;&gt;pp. 218-219&lt;/a&gt;.&lt;p&gt;\n&lt;li&gt;Knox\&#39;s source: Told by Tim Brosnan, Dungeagan, County Kerry.&lt;p&gt;\n&lt;li&gt;I have retained Knox\&#39;s spelling.&lt;p&gt;\n&lt;li&gt;Return to the &lt;a href=&quot;#contents&quot;&gt;table of contents&lt;/a&gt;.\n&lt;/li&gt;&lt;/p&gt;&lt;/li&gt;&lt;/p&gt;&lt;/li&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;\n&#39;),
 (&#39;\n&lt;h2&gt;&lt;a name=&quot;kelly&quot;&gt;Twenty Years with the Good People&lt;/a&gt;&lt;/h2&gt;\n&lt;h3&gt;Ireland&lt;/h3&gt;\nI had a gran\&#39;uncle, he was a shoemaker; he was only about 3 or 4 months\nmarried. I\&#39;m up to fourscore now. Well, God rest all their souls, for they\nare all gone, I hope to a better world!\n&lt;p&gt;\nWell, sir, he says to his wife, and a purty girl she was, as I hear um\nsay, -- the fortune wasn\&#39;t very big but \&#39;twould buy him a good bit of\nleather, and I might tell you, \&#39;twas all brogues that was worn at the\ntime, and faith, you should be big before you would get them same. \n&lt;p&gt;\nHowisever, he started one day for Limerick would [with] and ass and car,\nto bring home leather and other little things he wanted. He did not return\nthat night or the next, nor the next. Begor, the wife and some frinds went\nto Limerick next day, but no trace of the husband could be found. I forgot\nto tell you that the third morning after he was gone the wife rose very\nearly, and there at the dure [door] was the ass and car. The whole country\nwas searched, up high and low down, but no trace. Weeks, monts and years\ncame and went, but he never turned up.\n&lt;p&gt;\nNow the wife kept on a little business, sellin\&#39; nick-nacks to support\nherself, and a son, that grew to be a fine strapping man, as I hear um\nsay, the picture of his father.\n&lt;p&gt;\nNow, sir, the boy was in or about twenty, when one day, himself and his\nmother were atin\&#39; their dinner, whin in comes a man and says, &quot;God save\nye!&quot;\n&lt;p&gt;\n&quot;And you too,&quot; says the mother. &quot;Will you ate a spud, sir?&quot; says she.\n&lt;p&gt;\nHe rached for the spud, and in doin\&#39; so the sleeve of his coat shortned as\nhe reached out his hand. He had a mole on his wrist and she see it, and\nher husband had one in the same spot.\n&lt;p&gt;\n&quot;Good God!&quot; says she, &quot;are you John M\&#39;Namara?&quot; -- for that was his name.\n&lt;p&gt;\n&quot;I am,&quot; says he, &quot;and your husband, and that\&#39;s my son, but I can\&#39;t tell\nyou for some time where I was since I left you. But some time I might have\nthe power, but not now.&quot;\n&lt;p&gt;\nWell, lo and behold you, in a week\&#39;s time he started to work, and the\nboots he made were a surprise to the whole country round, and I believe he\nlived for nine or ten years ater that, but he never tould her or any one\nwhere he was, but of course everbody knew that \&#39;twas wood [with] the good\npeople. &lt;p&gt;\n&#39;,
  &#39;\n&lt;ul&gt;\n&lt;li&gt;Source: &quot;Folk-Tales from County Limerick collected by Miss D. Knox,&quot;\n&lt;a target=&quot;_blank&quot; href=&quot;https://archive.org/stream/folklore28folkuoft#page/n4/mode/1up&quot;&gt;&lt;i&gt;Folk-Lore: A Quarterly Review of Myth, Tradition, Institution, &amp;amp;\nCustom&lt;/i&gt;&lt;/a&gt; (London: Folk-Lore Society, 1917), v. 28, &lt;a target=&quot;_blank&quot; href=&quot;https://archive.org/stream/folklore28folkuoft#page/214/mode/2up&quot;&gt;pp. 215-216&lt;/a&gt;.&lt;p&gt;\n&lt;li&gt;Knox\&#39;s source: Told by John Kelly, Cooraclare?, County Clare.&lt;p&gt;\n&lt;li&gt;I have retained Knox\&#39;s spelling.&lt;p&gt;\n&lt;li&gt;Return to the &lt;a href=&quot;#contents&quot;&gt;table of contents&lt;/a&gt;. &lt;p&gt;\n&lt;/p&gt;&lt;/li&gt;&lt;/p&gt;&lt;/li&gt;&lt;/p&gt;&lt;/li&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;\n&#39;)]
</pre></div>
</div>
</div>
</div>
<p>We can now start to parse the separate chunks of story. For example, the title appears in an <code class="docutils literal notranslate"><span class="pre">&lt;h2&gt;</span></code> element:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">story_chunk_tuples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][:</span><span class="mi">500</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\n&lt;h2&gt;&lt;a name=&quot;brosnan&quot;&gt;Taken by the Good People&lt;/a&gt;&lt;/h2&gt;\n&lt;h3&gt;Ireland&lt;/h3&gt;\nI was serving my time to the cattle trade, with a man the name of Lynch --\nGod be good to him! I suppose I was no more than twelve years of age at\nthe time. \&#39;Twas a very out of the way place and mountainy. \n&lt;p&gt;\nWell, not far from my master\&#39;s house there was a family of the Brogans.\n\&#39;Twas the will of God that Mrs. Brogan took sick, and there was a baby\nborn, but the poor woman died. Well, the sister, a younger girl than the&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">requests_html</span> <span class="kn">import</span> <span class="n">HTML</span>

<span class="n">example_story_html</span> <span class="o">=</span> <span class="n">HTML</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="n">story_chunk_tuples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">example_story_html</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;h2&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Taken by the Good People&#39;
</pre></div>
</div>
</div>
</div>
<p>There is sometimes a subtitle in an <code class="docutils literal notranslate"><span class="pre">&lt;h3&gt;</span></code> element:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">example_subheading</span> <span class="o">=</span> <span class="n">example_story_html</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;h3&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">example_subheading</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">example_subheading</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ireland
</pre></div>
</div>
</div>
</div>
<p>We have access to the full story text:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">example_story_html</span><span class="o">.</span><span class="n">full_text</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Taken by the Good People\nIreland\nI was serving my time to the cattle trade, with a man the name of Lynch --\nGod be good to him! I suppose I was no more than twelve years of age at\nthe time. \&#39;Twas a very out of the way place and mountainy. \n\nWell, not far from my master\&#39;s house there was a family of the Brogans.\n\&#39;Twas the will of God that Mrs. Brogan took sick, and there was a baby\nborn, but the poor woman died. Well, the sister, a younger girl than the\nwoman that died, came to nurse the child. After some time she began to\nlook very delicate and uneasy. The naghbours were beginning to talk amongs\nthemselves about her, and it came to Brogan\&#39;s ears, and, begor, it made\nhim vexed. So he asked the sister what was up with her.\n\n&quot;Well, John,&quot; says she, &quot;I did not like to tell you, but Ellie&quot; -- that\nwas the name of the dead woman -- &quot;comes every night, and takes the baby\nand nurses it, and goes away without a word.&quot;\n\n&quot;By my word,&quot; says John, &quot;she is not dead at all, but taken, and I will\nwatch her to-night.&quot;\n\nGood enough, he remained up, and about 12 o\&#39;clock in she came, and he put\nhis arms around her, but as he said, felt no substance.\n\n&quot;You can\&#39;t keep me now,&quot; says she, &quot;for I\&#39;m married agin; but if you come\nto the Bottle Hill field to-morrow night, there will be about 40 of us\ngoin\&#39; t\&#39;words Blarney, and we will all be on horses, with our husbands.\nAll the horses will be white, and I and my man will be last. Bring a hazel\nstick woud [with] you and strike the horse on the right side, and I will\nfall off. Just as I fall, ketch me with all your might. You will know my\nman, for he is the only one of them that has a red head.&quot;\n\nWell, he went, and he must have a great heart, for on they come, gallopin\&#39;\nlike mad. Just as the man with the red head\&#39;s horse came he stood one-side\nand struck. She fell and he gripped her like iron. Well, such a hullabaloo\nas there was, was never heard, and all the other men makin\&#39; game of the\nred-headed man.\n\nWell, he brought her home, and they lived for years after, and had a good\nfamily, and were the happiest people around the place. I often see some of\nher children; of course they are all married now, and gone here and there,\nbut that\&#39;s as true as my name is Tim Brosnan.  \n&#39;
</pre></div>
</div>
</div>
</div>
<p>If the original HTML included “useful” HTML tags, these would be stripped out in the <code class="docutils literal notranslate"><span class="pre">full_text</span></code>,, so instead it might be useful to parse the story and additional information HTML as markdown (a simple structured text format).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">story_chunk_tuples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\n&lt;h2&gt;&lt;a name=&quot;brosnan&quot;&gt;Taken by the Good People&lt;/a&gt;&lt;/h2&gt;\n&lt;h3&gt;Ireland&lt;/h3&gt;\nI was serving my time to the cattle trade, with a man the name of Lynch --\nGod be good to him! I suppose I was no more than twelve years of age at\nthe time. \&#39;Twas a very out of the way place and mountainy. \n&lt;p&gt;\nWell, not far from my master\&#39;s house there was a family of the Brogans.\n\&#39;Twas the will of God that Mrs. Brogan took sick, and there was a baby\nborn, but the poor woman died. Well, the sister, a younger girl than the\nwoman that died, came to nurse the child. After some time she began to\nlook very delicate and uneasy. The naghbours were beginning to talk amongs\nthemselves about her, and it came to Brogan\&#39;s ears, and, begor, it made\nhim vexed. So he asked the sister what was up with her.\n&lt;p&gt;\n&quot;Well, John,&quot; says she, &quot;I did not like to tell you, but Ellie&quot; -- that\nwas the name of the dead woman -- &quot;comes every night, and takes the baby\nand nurses it, and goes away without a word.&quot;\n&lt;p&gt;\n&quot;By my word,&quot; says John, &quot;she is not dead at all, but taken, and I will\nwatch her to-night.&quot;\n&lt;p&gt;\nGood enough, he remained up, and about 12 o\&#39;clock in she came, and he put\nhis arms around her, but as he said, felt no substance.\n&lt;p&gt;\n&quot;You can\&#39;t keep me now,&quot; says she, &quot;for I\&#39;m married agin; but if you come\nto the Bottle Hill field to-morrow night, there will be about 40 of us\ngoin\&#39; t\&#39;words Blarney, and we will all be on horses, with our husbands.\nAll the horses will be white, and I and my man will be last. Bring a hazel\nstick woud [with] you and strike the horse on the right side, and I will\nfall off. Just as I fall, ketch me with all your might. You will know my\nman, for he is the only one of them that has a red head.&quot;\n&lt;p&gt;\nWell, he went, and he must have a great heart, for on they come, gallopin\&#39;\nlike mad. Just as the man with the red head\&#39;s horse came he stood one-side\nand struck. She fell and he gripped her like iron. Well, such a hullabaloo\nas there was, was never heard, and all the other men makin\&#39; game of the\nred-headed man.\n&lt;p&gt;\nWell, he brought her home, and they lived for years after, and had a good\nfamily, and were the happiest people around the place. I often see some of\nher children; of course they are all married now, and gone here and there,\nbut that\&#39;s as true as my name is Tim Brosnan.  &lt;p&gt;\n&#39;
</pre></div>
</div>
</div>
</div>
<p>The following function will attempt to repair any broken HTML before we pass it to <code class="docutils literal notranslate"><span class="pre">markdownify</span></code>. There are probably better ways of doing this!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#%pip install --upgrade parse # Tools to support &quot;fromat&quot; style parsing</span>
<span class="c1">#%pip install --upgrade markdownify # Tools to convert HTML to markdown</span>

<span class="kn">from</span> <span class="nn">parse</span> <span class="kn">import</span> <span class="n">parse</span>

<span class="kn">import</span> <span class="nn">html5lib</span>
<span class="kn">import</span> <span class="nn">lxml</span>

<span class="kn">import</span> <span class="nn">markdownify</span>

<span class="k">def</span> <span class="nf">repair_HTML</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Repair HTML.&quot;&quot;&quot;</span>
    <span class="c1"># html5bib repairs the broken HTML</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">html5lib</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">treebuilder</span><span class="o">=</span><span class="s1">&#39;lxml&#39;</span><span class="p">,</span> <span class="n">namespaceHTMLElements</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">html_</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&lt;body&gt;</span><span class="si">{html}</span><span class="s2">&lt;/body&gt;&quot;</span><span class="p">,</span> <span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">html_</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">html_</span><span class="p">[</span><span class="s1">&#39;html&#39;</span><span class="p">],</span> <span class="n">tree</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span>


<span class="p">(</span><span class="n">_html</span><span class="p">,</span> <span class="n">_tree</span><span class="p">)</span> <span class="o">=</span> <span class="n">repair_HTML</span><span class="p">(</span><span class="n">story_chunk_tuples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

<span class="n">md</span> <span class="o">=</span> <span class="n">markdownify</span><span class="o">.</span><span class="n">markdownify</span><span class="p">(</span><span class="n">_html</span><span class="p">,</span> <span class="n">bullets</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">md</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Taken by the Good People\n------------------------\n\n\n### Ireland\n\n\nI was serving my time to the cattle trade, with a man the name of Lynch --\nGod be good to him! I suppose I was no more than twelve years of age at\nthe time. \&#39;Twas a very out of the way place and mountainy. \n\nWell, not far from my master\&#39;s house there was a family of the Brogans.\n\&#39;Twas the will of God that Mrs. Brogan took sick, and there was a baby\nborn, but the poor woman died. Well, the sister, a younger girl than the\nwoman that died, came to nurse the child. After some time she began to\nlook very delicate and uneasy. The naghbours were beginning to talk amongs\nthemselves about her, and it came to Brogan\&#39;s ears, and, begor, it made\nhim vexed. So he asked the sister what was up with her.\n\n\n\n&quot;Well, John,&quot; says she, &quot;I did not like to tell you, but Ellie&quot; -- that\nwas the name of the dead woman -- &quot;comes every night, and takes the baby\nand nurses it, and goes away without a word.&quot;\n\n\n\n&quot;By my word,&quot; says John, &quot;she is not dead at all, but taken, and I will\nwatch her to-night.&quot;\n\n\n\nGood enough, he remained up, and about 12 o\&#39;clock in she came, and he put\nhis arms around her, but as he said, felt no substance.\n\n\n\n&quot;You can\&#39;t keep me now,&quot; says she, &quot;for I\&#39;m married agin; but if you come\nto the Bottle Hill field to-morrow night, there will be about 40 of us\ngoin\&#39; t\&#39;words Blarney, and we will all be on horses, with our husbands.\nAll the horses will be white, and I and my man will be last. Bring a hazel\nstick woud [with] you and strike the horse on the right side, and I will\nfall off. Just as I fall, ketch me with all your might. You will know my\nman, for he is the only one of them that has a red head.&quot;\n\n\n\nWell, he went, and he must have a great heart, for on they come, gallopin\&#39;\nlike mad. Just as the man with the red head\&#39;s horse came he stood one-side\nand struck. She fell and he gripped her like iron. Well, such a hullabaloo\nas there was, was never heard, and all the other men makin\&#39; game of the\nred-headed man.\n\n\n\nWell, he brought her home, and they lived for years after, and had a good\nfamily, and were the happiest people around the place. I often see some of\nher children; of course they are all married now, and gone here and there,\nbut that\&#39;s as true as my name is Tim Brosnan.&#39;
</pre></div>
</div>
</div>
</div>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">IPython.display.Markdown</span></code> function to preview the formatted story:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Markdown</span>

<span class="n">Markdown</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p class="rubric">Taken by the Good People</p>
<p class="rubric">Ireland</p>
<p>I was serving my time to the cattle trade, with a man the name of Lynch –
God be good to him! I suppose I was no more than twelve years of age at
the time. ‘Twas a very out of the way place and mountainy.</p>
<p>Well, not far from my master’s house there was a family of the Brogans.
‘Twas the will of God that Mrs. Brogan took sick, and there was a baby
born, but the poor woman died. Well, the sister, a younger girl than the
woman that died, came to nurse the child. After some time she began to
look very delicate and uneasy. The naghbours were beginning to talk amongs
themselves about her, and it came to Brogan’s ears, and, begor, it made
him vexed. So he asked the sister what was up with her.</p>
<p>“Well, John,” says she, “I did not like to tell you, but Ellie” – that
was the name of the dead woman – “comes every night, and takes the baby
and nurses it, and goes away without a word.”</p>
<p>“By my word,” says John, “she is not dead at all, but taken, and I will
watch her to-night.”</p>
<p>Good enough, he remained up, and about 12 o’clock in she came, and he put
his arms around her, but as he said, felt no substance.</p>
<p>“You can’t keep me now,” says she, “for I’m married agin; but if you come
to the Bottle Hill field to-morrow night, there will be about 40 of us
goin’ t’words Blarney, and we will all be on horses, with our husbands.
All the horses will be white, and I and my man will be last. Bring a hazel
stick woud [with] you and strike the horse on the right side, and I will
fall off. Just as I fall, ketch me with all your might. You will know my
man, for he is the only one of them that has a red head.”</p>
<p>Well, he went, and he must have a great heart, for on they come, gallopin’
like mad. Just as the man with the red head’s horse came he stood one-side
and struck. She fell and he gripped her like iron. Well, such a hullabaloo
as there was, was never heard, and all the other men makin’ game of the
red-headed man.</p>
<p>Well, he brought her home, and they lived for years after, and had a good
family, and were the happiest people around the place. I often see some of
her children; of course they are all married now, and gone here and there,
but that’s as true as my name is Tim Brosnan.</p>
</div>
</div>
<p>If we look at the additional information, we see that it contains a list of items, which may contain links. The final list item is boilerplate and we can remove it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">story_chunk_tuples</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\n&lt;ul&gt;\n&lt;li&gt;Source (books.google.com): William Butler Yeats, &lt;i&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://books.google.com/books?id=AhZLAAAAMAAJ&amp;amp;pg=PP13#v=onepage&amp;amp;q&amp;amp;f=false&quot;&gt;The Celtic Twilight&lt;/a&gt;&lt;/i&gt; (London: A. H. Bullen, 1902), &lt;a target=&quot;_blank&quot; href=&quot;https://books.google.com/books?id=AhZLAAAAMAAJ&amp;amp;pg=PA117#v=onepage&amp;amp;q&amp;amp;f=false&quot;&gt;pp. 117-29&lt;/a&gt;. &lt;p&gt;\n&lt;li&gt;Source (Internet Archive): William Butler Yeats, &lt;i&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://archive.org/details/celtictwilight00yeatrich&quot;&gt;The Celtic Twilight&lt;/a&gt;&lt;/i&gt; (London: A. H. Bullen, 1902), &lt;a target=&quot;_blank&quot; href=&quot;xxx&quot;&gt;pp. 117-29&lt;/a&gt;. &lt;p&gt;\n&lt;li&gt;Return to the &lt;a href=&quot;#contents&quot;&gt;table of contents&lt;/a&gt;. &lt;p&gt;\n&lt;/p&gt;&lt;/li&gt;&lt;/p&gt;&lt;/li&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;\n&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">additional_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">li</span><span class="o">.</span><span class="n">html</span> <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">HTML</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="n">story_chunk_tuples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">additional_info</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;li&gt;Source (Internet Archive): &quot;Folk-Tales from County Limerick collected by Miss D. Knox,&quot;\n&lt;a target=&quot;_blank&quot; href=&quot;https://archive.org/stream/folklore28folkuoft#page/n4/mode/1up&quot;&gt;&lt;i&gt;Folk-Lore: A Quarterly Review of Myth, Tradition, Institution, &amp;amp;\nCustom&lt;/i&gt;&lt;/a&gt; (London: Folk-Lore Society, 1917), v. 28, &lt;a target=&quot;_blank&quot; href=&quot;https://archive.org/stream/folklore28folkuoft#page/218/mode/2up&quot;&gt;pp. 218-219&lt;/a&gt;.&lt;p&gt;\n&lt;li&gt;Knox\&#39;s source: Told by Tim Brosnan, Dungeagan, County Kerry.&lt;p&gt;\n&lt;li&gt;I have retained Knox\&#39;s spelling.&lt;p&gt;\n&lt;li&gt;Return to the &lt;a href=&quot;#contents&quot;&gt;table of contents&lt;/a&gt;.\n&lt;/li&gt;&lt;/p&gt;&lt;/li&gt;&lt;/p&gt;&lt;/li&gt;&lt;/p&gt;&lt;/li&gt;&#39;,
 &#39;&lt;li&gt;Knox\&#39;s source: Told by Tim Brosnan, Dungeagan, County Kerry.&lt;p&gt;\n&lt;li&gt;I have retained Knox\&#39;s spelling.&lt;p&gt;\n&lt;li&gt;Return to the &lt;a href=&quot;#contents&quot;&gt;table of contents&lt;/a&gt;.\n&lt;/li&gt;&lt;/p&gt;&lt;/li&gt;&lt;/p&gt;&lt;/li&gt;&#39;,
 &#39;&lt;li&gt;I have retained Knox\&#39;s spelling.&lt;p&gt;\n&lt;li&gt;Return to the &lt;a href=&quot;#contents&quot;&gt;table of contents&lt;/a&gt;.\n&lt;/li&gt;&lt;/p&gt;&lt;/li&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<p>In some records, the Aarne-Thompson-Uther type is given, which we can easily parse out if it is presented in a regular form:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Aarne-Thompson-Uther type 1586.</span>

<span class="c1"># Requires exact match</span>
<span class="n">parse</span><span class="p">(</span><span class="s2">&quot;Aarne-Thompson-Uther type </span><span class="si">{atu}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="s2">&quot;Aarne-Thompson-Uther type 1586.&quot;</span><span class="p">)</span>
<span class="c1"># Accepts arbitrary but required prefix</span>
<span class="n">parse</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">Aarne-Thompson-Uther type </span><span class="si">{atu}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="s2">&quot;Similar to Aarne-Thompson-Uther type 1586.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Result (&#39;Similar to &#39;,) {&#39;atu&#39;: &#39;1586&#39;}&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="create-a-simple-database">
<h2>Create a Simple Database<a class="headerlink" href="#create-a-simple-database" title="Permalink to this headline">#</a></h2>
<p>We can create a simple database structure to hold the stories.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils</span> <span class="kn">import</span> <span class="n">Database</span>

<span class="n">db_name</span> <span class="o">=</span> <span class="s2">&quot;ashliman_demo.db&quot;</span>

<span class="c1"># While developing the script, recreate database each time...</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">recreate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s start off with a table for the stories. This should include:</p>
<ul class="simple">
<li><p>story title;</p></li>
<li><p>story text;</p></li>
<li><p>story metadata.</p></li>
</ul>
<p>There may also be optional subheading information.</p>
<p>From the page, we will also be able to get the general tale type. We may also be able to get the ATU tale type, either from the page, or from the story record. We can include these in our table definition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ashliman_stories&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_where</span><span class="p">()</span>
<span class="n">db</span><span class="p">[</span><span class="s2">&quot;ashliman_stories&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;subheading&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;generic_type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;generic_info&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;atu&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="c1"># This may be null</span>
    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">})</span>

<span class="c1"># Create a full text search table to improve search support</span>
<span class="n">db</span><span class="p">[</span><span class="s2">&quot;ashliman_stories&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">enable_fts</span><span class="p">([</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">create_triggers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="s2">&quot;porter&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Table ashliman_stories (title, subheading, text, metadata, generic_type, generic_info, atu, url)&gt;
</pre></div>
</div>
</div>
</div>
<p>Let’s see if we can add create an example set of records from a single page and add it to the database:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fetch_and_parse_page</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">exceptions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch and parse Ashliman story pages.&quot;&quot;&quot;</span>
    
    <span class="n">page_response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    
    <span class="n">atu_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^.*Aarne-Thompson-Uther type (?P&lt;atu&gt;[\da-zA-Z]+).*&quot;</span>
    
    <span class="n">story_records</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">atu</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">generic_type</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    
    <span class="c1"># Low hanging fruit: ATU in URL</span>
    <span class="n">url_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^type(?P&lt;atu&gt;[\da-zA-Z]+)\.html&quot;</span>
    <span class="n">_url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">matches</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">url_regex</span><span class="p">,</span> <span class="n">_url</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">atu</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;atu&quot;</span><span class="p">)</span>
    <span class="c1"># Low hanging fruit - atu in text</span>
    <span class="n">generic_info</span> <span class="o">=</span> <span class="n">page_response</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//p[@align=&quot;CENTER&quot;]&#39;</span><span class="p">)</span>
    <span class="n">generic_info</span> <span class="o">=</span> <span class="n">generic_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">generic_info</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="c1"># Check to see if we can find an ATU; if we do, this overrides the page atu</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">atu_regex</span><span class="p">,</span> <span class="n">generic_info</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">atu</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;atu&quot;</span><span class="p">)</span>
    
    <span class="c1"># The generic type is the page title</span>
    <span class="c1"># Get the head information</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">page_response</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">header</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">page_response</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//h1[@align=&quot;CENTER&quot;]&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">full_text</span>
        <span class="n">generic_type</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="c1"># See if an ATU is defined in the header</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">atu_regex</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">atu</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;atu&quot;</span><span class="p">)</span>

    <span class="c1"># Now find stories</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">page_response</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">html</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">page_response</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">html</span>
        <span class="c1"># This pages are old so patch them</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;hr&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;hr/&gt;&quot;</span><span class="p">)</span>
        
    <span class="c1"># Split out the section containing the stories</span>
    <span class="n">story_section</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&lt;hr/&gt;</span><span class="se">\n</span><span class="s2">&lt;p&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">exceptions</span> <span class="ow">and</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">exceptions</span><span class="p">[</span><span class="n">url</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">story_section</span><span class="si">}{</span><span class="n">exceptions</span><span class="p">[</span><span class="n">url</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">stories_html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">story_section</span><span class="p">)</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stories_html</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">stories_html</span> <span class="o">=</span> <span class="n">stories_html</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>

    <span class="c1"># Chunk the stories</span>
    <span class="n">story_chunks</span> <span class="o">=</span> <span class="n">stories_html</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;hr/&gt;&lt;hr/&gt;&quot;</span><span class="p">)</span>
    <span class="c1"># Some old pages may not have the non-story boilerplate at the end</span>
    <span class="n">story_chunks</span> <span class="o">=</span> <span class="n">story_chunks</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">story_chunks</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">story_chunks</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Now iterate through all the stories</span>
    <span class="k">for</span> <span class="n">story_chunk</span> <span class="ow">in</span> <span class="n">story_chunks</span><span class="p">:</span>
        <span class="n">record</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;generic_type&#39;</span><span class="p">:</span> <span class="n">generic_type</span><span class="p">,</span>
                  <span class="s1">&#39;generic_info&#39;</span><span class="p">:</span> <span class="n">generic_info</span><span class="p">,</span>
                  <span class="s1">&#39;atu&#39;</span><span class="p">:</span><span class="n">atu</span><span class="p">,</span>
                  <span class="s1">&#39;metadata&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">url</span><span class="p">}</span>
        
        <span class="n">story_chunk_items</span> <span class="o">=</span> <span class="n">story_chunk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;hr/&gt;&#39;</span><span class="p">)</span>
    
    
    
        <span class="c1"># Trap any broken html...</span>
        <span class="c1">#try:</span>
        <span class="c1">#    story_html = HTML(html=story_chunk_items[0])</span>
        <span class="c1">#except:</span>
        <span class="c1">#    pass</span>
        <span class="c1">#record[&#39;text&#39;] = story_html.full_text.strip()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">_html</span><span class="p">,</span> <span class="n">story_tree</span><span class="p">)</span> <span class="o">=</span> <span class="n">repair_HTML</span><span class="p">(</span><span class="n">story_chunk_items</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">record</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">markdownify</span><span class="o">.</span><span class="n">markdownify</span><span class="p">(</span><span class="n">_html</span><span class="p">,</span> <span class="n">bullets</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1">#record[&#39;html&#39;] = _html</span>
            <span class="n">story_tree</span> <span class="o">=</span> <span class="n">HTML</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="n">_html</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            
        
        <span class="c1"># If there is no story text, move on</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]:</span>
            <span class="k">continue</span>
        
        <span class="c1"># Get title</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">story_tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;h2&#39;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">title</span> <span class="k">else</span> <span class="n">generic_type</span>
        <span class="c1"># If we have not dropped the contents section, and we can identify it, move on...</span>
        <span class="k">if</span> <span class="n">title</span><span class="o">==</span><span class="s1">&#39;Contents&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="n">record</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
        
        <span class="c1"># Get optional subheading</span>
        <span class="n">subheading</span> <span class="o">=</span> <span class="n">story_tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;h3&#39;</span><span class="p">)</span>
        <span class="n">subheading</span> <span class="o">=</span> <span class="n">subheading</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">subheading</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        
        <span class="n">record</span><span class="p">[</span><span class="s1">&#39;subheading&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subheading</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">story_chunk_items</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="p">(</span><span class="n">_html</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">repair_HTML</span><span class="p">(</span><span class="n">story_chunk_items</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">markdownify</span><span class="o">.</span><span class="n">markdownify</span><span class="p">(</span><span class="n">_html</span><span class="p">,</span> <span class="n">bullets</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># Cleaning, added as and when I spot it&#39;s necessary</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;- Return to the [table of contents](#contents).&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">record</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># Check to see if we can find an ATU; if we do, this overrides the page atu</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">atu_regex</span><span class="p">,</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">record</span><span class="p">[</span><span class="s1">&#39;atu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;atu&quot;</span><span class="p">)</span>
        
        <span class="c1"># Depending on the layout, we may get what is essentially a null record</span>
        <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;folktexts&#39;</span> <span class="ow">and</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">!=</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Return to D. L. Ashliman&quot;</span><span class="p">):</span>
            <span class="n">story_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">story_records</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s try that function out:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is a hack fix - some pages don&#39;t have the conventional split string</span>
<span class="n">exceptions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;https://sites.pitt.edu/~dash/hildebrand.html&quot;</span><span class="p">:</span> <span class="s2">&quot;I have heard tell&quot;</span><span class="p">,</span>
              <span class="s2">&quot;https://sites.pitt.edu/~dash/bluebelt.html&quot;</span><span class="p">:</span> <span class="s2">&quot;Once upon a time&quot;</span><span class="p">,</span>
              <span class="s2">&quot;https://sites.pitt.edu/~dash/lowell.html&quot;</span><span class="p">:</span> <span class="s2">&quot;I had a little daughter&quot;</span><span class="p">,</span>
              <span class="s2">&quot;https://sites.pitt.edu/~dash/changeling.html&quot;</span><span class="p">:</span> <span class="s1">&#39;&lt;h2&gt;&lt;a name=&quot;legends&quot;&gt;The legends &lt;/a&gt;&lt;/h2&gt;&#39;</span><span class="p">}</span>
    
<span class="n">example_records</span> <span class="o">=</span> <span class="n">fetch_and_parse_page</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exceptions</span><span class="p">)</span>
<span class="n">example_records</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;generic_type&#39;: &quot;Old Folks in Aesop&#39;s Fables&quot;,
  &#39;generic_info&#39;: &#39;&#39;,
  &#39;atu&#39;: &#39;&#39;,
  &#39;metadata&#39;: &#39;&#39;,
  &#39;url&#39;: &#39;https://sites.pitt.edu/~dash/aesopold.html&#39;,
  &#39;text&#39;: &quot;- Sources:\n\t- Fables 1-18: *Aesop&#39;s Fables*. Translated by V. S. Vernon Jones. \n\tLondon: Heinemann, 1912.\n\t- Fables 19-20: *The Fables of Aesop*. Edited by Joseph Jacobs. \n\tLondon and New York: Macmillan, 1894.\n\t- Fables 21-28: *The Fables of Aesop*. Based on the texts of \n\tL&#39;Estrange and Croxall. New York and Boston: \n\t\n\tBooks, Inc., n.d.\n- Return to D. L. Ashliman&#39;s [**folktexts**](folktexts.html), a library of folktales, folklore, \nfairy tales, and mythology.&quot;,
  &#39;title&#39;: &quot;Old Folks in Aesop&#39;s Fables&quot;,
  &#39;subheading&#39;: &#39;&#39;},
 {&#39;generic_type&#39;: &quot;Old Folks in Aesop&#39;s Fables&quot;,
  &#39;generic_info&#39;: &#39;&#39;,
  &#39;atu&#39;: &#39;&#39;,
  &#39;metadata&#39;: &#39;&#39;,
  &#39;url&#39;: &#39;https://sites.pitt.edu/~dash/aesopold.html&#39;,
  &#39;text&#39;: &#39;The Mischievous Dog\n-------------------\n\n \nThere was once a dog who used to snap at people and bite them without any \nprovocation, and who was a great nuisance to \n\neveryone who came to his master\&#39;s house. So his master fastened a bell \nround his neck to warn people of his presence. \n\nThe dog was very proud of the bell, and strutted about tinkling it with \nimmense satisfaction. But an old dog came up \n\nto him and said, &quot;The fewer airs you give yourself the better, my friend. \nYou don\&#39;t think, do you, that your bell was \n\ngiven you as a reward of merit? On the contrary, it is a badge of \ndisgrace.&quot; \nMoral: Notoriety is often mistaken for fame.&#39;,
  &#39;title&#39;: &#39;The Mischievous Dog&#39;,
  &#39;subheading&#39;: &#39;&#39;}]
</pre></div>
</div>
</div>
</div>
<p>For the metadata, we could have a metadata table, with one or more rows per book depending on the number of metadata list items? Or is the use of lists in metadata inconsistently applied?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Markdown</span><span class="p">(</span><span class="n">example_records</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;metadata&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;IPython.core.display.Markdown object&gt;
</pre></div>
</div>
</div>
</div>
<p>We can add these to the database and have a go at querying them:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ashliman_stories&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_where</span><span class="p">()</span>
<span class="n">db</span><span class="p">[</span><span class="s2">&quot;ashliman_stories&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">(</span><span class="n">example_records</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Table ashliman_stories (title, subheading, text, metadata, generic_type, generic_info, atu, url)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">read_sql</span>

<span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM ashliman_stories LIMIT 12&quot;</span>

<span class="n">read_sql</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>subheading</th>
      <th>text</th>
      <th>metadata</th>
      <th>generic_type</th>
      <th>generic_info</th>
      <th>atu</th>
      <th>url</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Old Folks in Aesop's Fables</td>
      <td></td>
      <td>- Sources:\n\t- Fables 1-18: *Aesop's Fables*....</td>
      <td></td>
      <td>Old Folks in Aesop's Fables</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/aesopold.html</td>
    </tr>
    <tr>
      <th>1</th>
      <td>The Mischievous Dog</td>
      <td></td>
      <td>The Mischievous Dog\n-------------------\n\n \...</td>
      <td></td>
      <td>Old Folks in Aesop's Fables</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/aesopold.html</td>
    </tr>
    <tr>
      <th>2</th>
      <td>The Mice in Council</td>
      <td></td>
      <td>The Mice in Council\n-------------------\n\n \...</td>
      <td></td>
      <td>Old Folks in Aesop's Fables</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/aesopold.html</td>
    </tr>
    <tr>
      <th>3</th>
      <td>The Old Woman and the Doctor</td>
      <td></td>
      <td>The Old Woman and the Doctor\n----------------...</td>
      <td></td>
      <td>Old Folks in Aesop's Fables</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/aesopold.html</td>
    </tr>
    <tr>
      <th>4</th>
      <td>The Crab and His Mother</td>
      <td></td>
      <td>The Crab and His Mother\n---------------------...</td>
      <td></td>
      <td>Old Folks in Aesop's Fables</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/aesopold.html</td>
    </tr>
    <tr>
      <th>5</th>
      <td>The Old Lion</td>
      <td></td>
      <td>The Old Lion\n------------\n\n \nA lion, enfee...</td>
      <td></td>
      <td>Old Folks in Aesop's Fables</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/aesopold.html</td>
    </tr>
    <tr>
      <th>6</th>
      <td>The Peasant and the Apple Tree</td>
      <td></td>
      <td>The Peasant and the Apple Tree\n--------------...</td>
      <td></td>
      <td>Old Folks in Aesop's Fables</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/aesopold.html</td>
    </tr>
    <tr>
      <th>7</th>
      <td>The Mice and the Weasels</td>
      <td></td>
      <td>The Mice and the Weasels\n--------------------...</td>
      <td></td>
      <td>Old Folks in Aesop's Fables</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/aesopold.html</td>
    </tr>
    <tr>
      <th>8</th>
      <td>The Ass and the Old Peasant</td>
      <td></td>
      <td>The Ass and the Old Peasant\n-----------------...</td>
      <td></td>
      <td>Old Folks in Aesop's Fables</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/aesopold.html</td>
    </tr>
    <tr>
      <th>9</th>
      <td>The Old Woman and the Wine Jar</td>
      <td></td>
      <td>The Old Woman and the Wine Jar\n--------------...</td>
      <td></td>
      <td>Old Folks in Aesop's Fables</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/aesopold.html</td>
    </tr>
    <tr>
      <th>10</th>
      <td>The Oxen and the Butchers</td>
      <td></td>
      <td>The Oxen and the Butchers\n-------------------...</td>
      <td></td>
      <td>Old Folks in Aesop's Fables</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/aesopold.html</td>
    </tr>
    <tr>
      <th>11</th>
      <td>The Old Hound</td>
      <td></td>
      <td>The Old Hound\n-------------\n\n \nA hound who...</td>
      <td></td>
      <td>Old Folks in Aesop's Fables</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/aesopold.html</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let’s now try to populate the whole database:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># tqdm gives us a progress bar</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># Empty the database</span>
<span class="n">db</span><span class="p">[</span><span class="s2">&quot;ashliman_stories&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_where</span><span class="p">()</span>

<span class="c1"># Iterate through all the pages, adding the stories to the db as we do so</span>
<span class="n">broken_parser_pages</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Also recall that requests-cache should be cacheing pages</span>
<span class="c1"># so we should only hit the original site once per page</span>
<span class="c1"># no matter how many times we run this in testing and development</span>
<span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">links</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">records</span> <span class="o">=</span> <span class="n">fetch_and_parse_page</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
        <span class="n">db</span><span class="p">[</span><span class="s2">&quot;ashliman_stories&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">broken_parser_pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d33ff2b0f1f14bda9a77814ae5aeb149", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Are there any pages that didn’t get parsed?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">broken_parser_pages</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<p>How many stories are there?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;SELECT COUNT(*) AS num_stories FROM ashliman_stories&quot;</span>

<span class="n">read_sql</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>num_stories</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1122</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM ashliman_stories LIMIT 10&quot;</span>

<span class="n">read_sql</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>subheading</th>
      <th>text</th>
      <th>metadata</th>
      <th>generic_type</th>
      <th>generic_info</th>
      <th>atu</th>
      <th>url</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Taken by the Good People</td>
      <td>Ireland</td>
      <td>Taken by the Good People\n--------------------...</td>
      <td>- Source (Internet Archive): "Folk-Tales from ...</td>
      <td>Abducted by Aliens</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/abduct.html</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Twenty Years with the Good People</td>
      <td>Ireland</td>
      <td>Twenty Years with the Good People\n-----------...</td>
      <td>- Source: "Folk-Tales from County Limerick col...</td>
      <td>Abducted by Aliens</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/abduct.html</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Jamie Freel and the Young Lady: A Donegal Tale</td>
      <td>Ireland</td>
      <td>Jamie Freel and the Young Lady: A Donegal Tale...</td>
      <td>- Source (books.google.com): William Butler Ye...</td>
      <td>Abducted by Aliens</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/abduct.html</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Kidnappers</td>
      <td>Ireland</td>
      <td>Kidnappers\n----------\n\n\n### Ireland\n\n\nA...</td>
      <td>- Source (books.google.com): William Butler Ye...</td>
      <td>Abducted by Aliens</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/abduct.html</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Ethna the Bride</td>
      <td>Ireland</td>
      <td>Ethna the Bride\n---------------\n\n\n### Irel...</td>
      <td>- Source (books.google.com): Lady [Jane France...</td>
      <td>Abducted by Aliens</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/abduct.html</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Ned the Jockey</td>
      <td>Wales</td>
      <td>Ned the Jockey\n--------------\n\n\n### Wales\...</td>
      <td>- Source (books.google.com): Edward Hamer, "Pa...</td>
      <td>Abducted by Aliens</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/abduct.html</td>
    </tr>
    <tr>
      <th>6</th>
      <td>The Old Man and the Fairies</td>
      <td>Wales</td>
      <td>The Old Man and the Fairies\n-----------------...</td>
      <td>- Source (books.google.com): P. H. Emerson, *[...</td>
      <td>Abducted by Aliens</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/abduct.html</td>
    </tr>
    <tr>
      <th>7</th>
      <td>A Visit to Fairyland</td>
      <td>Wales</td>
      <td>A Visit to Fairyland\n--------------------\n\n...</td>
      <td>- Source (books.google.com): D. E. Jenkins, *[...</td>
      <td>Abducted by Aliens</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/abduct.html</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Four Years in Faery</td>
      <td>Isle of Man</td>
      <td>Four Years in Faery\n-------------------\n\n\n...</td>
      <td>- Source (books.google.com): John Rhys, *[Celt...</td>
      <td>Abducted by Aliens</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/abduct.html</td>
    </tr>
    <tr>
      <th>9</th>
      <td>The Lost Wife of Ballaleece</td>
      <td>Isle of Man</td>
      <td>The Lost Wife of Ballaleece\n-----------------...</td>
      <td>- Source (Internet Archive): Sophia Morrison, ...</td>
      <td>Abducted by Aliens</td>
      <td></td>
      <td></td>
      <td>https://sites.pitt.edu/~dash/abduct.html</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "psychemedia/storynotes",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="lang-fairy-books-db_PART_4.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Identifying Common Refrains / Repeating Phrases In Lang’s Fairy Story Collections</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="MFTD-Multilingual_Folk_Tale_Database.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Multilingual Folk Tale Database (MFTD)</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Tony Hirst<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>