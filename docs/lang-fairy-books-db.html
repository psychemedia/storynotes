
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>A Full Text Searchable Database of Lang’s Fairy Books &#8212; Story Notes - Technical Recipes</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Ashliman “Folklore and Mythology Electronic Texts” Scraper" href="Ashliman_folk_texts_scraper.html" />
    <link rel="prev" title="Preface" href="preface.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Story Notes - Technical Recipes</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="preface.html">
   Preface
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Story Collection Scrapers and Search
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   A Full Text Searchable Database of Lang’s Fairy Books
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ashliman_folk_texts_scraper.html">
   Ashliman “Folklore and Mythology Electronic Texts” Scraper
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="MTFD-Multilingual_Folk_Tale_Database.html">
   Multilingual Folk Tale Database (MTFD)
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Advanced Search Techniques
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Lang_Doc2Vec.html">
   Connecting to the Database
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Tale Types
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Missouri_Tale_Types.html">
   Tale Types Scraper
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Thompson_Motif_Index.html">
   Thompson Motif Index
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Wikipedia and DBPedia
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="DBPedia_Aarne-Thompson-Uther_Search.html">
   Aarne-Thompson-Uther (ATU) Search
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/lang-fairy-books-db.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#obtain-source-texts">
   Obtain Source Texts
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#extract-stories">
   Extract Stories
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#extract-the-contents">
   Extract the contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pulling-the-parser-together">
   Pulling the Parser Together
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-simple-database-structure">
   Create Simple Database Structure
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#build-database">
   Build Database
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#making-pandas-based-database-queries">
   Making
   <em>
    pandas
   </em>
   based Database Queries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#entity-extraction">
   Entity Extraction…
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#add-wikipedia-links">
   Add Wikipedia Links
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#common-refrains-repeating-phrases">
   Common Refrains / Repeating Phrases
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#doc2vec-search-engine">
   Doc2Vec Search Engine
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="a-full-text-searchable-database-of-lang-s-fairy-books">
<h1>A Full Text Searchable Database of Lang’s Fairy Books<a class="headerlink" href="#a-full-text-searchable-database-of-lang-s-fairy-books" title="Permalink to this headline">¶</a></h1>
<p>In the late 19th and early 20th century, Andrew Lang published various collections of fairy tales, starting with <em>The Blue Fairy Book</em> and then progressing though various other colours to <em>The Olive Fairy Book</em>.</p>
<p>This notebook represents a playful aside in trying to build various searchable contexts over the stories.</p>
<p>To begin with, let’s start by ingesting the stories into a database and building a full text search over them…</p>
<div class="section" id="obtain-source-texts">
<h2>Obtain Source Texts<a class="headerlink" href="#obtain-source-texts" title="Permalink to this headline">¶</a></h2>
<p>We can download the raw text for each of Lang’s coloured Fairy Books from the Sacred Texts website:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://www.sacred-texts.com/neu/lfb/index.htm&quot;</span>
<span class="n">html</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="n">html</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;&lt;HTML&gt;\r\n&lt;HEAD&gt;\r\n&lt;link rel=&quot;stylesheet&quot; href=&quot;../../css/ista.css&quot;&gt;&lt;META HTTP-EQUIV=&quot;Content-Type&quot; CONTENT=&quot;text/html; charset=UTF-8&quot;&gt;\r\n&lt;link rel=&quot;alternate&quot; type=&quot;application/rss+xml&quot; title=&quot;RSS&quot; href=&quot;http://sacred-texts.com/rss/new.xml&quot;&gt;\r\n\r\n&lt;META name=&quot;description&quot;\r\ncontent=&quot;Sacred Texts: Lang Fairy Books&quot;&gt;\r\n&lt;META name=&quot;keywords&quot;\r\ncontent=&quot;Colored Fairy Books Fairy Tales Tale Folklore Folk lore Children Literature&quot;&gt;\r\n&lt;TITLE&gt;Sacred-Texts: Lang Fairy Books&lt;/TITLE&gt;&lt;/HEAD&gt;\r\n&lt;BODY&gt;\r\n&lt;table width=&quot;800&quot; border=&quot;0&quot; align=&quot;center&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;&lt;tr&gt; \r\n&lt;td height=&quot;131&quot; width=&quot;200&quot; align=&quot;left&quot; valign=&quot;top&quot;&gt; \r\n&lt;div align=&quot;left&quot;&gt;&lt;a href=&quot;../../cdshop/index.htm&quot;&gt;&lt;img src=&quot;../../img/cdad.gif&quot; width=&quot;206&quot; height=&quot;136&quot; border=&quot;0&quot;&gt;&lt;/a&gt;&lt;/div&gt;\r\n&lt;/td&gt;\r\n&lt;td height=&quot;131&quot; width=&quot;600&quot; colspan=&quot;3&quot;&gt;&lt;div align=&quot;left&quot;&gt;&lt;img src=&quot;../../img/menu.jpg&quot; width=&quot;600&quot; height=&quot;134&quot; usemap=&quot;#Map&quot; border=&quot;0&quot;&gt;&lt;map name=&quot;Map&quot;&gt;&lt;area shape=&quot;rect&quot; coords=&quot;33,5,552,78&quot; href=&quot;../../index.htm&quot; alt=&quot;sacred-texts.co&#39;
</pre></div>
</div>
</div>
</div>
<p>By inspection of the HTML, we see the books are in <code class="docutils literal notranslate"><span class="pre">span</span></code> tag with a <code class="docutils literal notranslate"><span class="pre">ista-content</span></code> class. Digging further, we then notice the links are in <code class="docutils literal notranslate"><span class="pre">c_t</span></code> classed <code class="docutils literal notranslate"><span class="pre">span</span></code> elements. We can extract them using beautiful soup:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

<span class="c1"># Find the spans containing the links</span>
<span class="n">items_</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;ista-content&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;c_t&quot;</span><span class="p">)</span>

<span class="c1"># And then reduce those to just the links</span>
<span class="n">items_</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items_</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We can then extract the relative links and generate full links for each book page:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">base_url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;index.htm&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="n">links</span> <span class="o">=</span> <span class="p">[(</span><span class="n">link</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}{</span><span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">items_</span><span class="p">]</span>
<span class="n">links</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;The Blue Fairy Book&#39;, &#39;https://www.sacred-texts.com/neu/lfb/bl/index.htm&#39;),
 (&#39;The Brown Fairy Book&#39;, &#39;https://www.sacred-texts.com/neu/lfb/br/index.htm&#39;),
 (&#39;The Crimson Fairy Book&#39;,
  &#39;https://www.sacred-texts.com/neu/lfb/cr/index.htm&#39;)]
</pre></div>
</div>
</div>
</div>
<p>We can also grab the years:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">years_</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;ista-content&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;c_d&quot;</span><span class="p">)</span>
<span class="n">years</span> <span class="o">=</span> <span class="p">[</span><span class="n">year</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years_</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>And merge those in to a metadata record collection:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sacred_metadata</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">years</span><span class="p">))</span>
<span class="n">sacred_metadata</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[((&#39;The Blue Fairy Book&#39;, &#39;https://www.sacred-texts.com/neu/lfb/bl/index.htm&#39;),
  &#39;1889&#39;),
 ((&#39;The Brown Fairy Book&#39;,
   &#39;https://www.sacred-texts.com/neu/lfb/br/index.htm&#39;),
  &#39;1904&#39;),
 ((&#39;The Crimson Fairy Book&#39;,
   &#39;https://www.sacred-texts.com/neu/lfb/cr/index.htm&#39;),
  &#39;1903&#39;)]
</pre></div>
</div>
</div>
</div>
<p>We could now load each of those pages and then scrape the download link. But, we notice that the download links have a regular pattern: <code class="docutils literal notranslate"><span class="pre">https://www.sacred-texts.com/neu/lfb/bl/blfb.txt.gz</span></code> which we can derive from the book pages:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download_links</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="p">(</span><span class="n">_title</span><span class="p">,</span> <span class="n">_url</span><span class="p">)</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
    <span class="c1"># We need to get the &quot;short&quot; colour name of the book</span>
    <span class="c1"># which can be found in the URL path...</span>
    <span class="n">book_path</span> <span class="o">=</span> <span class="n">_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">zip_fn</span> <span class="o">=</span>  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">book_path</span><span class="si">}</span><span class="s2">fb.txt.gz&quot;</span>
    <span class="n">zip_url</span> <span class="o">=</span> <span class="n">_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;index.htm&quot;</span><span class="p">,</span> <span class="n">zip_fn</span><span class="p">)</span>
    
    <span class="n">download_links</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">_title</span><span class="p">,</span> <span class="n">zip_url</span><span class="p">))</span>

<span class="n">download_links</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;The Blue Fairy Book&#39;,
  &#39;https://www.sacred-texts.com/neu/lfb/bl/blfb.txt.gz&#39;),
 (&#39;The Brown Fairy Book&#39;,
  &#39;https://www.sacred-texts.com/neu/lfb/br/brfb.txt.gz&#39;),
 (&#39;The Crimson Fairy Book&#39;,
  &#39;https://www.sacred-texts.com/neu/lfb/cr/crfb.txt.gz&#39;)]
</pre></div>
</div>
</div>
</div>
<p>Now we can download and unzip the files…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">urllib</span>

<span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span> <span class="ow">in</span> <span class="n">download_links</span><span class="p">:</span>
    <span class="c1"># Create a file name to save file to as the file downloaded from the URL</span>
    <span class="n">zip_file</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">zip_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>ls
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LICENSE                   gnfb.txt.gz               pifb.txt.gz
README.md                 gyfb.txt.gz               refb.txt.gz
blfb.txt.gz               index.md                  <span class=" -Color -Color-Blue">site</span>
brfb.txt.gz               lang-fairy-books-db.ipynb vifb.txt.gz
crfb.txt.gz               lifb.txt.gz               yefb.txt.gz
data.db                   olfb.txt.gz
demo.db                   orfb.txt.gz
</pre></div>
</div>
</div>
</div>
<p>The following function will read in the contents of a local gzip file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gzip</span>

<span class="k">def</span> <span class="nf">gzip_txt</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Open gzip file and extract text.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">txt</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s see how it works:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gzip_txt</span><span class="p">(</span><span class="s1">&#39;gnfb.txt.gz&#39;</span><span class="p">)[:</span><span class="mi">1000</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\nThe Green Fairy Book, by Andrew Lang, [1892], at sacred-texts.com\n\nTHE GREEN FAIRY BOOK\n\nBy Various\n\nEdited by Andrew Lang\n\nLondon, New York: Longmans, Green, and Co.\n\n[1892]\n\nTo\n\nStella Margaret Alleyne\n\nthe\n\nGreen Fairy Book\n\nis dedicated\n\nThe Green Fairy Book, by Andrew Lang, [1892], at sacred-texts.com\n\nContents\n\n[*To the Friendly Reader]\n\n[*The Blue Bird]\n\n[*The Half-Chick]\n\n[*The Story of Caliph Stork]\n\n[*The Enchanted Watch]\n\n[*Rosanella]\n\n[*Sylvain and Jocosa]\n\n[*Fairy Gifts]\n\n[*Prince Narcissus and the Princess Potentilla]\n\n[*Prince Featherhead and the Princess Celandine]\n\n[*The Three Little Pigs]\n\n[*Heart of Ice]\n\n[*The Enchanted Ring]\n\n[*The Snuff-box]\n\n[*The Golden Blackbird]\n\n[*The Little Soldier]\n\n[*The Magic Swan]\n\n[*The Dirty Shepherdess]\n\n[*The Enchanted Snake]\n\n[*The Biter Bit]\n\n[*King Kojata]\n\n[*Prince Fickle and Fair Helena]\n\n[*Puddocky]\n\n[*The Story of Hok Lee and the Dwarfs]\n\n[*The Story of the Three Bears]\n\n[*Prince Vivien and the Princess Placida]\n\n[*Little One&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>ls
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LICENSE                   gnfb.txt.gz               pifb.txt.gz
README.md                 gyfb.txt.gz               refb.txt.gz
blfb.txt.gz               index.md                  <span class=" -Color -Color-Blue">site</span>
brfb.txt.gz               lang-fairy-books-db.ipynb vifb.txt.gz
crfb.txt.gz               lifb.txt.gz               yefb.txt.gz
data.db                   olfb.txt.gz
demo.db                   orfb.txt.gz
</pre></div>
</div>
</div>
</div>
<p>Select one of the books and read in the book text:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">txt</span> <span class="o">=</span> <span class="n">gzip_txt</span><span class="p">(</span><span class="s1">&#39;blfb.txt.gz&#39;</span><span class="p">)</span>

<span class="c1"># Preview the first 1500 characters</span>
<span class="n">txt</span><span class="p">[:</span><span class="mi">1500</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\nThe Blue Fairy Book, by Andrew Lang, [1889], at sacred-texts.com\n\nTHE BLUE FAIRY BOOK\n\nby Andrew Lang\n\nLondon, New York: Longmans, Green\n\n[1889]\n\nThe Blue Fairy Book, by Andrew Lang, [1889], at sacred-texts.com\n\nCONTENTS\n\n[*THE BRONZE RING]\n\n[*PRINCE HYACINTH AND THE DEAR LITTLE PRINCESS]\n\n[*EAST OF THE SUN AND WEST OF THE MOON]\n\n[*THE YELLOW DWARF]\n\n[*LITTLE RED RIDING-HOOD]\n\n[*THE SLEEPING BEAUTY IN THE WOOD]\n\n[*CINDERELLA; OR, THE LITTLE GLASS SLIPPER]\n\n[*ALADDIN AND THE WONDERFUL LAMP]\n\n[*THE TALE OF A YOUTH WHO SET OUT TO LEARN WHAT FEAR WAS]\n\n[*RUMPELSTILTZKIN]\n\n[*BEAUTY AND THE BEAST]\n\n[*THE MASTER-MAID]\n\n[*WHY THE SEA IS SALT]\n\n[*THE MASTER CAT; OR, PUSS IN BOOTS]\n\n[*FELICIA AND THE POT OF PINKS]\n\n[*THE WHITE CAT]\n\n[*THE WATER-LILY. THE GOLD-SPINNERS]\n\n[*THE TERRIBLE HEAD]\n\n[*THE STORY OF PRETTY GOLDILOCKS]\n\n[*THE HISTORY OF WHITTINGTON]\n\n[*THE WONDERFUL SHEEP]\n\n[*LITTLE THUMB]\n\n[*THE FORTY THIEVES]\n\n[*HANSEL AND GRETTEL]\n\n[*SNOW-WHITE AND ROSE-RED]\n\n[*THE GOOSE-GIRL]\n\n[*TOADS AND DIAMONDS]\n\n[*PRINCE DARLING]\n\n[*BLUE BEARD]\n\n[*TRUSTY JOHN]\n\n[*THE BRAVE LITTLE TAILOR]\n\n[*A VOYAGE TO LILLIPUT]\n\n[*THE PRINCESS ON THE GLASS HILL]\n\n[*THE STORY OF PRINCE AHMED AND THE FAIRY PARIBANOU]\n\n[*THE HISTORY OF JACK THE GIANT-KILLER]\n\n[*THE BLACK BULL OF NORROWAY]\n\n[*THE RED ETIN]\n\nThe Blue Fairy Book, by Andrew Lang, [1889], at sacred-texts.com\n\n[f01]\n\nTHE BRONZE RING\n\nOnce upon a time in a certain country there lived a king whose palace was surrounded by a spacious garden. But, t&#39;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="extract-stories">
<h2>Extract Stories<a class="headerlink" href="#extract-stories" title="Permalink to this headline">¶</a></h2>
<p>Having got the contents, let’s now extract all the stories.</p>
<p>Within each book, the stories are delimited by a pattern <code class="docutils literal notranslate"><span class="pre">[fNN]</span></code> (for digits <code class="docutils literal notranslate"><span class="pre">N</span></code>). We can use this pattern to split out the stories.</p>
<p>To do this, we’ll use the <code class="docutils literal notranslate"><span class="pre">re</span></code> regular expression package:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
</pre></div>
</div>
</div>
</div>
<p>We can now define a pattern against which we can split each file into separate chunks:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split the file into separate chunks delimited by the pattern: [fNN]</span>
<span class="n">stories</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;\[f\d</span><span class="si">{2}</span><span class="s2">\]&quot;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>

<span class="c1"># Strip whitespace at start and end</span>
<span class="n">stories</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stories</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="extract-the-contents">
<h2>Extract the contents<a class="headerlink" href="#extract-the-contents" title="Permalink to this headline">¶</a></h2>
<p>The contents appear in the first “story chunk” (index <code class="docutils literal notranslate"><span class="pre">0</span></code>) in the text:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stories</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;The Blue Fairy Book, by Andrew Lang, [1889], at sacred-texts.com\n\nTHE BLUE FAIRY BOOK\n\nby Andrew Lang\n\nLondon, New York: Longmans, Green\n\n[1889]\n\nThe Blue Fairy Book, by Andrew Lang, [1889], at sacred-texts.com\n\nCONTENTS\n\n[*THE BRONZE RING]\n\n[*PRINCE HYACINTH AND THE DEAR LITTLE PRINCESS]\n\n[*EAST OF THE SUN AND WEST OF THE MOON]\n\n[*THE YELLOW DWARF]\n\n[*LITTLE RED RIDING-HOOD]\n\n[*THE SLEEPING BEAUTY IN THE WOOD]\n\n[*CINDERELLA; OR, THE LITTLE GLASS SLIPPER]\n\n[*ALADDIN AND THE WONDERFUL LAMP]\n\n[*THE TALE OF A YOUTH WHO SET OUT TO LEARN WHAT FEAR WAS]\n\n[*RUMPELSTILTZKIN]\n\n[*BEAUTY AND THE BEAST]\n\n[*THE MASTER-MAID]\n\n[*WHY THE SEA IS SALT]\n\n[*THE MASTER CAT; OR, PUSS IN BOOTS]\n\n[*FELICIA AND THE POT OF PINKS]\n\n[*THE WHITE CAT]\n\n[*THE WATER-LILY. THE GOLD-SPINNERS]\n\n[*THE TERRIBLE HEAD]\n\n[*THE STORY OF PRETTY GOLDILOCKS]\n\n[*THE HISTORY OF WHITTINGTON]\n\n[*THE WONDERFUL SHEEP]\n\n[*LITTLE THUMB]\n\n[*THE FORTY THIEVES]\n\n[*HANSEL AND GRETTEL]\n\n[*SNOW-WHITE AND ROSE-RED]\n\n[*THE GOOSE-GIRL]\n\n[*TOADS AND DIAMONDS]\n\n[*PRINCE DARLING]\n\n[*BLUE BEARD]\n\n[*TRUSTY JOHN]\n\n[*THE BRAVE LITTLE TAILOR]\n\n[*A VOYAGE TO LILLIPUT]\n\n[*THE PRINCESS ON THE GLASS HILL]\n\n[*THE STORY OF PRINCE AHMED AND THE FAIRY PARIBANOU]\n\n[*THE HISTORY OF JACK THE GIANT-KILLER]\n\n[*THE BLACK BULL OF NORROWAY]\n\n[*THE RED ETIN]\n\nThe Blue Fairy Book, by Andrew Lang, [1889], at sacred-texts.com&#39;
</pre></div>
</div>
</div>
</div>
<p>Let’s pull out the book name:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The name appears before the first comma</span>
<span class="n">book</span> <span class="o">=</span> <span class="n">stories</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">book</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;The Blue Fairy Book&#39;
</pre></div>
</div>
</div>
</div>
<p>The Python <a class="reference external" href="https://github.com/r1chardj0n3s/parse"><code class="docutils literal notranslate"><span class="pre">parse</span></code></a> package provides a simple way of <em>matching</em> patterns using syntax that resembles a string formatting template that could be used to create the strings being matched against.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">parse</span>
</pre></div>
</div>
</div>
</div>
<p>We can alternatively is this package to extract the title against a template style pattern:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#The Blue Fairy Book, by Andrew Lang, [1889], at sacred-texts.com</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{title}</span><span class="s2">, by Andrew Lang, [</span><span class="si">{year}</span><span class="s2">]</span><span class="si">{}</span><span class="s2">, at sacred-texts.com&quot;</span><span class="p">,</span> <span class="n">stories</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;The Blue Fairy Book&#39;, &#39;1889&#39;)
</pre></div>
</div>
</div>
</div>
<p>There are plenty of cribs to help us pull out the contents, although it may not be obviously clear with the early content items whether they are stories or not…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># There is a Contents header, but it may be cased...</span>
<span class="c1"># So split in a case insensitive way</span>
<span class="n">boilerplate</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(Contents|CONTENTS)&#39;</span><span class="p">,</span> <span class="n">stories</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">boilerplate</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;The Blue Fairy Book, by Andrew Lang, [1889], at sacred-texts.com\n\nTHE BLUE FAIRY BOOK\n\nby Andrew Lang\n\nLondon, New York: Longmans, Green\n\n[1889]\n\nThe Blue Fairy Book, by Andrew Lang, [1889], at sacred-texts.com\n\n&#39;,
 &#39;CONTENTS&#39;,
 &#39;\n\n[*THE BRONZE RING]\n\n[*PRINCE HYACINTH AND THE DEAR LITTLE PRINCESS]\n\n[*EAST OF THE SUN AND WEST OF THE MOON]\n\n[*THE YELLOW DWARF]\n\n[*LITTLE RED RIDING-HOOD]\n\n[*THE SLEEPING BEAUTY IN THE WOOD]\n\n[*CINDERELLA; OR, THE LITTLE GLASS SLIPPER]\n\n[*ALADDIN AND THE WONDERFUL LAMP]\n\n[*THE TALE OF A YOUTH WHO SET OUT TO LEARN WHAT FEAR WAS]\n\n[*RUMPELSTILTZKIN]\n\n[*BEAUTY AND THE BEAST]\n\n[*THE MASTER-MAID]\n\n[*WHY THE SEA IS SALT]\n\n[*THE MASTER CAT; OR, PUSS IN BOOTS]\n\n[*FELICIA AND THE POT OF PINKS]\n\n[*THE WHITE CAT]\n\n[*THE WATER-LILY. THE GOLD-SPINNERS]\n\n[*THE TERRIBLE HEAD]\n\n[*THE STORY OF PRETTY GOLDILOCKS]\n\n[*THE HISTORY OF WHITTINGTON]\n\n[*THE WONDERFUL SHEEP]\n\n[*LITTLE THUMB]\n\n[*THE FORTY THIEVES]\n\n[*HANSEL AND GRETTEL]\n\n[*SNOW-WHITE AND ROSE-RED]\n\n[*THE GOOSE-GIRL]\n\n[*TOADS AND DIAMONDS]\n\n[*PRINCE DARLING]\n\n[*BLUE BEARD]\n\n[*TRUSTY JOHN]\n\n[*THE BRAVE LITTLE TAILOR]\n\n[*A VOYAGE TO LILLIPUT]\n\n[*THE PRINCESS ON THE GLASS HILL]\n\n[*THE STORY OF PRINCE AHMED AND THE FAIRY PARIBANOU]\n\n[*THE HISTORY OF JACK THE GIANT-KILLER]\n\n[*THE BLACK BULL OF NORROWAY]\n\n[*THE RED ETIN]\n\nThe Blue Fairy Book, by Andrew Lang, [1889], at sacred-texts.com&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The name of the book repeats at the end of the content block</span>
<span class="c1"># So snip it out... </span>
<span class="n">contents_</span> <span class="o">=</span> <span class="n">boilerplate</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">book</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">contents_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;[*THE BRONZE RING]\n\n[*PRINCE HYACINTH AND THE DEAR LITTLE PRINCESS]\n\n[*EAST OF THE SUN AND WEST OF THE MOON]\n\n[*THE YELLOW DWARF]\n\n[*LITTLE RED RIDING-HOOD]\n\n[*THE SLEEPING BEAUTY IN THE WOOD]\n\n[*CINDERELLA; OR, THE LITTLE GLASS SLIPPER]\n\n[*ALADDIN AND THE WONDERFUL LAMP]\n\n[*THE TALE OF A YOUTH WHO SET OUT TO LEARN WHAT FEAR WAS]\n\n[*RUMPELSTILTZKIN]\n\n[*BEAUTY AND THE BEAST]\n\n[*THE MASTER-MAID]\n\n[*WHY THE SEA IS SALT]\n\n[*THE MASTER CAT; OR, PUSS IN BOOTS]\n\n[*FELICIA AND THE POT OF PINKS]\n\n[*THE WHITE CAT]\n\n[*THE WATER-LILY. THE GOLD-SPINNERS]\n\n[*THE TERRIBLE HEAD]\n\n[*THE STORY OF PRETTY GOLDILOCKS]\n\n[*THE HISTORY OF WHITTINGTON]\n\n[*THE WONDERFUL SHEEP]\n\n[*LITTLE THUMB]\n\n[*THE FORTY THIEVES]\n\n[*HANSEL AND GRETTEL]\n\n[*SNOW-WHITE AND ROSE-RED]\n\n[*THE GOOSE-GIRL]\n\n[*TOADS AND DIAMONDS]\n\n[*PRINCE DARLING]\n\n[*BLUE BEARD]\n\n[*TRUSTY JOHN]\n\n[*THE BRAVE LITTLE TAILOR]\n\n[*A VOYAGE TO LILLIPUT]\n\n[*THE PRINCESS ON THE GLASS HILL]\n\n[*THE STORY OF PRINCE AHMED AND THE FAIRY PARIBANOU]\n\n[*THE HISTORY OF JACK THE GIANT-KILLER]\n\n[*THE BLACK BULL OF NORROWAY]\n\n[*THE RED ETIN]&#39;
</pre></div>
</div>
</div>
</div>
<p>We note that <code class="docutils literal notranslate"><span class="pre">contents_</span></code> conains a string with repeated end of line elements (<code class="docutils literal notranslate"><span class="pre">\n\n</span></code>) separating the titles in the form <code class="docutils literal notranslate"><span class="pre">[*STORY</span> <span class="pre">TITLE]</span></code> (for example, <code class="docutils literal notranslate"><span class="pre">[*LITTLE</span> <span class="pre">RED</span> <span class="pre">RIDING-HOOD]</span></code>).</p>
<p>We can parse out titles from the contents list based on the pattern delimiter <code class="docutils literal notranslate"><span class="pre">[*EXTRACT</span> <span class="pre">THIS</span> <span class="pre">PATTERN]</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Match against [* and ] and extract everything in between</span>
<span class="n">contents</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;[*</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">contents_</span><span class="p">)</span>

<span class="c1"># The title text available as item.fixed[0]</span>
<span class="c1"># Also convert the title to title case</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">fixed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">]</span>
<span class="n">titles</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;The Bronze Ring&#39;,
 &#39;Prince Hyacinth And The Dear Little Princess&#39;,
 &#39;East Of The Sun And West Of The Moon&#39;,
 &#39;The Yellow Dwarf&#39;,
 &#39;Little Red Riding-Hood&#39;,
 &#39;The Sleeping Beauty In The Wood&#39;,
 &#39;Cinderella; Or, The Little Glass Slipper&#39;,
 &#39;Aladdin And The Wonderful Lamp&#39;,
 &#39;The Tale Of A Youth Who Set Out To Learn What Fear Was&#39;,
 &#39;Rumpelstiltzkin&#39;,
 &#39;Beauty And The Beast&#39;,
 &#39;The Master-Maid&#39;,
 &#39;Why The Sea Is Salt&#39;,
 &#39;The Master Cat; Or, Puss In Boots&#39;,
 &#39;Felicia And The Pot Of Pinks&#39;,
 &#39;The White Cat&#39;,
 &#39;The Water-Lily. The Gold-Spinners&#39;,
 &#39;The Terrible Head&#39;,
 &#39;The Story Of Pretty Goldilocks&#39;,
 &#39;The History Of Whittington&#39;,
 &#39;The Wonderful Sheep&#39;,
 &#39;Little Thumb&#39;,
 &#39;The Forty Thieves&#39;,
 &#39;Hansel And Grettel&#39;,
 &#39;Snow-White And Rose-Red&#39;,
 &#39;The Goose-Girl&#39;,
 &#39;Toads And Diamonds&#39;,
 &#39;Prince Darling&#39;,
 &#39;Blue Beard&#39;,
 &#39;Trusty John&#39;,
 &#39;The Brave Little Tailor&#39;,
 &#39;A Voyage To Lilliput&#39;,
 &#39;The Princess On The Glass Hill&#39;,
 &#39;The Story Of Prince Ahmed And The Fairy Paribanou&#39;,
 &#39;The History Of Jack The Giant-Killer&#39;,
 &#39;The Black Bull Of Norroway&#39;,
 &#39;The Red Etin&#39;]
</pre></div>
</div>
</div>
</div>
<p>## Coping With Page Numbers</p>
<p>There seems to be work in progress adding page numbers to books using a pattern of the form <code class="docutils literal notranslate"><span class="pre">[p.</span> <span class="pre">ix]</span></code>, <code class="docutils literal notranslate"><span class="pre">[p.</span> <span class="pre">1]</span></code>, <code class="docutils literal notranslate"><span class="pre">[p.</span> <span class="pre">11]</span></code> and so on.</p>
<p>For now, let’s create a regular expression substitution to remove those…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">example</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;[f01]</span>
<span class="s2">[p. ix]</span>

<span class="s2">THE YELLOW FAIRY BOOK</span>

<span class="s2">THE CAT AND THE MOUSE IN PARTNERSHIP</span>

<span class="s2">A cat had made acquaintance with a mouse, and had spoken so much of the great love and friendship she felt for her, that at last the Mouse consented to live in the same house with her, and to go shares in the housekeeping.  &#39;But we must provide for the winter or else we shall suffer hunger,&#39; said the Cat.  &#39;You, little Mouse, cannot venture everywhere in case you run at last into a trap.&#39;  This good counsel was followed, and a little pot of fat was bought.  But they did not know where to put it.  At length, after long consultation, the Cat said, &#39;I know of no place where it could be better put than in the church.  No one will trouble to take it away from there.  We will hide it in a corner, and we won&#39;t touch it till we are in want.&#39;  So the little pot was placed in safety; but it was not long before the Cat had a great longing for it, and said to the Mouse, &#39;I wanted to tell you, little Mouse, that my cousin has a little son, white with brown spots, and she wants me to be godmother to it.  Let me go out to-day, and do you take care of the house alone.&#39;</span>

<span class="s2">[p. 1]</span>

<span class="s2">&#39;Yes, go certainly,&#39; replied the Mouse, &#39;and when you eat anything good, think of me; I should very much like a drop of the red christening wine.&#39;</span>

<span class="s2">But it was all untrue.  The Cat had no cousin, and had not been asked to be godmother.  She went straight to the church, slunk to the little pot of fat, began to lick it, and licked the top off.  Then she took a walk on the roofs of the town, looked at the view, stretched</span>

<span class="s2">[P. 22]</span>

<span class="s2">herself out in the sun, and licked her lips whenever she thought of the little pot of fat.  As soon as it was evening she went home again.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># Example of regex to remove page numbers</span>
<span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\n*\[[pP]\. [^\]\s]*\]\n\n&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">example</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;[f01]THE YELLOW FAIRY BOOK\n\nTHE CAT AND THE MOUSE IN PARTNERSHIP\n\nA cat had made acquaintance with a mouse, and had spoken so much of the great love and friendship she felt for her, that at last the Mouse consented to live in the same house with her, and to go shares in the housekeeping.  &#39;But we must provide for the winter or else we shall suffer hunger,&#39; said the Cat.  &#39;You, little Mouse, cannot venture everywhere in case you run at last into a trap.&#39;  This good counsel was followed, and a little pot of fat was bought.  But they did not know where to put it.  At length, after long consultation, the Cat said, &#39;I know of no place where it could be better put than in the church.  No one will trouble to take it away from there.  We will hide it in a corner, and we won&#39;t touch it till we are in want.&#39;  So the little pot was placed in safety; but it was not long before the Cat had a great longing for it, and said to the Mouse, &#39;I wanted to tell you, little Mouse, that my cousin has a little son, white with brown spots, and she wants me to be godmother to it.  Let me go out to-day, and do you take care of the house alone.&#39;&#39;Yes, go certainly,&#39; replied the Mouse, &#39;and when you eat anything good, think of me; I should very much like a drop of the red christening wine.&#39;\n\nBut it was all untrue.  The Cat had no cousin, and had not been asked to be godmother.  She went straight to the church, slunk to the little pot of fat, began to lick it, and licked the top off.  Then she took a walk on the roofs of the town, looked at the view, stretchedherself out in the sun, and licked her lips whenever she thought of the little pot of fat.  As soon as it was evening she went home again.\n&quot;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="pulling-the-parser-together">
<h2>Pulling the Parser Together<a class="headerlink" href="#pulling-the-parser-together" title="Permalink to this headline">¶</a></h2>
<p>Let’s create a function to parse the book for us by pulling together all the previous fragments:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse_book</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse book from text.&quot;&quot;&quot;</span>
    
    <span class="c1"># Get story chunks</span>
    <span class="n">stories</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;\[f\d</span><span class="si">{2}</span><span class="s2">\]&quot;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>
    <span class="n">stories</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stories</span><span class="p">]</span>
    
    <span class="c1"># Get book name</span>
    <span class="n">book</span> <span class="o">=</span> <span class="n">stories</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Process contents</span>
    <span class="n">boilerplate</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(Contents|CONTENTS)&#39;</span><span class="p">,</span> <span class="n">stories</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># The name of the book repeats at the end of the content block</span>
    <span class="c1"># So snip it out... </span>
    <span class="n">contents_</span> <span class="o">=</span> <span class="n">boilerplate</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">book</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Match against [* and ] and extract everything in between</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;[*</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">contents_</span><span class="p">)</span>

    <span class="c1"># Get titles from contents</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">fixed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">]</span>
    
    <span class="c1"># Get metadata</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{title}</span><span class="s2">, by Andrew Lang, [</span><span class="si">{year}</span><span class="s2">]</span><span class="si">{}</span><span class="s2">, at sacred-texts.com&quot;</span><span class="p">,</span> <span class="n">stories</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">named</span>

    <span class="k">return</span> <span class="n">book</span><span class="p">,</span> <span class="n">stories</span><span class="p">,</span> <span class="n">titles</span><span class="p">,</span> <span class="n">metadata</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-simple-database-structure">
<h2>Create Simple Database Structure<a class="headerlink" href="#create-simple-database-structure" title="Permalink to this headline">¶</a></h2>
<p>Let’s create a simple database structure and configure it for full text search.</p>
<p>We’ll use SQLite3 for the database. One of the easiest ways of working with SQLite3 databases is via the <a class="reference external" href="https://sqlite-utils.datasette.io/en/stable/"><code class="docutils literal notranslate"><span class="pre">sqlite_utils</span></code></a> package.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils</span> <span class="kn">import</span> <span class="n">Database</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.9/site-packages/pandas/core/window/ewm.py:11: RuntimeWarning: coroutine &#39;async_function&#39; was never awaited
  import pandas._libs.window.aggregations as window_aggregations
RuntimeWarning: Enable tracemalloc to get the object allocation traceback
</pre></div>
</div>
</div>
</div>
<p>Specifiy the database filename (and optionally conntect to the database if it already exists):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db_name</span> <span class="o">=</span> <span class="s2">&quot;demo.db&quot;</span>

<span class="c1"># Uncomment the following lines to connect to a pre-existing database</span>
<span class="c1">#db = Database(db_name)</span>
</pre></div>
</div>
</div>
</div>
<p>The following will create a new database (or overwrite a pre-existing one of the same name) and define the database tables we require.</p>
<p>Note that we also enable full text search on the <code class="docutils literal notranslate"><span class="pre">book</span></code> that creates an extra virtual table that supports full text search.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do not run this cell if your database already exists!</span>

<span class="c1"># While developing the script, recreate database each time...</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">recreate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># This schema has been evolved iteratively as I have identified structure</span>
<span class="c1"># that can be usefully mined...</span>

<span class="n">db</span><span class="p">[</span><span class="s2">&quot;books&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s2">&quot;book&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;last_para&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="c1"># sometimes contains provenance</span>
    <span class="s2">&quot;first_line&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="c1"># maybe we want to review the openings, or create an index...</span>
    <span class="s2">&quot;provenance&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="c1"># attempt at provenance</span>
    <span class="s2">&quot;chapter_order&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="c1"># Sort order of stories in book</span>
<span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;book&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">))</span>

<span class="n">db</span><span class="p">[</span><span class="s2">&quot;books_metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">})</span>

<span class="c1"># Enable full text search</span>
<span class="c1"># This creates an extra virtual table (books_fts) to support the full text search</span>
<span class="n">db</span><span class="p">[</span><span class="s2">&quot;books&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">enable_fts</span><span class="p">([</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">create_triggers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Table books (book, title, text, last_para, first_line, provenance, chapter_order)&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="build-database">
<h2>Build Database<a class="headerlink" href="#build-database" title="Permalink to this headline">¶</a></h2>
<p>Let’s now create a function that can populate our database based on the contents of one of the books:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">extract_book_stories</span><span class="p">(</span><span class="n">db_tbl</span><span class="p">,</span> <span class="n">book</span><span class="p">,</span> <span class="n">stories</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">book_items</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># The titles are from the contents list</span>
    <span class="c1"># We will actually grab titles from the story</span>
    <span class="c1"># but the titles grabbed from the contents can be passed in</span>
    <span class="c1"># if we want to write a check against them.</span>
    <span class="c1"># Note: there may be punctation differences in the title in the contents</span>
    <span class="c1"># and the actual title in the text</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">story</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stories</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="c1"># Remove the page numbers for now...</span>
        <span class="n">story</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\n*\[[pP]\. [^\]\s]*\]\n\n&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">story</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Other cleaning</span>
        <span class="n">story</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[\*\d+\s*\]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">story</span><span class="p">)</span>
        
        <span class="c1"># Get the title from the start of the story text</span>
        <span class="n">story_</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">title_</span> <span class="o">=</span> <span class="n">story_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Force the title case variant of the title</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">title_</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;S&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;s&quot;</span><span class="p">)</span>
    
        <span class="c1"># Optionally display the titles and the book</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2"> :: </span><span class="si">{</span><span class="n">book</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Reassemble the story</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">story_</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        
        <span class="c1"># Clean out the name of the book if it is in the text</span>
        <span class="c1">#The Green Fairy Book, by Andrew Lang, [1892], at sacred-texts.com</span>
        <span class="n">name_ignorecase</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">book</span><span class="si">}</span><span class="s2">, by Andrew Lang, \[\d*\], at sacred-texts.com&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">name_ignorecase</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="c1"># Extract the first line then add the full stop back in.</span>
        <span class="n">first_line</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
        
        <span class="n">last_para</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">provenance_1</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">{}</span><span class="s1">] </span><span class="si">{provenance}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">last_para</span><span class="p">)</span>
        <span class="n">provenance_2</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">{provenance}</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">last_para</span><span class="p">)</span>
        <span class="n">provenance_3</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;(</span><span class="si">{provenance}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">last_para</span><span class="p">)</span>
        <span class="n">provenance_4</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;provenance&quot;</span><span class="p">:</span><span class="n">last_para</span><span class="p">}</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_para</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">&lt;</span><span class="mi">7</span> <span class="k">else</span> <span class="p">{}</span> <span class="c1"># Heuristic</span>
        <span class="n">provenance_</span> <span class="o">=</span> <span class="n">provenance_1</span> <span class="ow">or</span> <span class="n">provenance_2</span> <span class="ow">or</span> <span class="n">provenance_3</span> <span class="ow">or</span> <span class="n">provenance_4</span>
        
        <span class="n">provenance</span> <span class="o">=</span> <span class="n">provenance_</span><span class="p">[</span><span class="s2">&quot;provenance&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">provenance_</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">book_items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;book&quot;</span><span class="p">:</span> <span class="n">book</span><span class="p">,</span>
                           <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                           <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
                           <span class="s2">&quot;last_para&quot;</span><span class="p">:</span> <span class="n">last_para</span><span class="p">,</span>
                           <span class="s2">&quot;first_line&quot;</span><span class="p">:</span> <span class="n">first_line</span><span class="p">,</span>
                           <span class="s2">&quot;provenance&quot;</span><span class="p">:</span> <span class="n">provenance</span><span class="p">,</span>
                           <span class="s2">&quot;chapter_order&quot;</span><span class="p">:</span><span class="n">i</span><span class="p">})</span>
    
    <span class="c1"># The upsert means &quot;add or replace&quot;</span>
    <span class="n">db_tbl</span><span class="o">.</span><span class="n">upsert_all</span><span class="p">(</span><span class="n">book_items</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;book&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We can add the data for a particular book by passing in the titles and stories:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">book</span><span class="p">,</span> <span class="n">stories</span><span class="p">,</span> <span class="n">titles</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">parse_book</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

<span class="n">extract_book_stories</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;books&quot;</span><span class="p">],</span> <span class="n">book</span><span class="p">,</span> <span class="n">stories</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The Bronze Ring :: The Blue Fairy Book
Prince Hyacinth And The Dear Little Princess :: The Blue Fairy Book
East Of The Sun And West Of The Moon :: The Blue Fairy Book
The Yellow Dwarf :: The Blue Fairy Book
Little Red Riding Hood :: The Blue Fairy Book
The Sleeping Beauty In The Wood :: The Blue Fairy Book
Cinderella, Or The Little Glass Slipper :: The Blue Fairy Book
Aladdin And The Wonderful Lamp :: The Blue Fairy Book
The Tale Of A Youth Who Set Out To Learn What Fear Was :: The Blue Fairy Book
Rumpelstiltzkin :: The Blue Fairy Book
Beauty And The Beast :: The Blue Fairy Book
The Master-Maid :: The Blue Fairy Book
Why The Sea Is Salt :: The Blue Fairy Book
The Master Cat; Or, Puss In Boots :: The Blue Fairy Book
Felicia And The Pot Of Pinks :: The Blue Fairy Book
The White Cat :: The Blue Fairy Book
The Water-Lily. The Gold-Spinners :: The Blue Fairy Book
The Terrible Head :: The Blue Fairy Book
The Story Of Pretty Goldilocks :: The Blue Fairy Book
The History Of Whittington :: The Blue Fairy Book
The Wonderful Sheep :: The Blue Fairy Book
Little Thumb :: The Blue Fairy Book
The Forty Thieves :: The Blue Fairy Book
Hansel And Grettel :: The Blue Fairy Book
Snow-White And Rose-Red :: The Blue Fairy Book
The Goose-Girl :: The Blue Fairy Book
Toads And Diamonds :: The Blue Fairy Book
Prince Darling :: The Blue Fairy Book
Blue Beard :: The Blue Fairy Book
Trusty John :: The Blue Fairy Book
The Brave Little Tailor :: The Blue Fairy Book
A Voyage To Lilliput :: The Blue Fairy Book
The Princess On The Glass Hill :: The Blue Fairy Book
The Story Of Prince Ahmed And The Fairy Paribanou :: The Blue Fairy Book
The History Of Jack The Giant-Killer :: The Blue Fairy Book
The Black Bull Of Norroway :: The Blue Fairy Book
The Red Etin :: The Blue Fairy Book
</pre></div>
</div>
</div>
</div>
<p>We can now run a full text search over the stories. For example, if we are looking for a story with a king and three sons:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;king &quot;three sons&quot;&#39;</span>

<span class="c1"># The `.search()` method knows how to find the full text search table</span>
<span class="c1"># given the original table name</span>
<span class="k">for</span> <span class="n">story</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;books&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">quote_fts</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;book&quot;</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">story</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;title&#39;: &#39;The Master Cat; Or, Puss In Boots&#39;, &#39;book&#39;: &#39;The Blue Fairy Book&#39;}
{&#39;title&#39;: &#39;The White Cat&#39;, &#39;book&#39;: &#39;The Blue Fairy Book&#39;}
{&#39;title&#39;: &#39;The Story Of Prince Ahmed And The Fairy Paribanou&#39;, &#39;book&#39;: &#39;The Blue Fairy Book&#39;}
</pre></div>
</div>
</div>
</div>
<p>We can also construct a full text search query over the full text search virtual table explicitly:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q2</span> <span class="o">=</span> <span class="s1">&#39;king &quot;three sons&quot; goose&#39;</span>

<span class="n">_q</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT title FROM books_fts WHERE books_fts MATCH </span><span class="si">{</span><span class="n">db</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span><span class="si">}</span><span class="s1"> ;&#39;</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">_q</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>The full text search also allows us to select snippets around the search term:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q3</span> <span class="o">=</span> <span class="s1">&#39;&quot;three sons&quot;&#39;</span>

<span class="n">_q</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT title, snippet(books_fts, -1, &quot;__&quot;, &quot;__&quot;, &quot;...&quot;, 30) as clip</span>
<span class="s2">FROM books_fts WHERE books_fts MATCH </span><span class="si">{</span><span class="n">db</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">q3</span><span class="p">)</span><span class="si">}</span><span class="s2"> LIMIT 2 ;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">_q</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;clip&quot;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There was a miller who left no more estate to the __three sons__ he had than his mill, his ass, and his cat. The partition was soon made. Neither scrivener...
---

Once upon a time there was a king who had __three sons__, who were all so clever and brave that he began to be afraid that they would want to...
---
</pre></div>
</div>
</div>
</div>
<p>We can now create a complete database of Lang’s collected fairy stories by churning through all the books and adding them to the database:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fn</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">)]:</span>
    <span class="c1"># Read in book from gzip file</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">gzip_txt</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="c1"># Parse book</span>
    <span class="n">book</span><span class="p">,</span> <span class="n">stories</span><span class="p">,</span> <span class="n">titles</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">parse_book</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    
    <span class="c1">#Populate metadata table</span>
    <span class="n">db</span><span class="p">[</span><span class="s2">&quot;books_metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">))</span>
    
    <span class="c1"># Extract stories and add them to the database</span>
    <span class="c1"># The records are upserted (add or replaced) so we won&#39;t get duplicate records</span>
    <span class="c1"># for the book we have already loaded into the database</span>
    <span class="n">extract_book_stories</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;books&quot;</span><span class="p">],</span> <span class="n">book</span><span class="p">,</span> <span class="n">stories</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>How many books are there?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM books_metadata ORDER BY year ASC&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;title&#39;: &#39;The Pink Fairy Book&#39;, &#39;year&#39;: 1889}
{&#39;title&#39;: &#39;The Blue Fairy Book&#39;, &#39;year&#39;: 1889}
{&#39;title&#39;: &#39;The Yellow Fairy Book&#39;, &#39;year&#39;: 1889}
{&#39;title&#39;: &#39;The Red Fairy Book&#39;, &#39;year&#39;: 1890}
{&#39;title&#39;: &#39;The Green Fairy Book&#39;, &#39;year&#39;: 1892}
{&#39;title&#39;: &#39;The Grey Fairy Book&#39;, &#39;year&#39;: 1900}
{&#39;title&#39;: &#39;The Violet Fairy Book&#39;, &#39;year&#39;: 1901}
{&#39;title&#39;: &#39;The Crimson Fairy Book&#39;, &#39;year&#39;: 1903}
{&#39;title&#39;: &#39;The Brown Fairy Book&#39;, &#39;year&#39;: 1904}
{&#39;title&#39;: &#39;The Orange Fairy Book&#39;, &#39;year&#39;: 1906}
{&#39;title&#39;: &#39;The Olive Fairy Book&#39;, &#39;year&#39;: 1907}
{&#39;title&#39;: &#39;The Lilac Fairy Book&#39;, &#39;year&#39;: 1910}
</pre></div>
</div>
</div>
</div>
<p>Okay - the titles are fine but the years look a bit shonky to me…</p>
<p>The dates are okay if we use the ones from the sacred texts listing page that we previously grabbed into <code class="docutils literal notranslate"><span class="pre">sacred_metadata</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_metadata</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">sacred_metadata</span><span class="p">:</span>
    <span class="n">new_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
    
<span class="n">new_metadata</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;title&#39;: &#39;The Blue Fairy Book&#39;, &#39;year&#39;: &#39;1889&#39;},
 {&#39;title&#39;: &#39;The Brown Fairy Book&#39;, &#39;year&#39;: &#39;1904&#39;},
 {&#39;title&#39;: &#39;The Crimson Fairy Book&#39;, &#39;year&#39;: &#39;1903&#39;},
 {&#39;title&#39;: &#39;The Green Fairy Book&#39;, &#39;year&#39;: &#39;1892&#39;},
 {&#39;title&#39;: &#39;The Grey Fairy Book&#39;, &#39;year&#39;: &#39;1900&#39;},
 {&#39;title&#39;: &#39;The Lilac Fairy Book&#39;, &#39;year&#39;: &#39;1910&#39;},
 {&#39;title&#39;: &#39;The Olive Fairy Book&#39;, &#39;year&#39;: &#39;1910&#39;},
 {&#39;title&#39;: &#39;The Orange Fairy Book&#39;, &#39;year&#39;: &#39;1906&#39;},
 {&#39;title&#39;: &#39;The Pink Fairy Book&#39;, &#39;year&#39;: &#39;1897&#39;},
 {&#39;title&#39;: &#39;The Red Fairy Book&#39;, &#39;year&#39;: &#39;1890&#39;},
 {&#39;title&#39;: &#39;The Violet Fairy Book&#39;, &#39;year&#39;: &#39;1901&#39;},
 {&#39;title&#39;: &#39;The Yellow Fairy Book&#39;, &#39;year&#39;: &#39;1894&#39;}]
</pre></div>
</div>
</div>
</div>
<p>Replace the <code class="docutils literal notranslate"><span class="pre">books_metadata</span></code> table:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The truncate=True clears the records from the original table</span>
<span class="n">db</span><span class="p">[</span><span class="s2">&quot;books_metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">(</span><span class="n">new_metadata</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">),</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Table books_metadata (title, year)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM books_metadata ORDER BY year ASC&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;title&#39;: &#39;The Blue Fairy Book&#39;, &#39;year&#39;: 1889}
{&#39;title&#39;: &#39;The Red Fairy Book&#39;, &#39;year&#39;: 1890}
{&#39;title&#39;: &#39;The Green Fairy Book&#39;, &#39;year&#39;: 1892}
{&#39;title&#39;: &#39;The Yellow Fairy Book&#39;, &#39;year&#39;: 1894}
{&#39;title&#39;: &#39;The Pink Fairy Book&#39;, &#39;year&#39;: 1897}
{&#39;title&#39;: &#39;The Grey Fairy Book&#39;, &#39;year&#39;: 1900}
{&#39;title&#39;: &#39;The Violet Fairy Book&#39;, &#39;year&#39;: 1901}
{&#39;title&#39;: &#39;The Crimson Fairy Book&#39;, &#39;year&#39;: 1903}
{&#39;title&#39;: &#39;The Brown Fairy Book&#39;, &#39;year&#39;: 1904}
{&#39;title&#39;: &#39;The Orange Fairy Book&#39;, &#39;year&#39;: 1906}
{&#39;title&#39;: &#39;The Lilac Fairy Book&#39;, &#39;year&#39;: 1910}
{&#39;title&#39;: &#39;The Olive Fairy Book&#39;, &#39;year&#39;: 1910}
</pre></div>
</div>
</div>
</div>
<p>That looks a bit better.</p>
<p>How many stories do we now have with a king and three sons?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search on: </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">story</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;books&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">quote_fts</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;book&quot;</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">story</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Search on: king &quot;three sons&quot;

{&#39;title&#39;: &#39;The Three Brothers&#39;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
{&#39;title&#39;: &#39;The Princess Who Was Hidden Underground&#39;, &#39;book&#39;: &#39;The Violet Fairy Book&#39;}
{&#39;title&#39;: &#39;The Black Thief And Knight Of The Glen.&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;Blockhead-Hans&#39;, &#39;book&#39;: &#39;The Yellow Fairy Book&#39;}
{&#39;title&#39;: &#39;The Golden Lion&#39;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
{&#39;title&#39;: &#39;The Golden Goose&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;The Master Cat; Or, Puss In Boots&#39;, &#39;book&#39;: &#39;The Blue Fairy Book&#39;}
{&#39;title&#39;: &#39;The Enchanted Watch&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;The Story Of The Fair Circassians&#39;, &#39;book&#39;: &#39;The Grey Fairy Book&#39;}
{&#39;title&#39;: &#39;The Norka&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;Tritill, Litill, And The Birds&#39;, &#39;book&#39;: &#39;The Crimson Fairy Book&#39;}
{&#39;title&#39;: &#39;The Seven Foals&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;The Witch And Her Servants&#39;, &#39;book&#39;: &#39;The Yellow Fairy Book&#39;}
{&#39;title&#39;: &#39;The Flying Ship&#39;, &#39;book&#39;: &#39;The Yellow Fairy Book&#39;}
{&#39;title&#39;: &quot;How The Hermit Helped To Win The King&#39;s Daughter&quot;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
{&#39;title&#39;: &#39;The Prince And The Dragon&#39;, &#39;book&#39;: &#39;The Crimson Fairy Book&#39;}
{&#39;title&#39;: &#39;The Story Of Sigurd&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &quot;The Magician&#39;s Horse&quot;, &#39;book&#39;: &#39;The Grey Fairy Book&#39;}
{&#39;title&#39;: &quot;The Bird &#39;Grip&#39;&quot;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
{&#39;title&#39;: &#39;The Three Treasures Of The Giants&#39;, &#39;book&#39;: &#39;The Orange Fairy Book&#39;}
{&#39;title&#39;: &#39;The Golden Mermaid&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;Pinkel The Thief&#39;, &#39;book&#39;: &#39;The Orange Fairy Book&#39;}
{&#39;title&#39;: &#39;Jesper Who Herded The Hares&#39;, &#39;book&#39;: &#39;The Violet Fairy Book&#39;}
{&#39;title&#39;: &quot;Ian, The Soldier&#39;s Son&quot;, &#39;book&#39;: &#39;The Orange Fairy Book&#39;}
{&#39;title&#39;: &#39;The Story Of Ciccu&#39;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
{&#39;title&#39;: &#39;The White Cat&#39;, &#39;book&#39;: &#39;The Blue Fairy Book&#39;}
{&#39;title&#39;: &#39;The Story Of Prince Ahmed And The Fairy Paribanou&#39;, &#39;book&#39;: &#39;The Blue Fairy Book&#39;}
</pre></div>
</div>
</div>
</div>
<p>How about Jack stories?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">story</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;books&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;Jack&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;book&quot;</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">story</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;title&#39;: &#39;The History Of Jack The Giant-Killer&#39;, &#39;book&#39;: &#39;The Blue Fairy Book&#39;}
{&#39;title&#39;: &#39;Jack And The Beanstalk&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;Jack My Hedgehog&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;The Three Treasures Of The Giants&#39;, &#39;book&#39;: &#39;The Orange Fairy Book&#39;}
{&#39;title&#39;: &#39;Farmer Weatherbeard&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;The Shirt-Collar&#39;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
{&#39;title&#39;: &#39;To The Friendly Reader&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;Preface&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;Preface&#39;, &#39;book&#39;: &#39;The Orange Fairy Book&#39;}
{&#39;title&#39;: &#39;The Princess Mayblossom&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;Tale Of A Tortoise And Of A Mischievous Monkey&#39;, &#39;book&#39;: &#39;The Brown Fairy Book&#39;}
</pre></div>
</div>
</div>
</div>
<p>Ah… so maybe <em>Preface</em> is something we could also catch and exclude… And perhaps <em>To The Friendly Reader</em> as a special exception.</p>
<p>Or Hans?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">story</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;books&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;Hans&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;book&quot;</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">story</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;title&#39;: &quot;Hans, The Mermaid&#39;s Son&quot;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
{&#39;title&#39;: &#39;The Headless Dwarfs&#39;, &#39;book&#39;: &#39;The Violet Fairy Book&#39;}
{&#39;title&#39;: &#39;Blockhead-Hans&#39;, &#39;book&#39;: &#39;The Yellow Fairy Book&#39;}
{&#39;title&#39;: &#39;The Underground Workers&#39;, &#39;book&#39;: &#39;The Violet Fairy Book&#39;}
{&#39;title&#39;: &#39;The Magic Book&#39;, &#39;book&#39;: &#39;The Orange Fairy Book&#39;}
{&#39;title&#39;: &#39;Preface&#39;, &#39;book&#39;: &#39;The Yellow Fairy Book&#39;}
{&#39;title&#39;: &#39;The Shirt-Collar&#39;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
{&#39;title&#39;: &#39;The Goblin And The Grocer&#39;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
{&#39;title&#39;: &#39;The Flying Trunk&#39;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
{&#39;title&#39;: &#39;The Snow-Man&#39;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
{&#39;title&#39;: &#39;The Fir-Tree&#39;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
{&#39;title&#39;: &#39;The Daughter Of Buk Ettemsuch&#39;, &#39;book&#39;: &#39;The Grey Fairy Book&#39;}
{&#39;title&#39;: &#39;The Story Of Halfman&#39;, &#39;book&#39;: &#39;The Violet Fairy Book&#39;}
{&#39;title&#39;: &#39;Udea And Her Seven Brothers&#39;, &#39;book&#39;: &#39;The Grey Fairy Book&#39;}
{&#39;title&#39;: &#39;The Ugly Duckling&#39;, &#39;book&#39;: &#39;The Orange Fairy Book&#39;}
{&#39;title&#39;: &#39;The Snow-Queen&#39;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">story</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;books&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;donkey&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;book&quot;</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">story</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;title&#39;: &#39;The Street Musicians&#39;, &#39;book&#39;: &#39;The Grey Fairy Book&#39;}
{&#39;title&#39;: &#39;The Heart Of A Monkey&#39;, &#39;book&#39;: &#39;The Lilac Fairy Book&#39;}
{&#39;title&#39;: &#39;The Ogre&#39;, &#39;book&#39;: &#39;The Grey Fairy Book&#39;}
{&#39;title&#39;: &#39;The Cunning Shoemaker&#39;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
{&#39;title&#39;: &#39;Donkey Skin&#39;, &#39;book&#39;: &#39;The Grey Fairy Book&#39;}
{&#39;title&#39;: &#39;The Biter Bit&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;The Donkey Cabbage&#39;, &#39;book&#39;: &#39;The Yellow Fairy Book&#39;}
{&#39;title&#39;: &#39;The Stones Of Plouhinec&#39;, &#39;book&#39;: &#39;The Lilac Fairy Book&#39;}
{&#39;title&#39;: &#39;The Colony Of Cats&#39;, &#39;book&#39;: &#39;The Crimson Fairy Book&#39;}
{&#39;title&#39;: &#39;The Prince And The Three Fates&#39;, &#39;book&#39;: &#39;The Brown Fairy Book&#39;}
{&#39;title&#39;: &#39;Story Of The King Who Would Be Stronger Than Fate&#39;, &#39;book&#39;: &#39;The Brown Fairy Book&#39;}
{&#39;title&#39;: &#39;The Story Of Hassebu&#39;, &#39;book&#39;: &#39;The Violet Fairy Book&#39;}
{&#39;title&#39;: &#39;The Nunda, Eater Of People&#39;, &#39;book&#39;: &#39;The Violet Fairy Book&#39;}
{&#39;title&#39;: &#39;Preface&#39;, &#39;book&#39;: &#39;The Yellow Fairy Book&#39;}
{&#39;title&#39;: &#39;A French Puck&#39;, &#39;book&#39;: &#39;The Lilac Fairy Book&#39;}
{&#39;title&#39;: &#39;The Simpleton&#39;, &#39;book&#39;: &#39;The Grey Fairy Book&#39;}
{&#39;title&#39;: &#39;The Goat-Faced Girl&#39;, &#39;book&#39;: &#39;The Grey Fairy Book&#39;}
{&#39;title&#39;: &#39;The Story Of Dschemil And Dschemila&#39;, &#39;book&#39;: &#39;The Grey Fairy Book&#39;}
{&#39;title&#39;: &#39;Hansel And Grettel&#39;, &#39;book&#39;: &#39;The Blue Fairy Book&#39;}
{&#39;title&#39;: &quot;Geirlaug The King&#39;s Daughter&quot;, &#39;book&#39;: &#39;The Olive Fairy Book&#39;}
{&#39;title&#39;: &#39;The Enchanted Canary&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;The Yellow Dwarf&#39;, &#39;book&#39;: &#39;The Blue Fairy Book&#39;}
{&#39;title&#39;: &#39;Heart Of Ice&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
</pre></div>
</div>
</div>
</div>
<p>We can also run explicit SQL queries over the database. For example, how do some of the stories start?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;SELECT first_line FROM books LIMIT 5&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;first_line&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Once upon a time in a certain country there lived a king whose palace was surrounded by a spacious garden.
Once upon a time there lived a king who was deeply in love with a princess, but she could not marry anyone, because she was under an enchantment.
Once upon a time there was a poor husbandman who had many children and little to give them in the way either of food or clothing.
Once upon a time there lived a queen who had been the mother of a great many children, and of them all only one daughter was left.
Once upon a time there lived in a certain village a little country girl, the prettiest creature was ever seen.
</pre></div>
</div>
</div>
</div>
<p>I seem to recall there may have been some sources at the end of some texts? A quick text for that is to see if there is any mention of <code class="docutils literal notranslate"><span class="pre">Grimm</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">story</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;books&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;Grimm&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;book&quot;</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">story</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;title&#39;: &#39;Preface&#39;, &#39;book&#39;: &#39;The Crimson Fairy Book&#39;}
{&#39;title&#39;: &#39;The Three Brothers&#39;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
{&#39;title&#39;: &#39;To The Friendly Reader&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;Jorinde And Joringel&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;Spindle, Shuttle, And Needle&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;The Marvellous Musician&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;Rumpelstiltzkin&#39;, &#39;book&#39;: &#39;The Blue Fairy Book&#39;}
{&#39;title&#39;: &#39;The Twelve Huntsmen&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;The Riddle&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;Mother Holle&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;The Story Of A Clever Tailor&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;The Three Snake-Leaves&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;The War Of The Wolf And The Fox&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;Rapunzel&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;The White Snake&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;The House In The Wood&#39;, &#39;book&#39;: &#39;The Pink Fairy Book&#39;}
{&#39;title&#39;: &#39;The Golden Goose&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;The Three Dogs&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;The Twelve Brothers&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;The Iron Stove&#39;, &#39;book&#39;: &#39;The Yellow Fairy Book&#39;}
{&#39;title&#39;: &#39;The Golden Lads&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;The Three Dwarfs&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;Jack My Hedgehog&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;The Crystal Coffin&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;Allerleirauh; Or, The Many-Furred Creature&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;The Goose-Girl&#39;, &#39;book&#39;: &#39;The Blue Fairy Book&#39;}
{&#39;title&#39;: &#39;The Three Musicians&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;Snow-White And Rose-Red&#39;, &#39;book&#39;: &#39;The Blue Fairy Book&#39;}
{&#39;title&#39;: &#39;Brother And Sister&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;Little One-Eye, Little Two-Eyes, And Little Three-Eyes&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;Hansel And Grettel&#39;, &#39;book&#39;: &#39;The Blue Fairy Book&#39;}
{&#39;title&#39;: &#39;The Story Of The Fisherman And His Wife&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;Trusty John&#39;, &#39;book&#39;: &#39;The Blue Fairy Book&#39;}
{&#39;title&#39;: &#39;Snowdrop&#39;, &#39;book&#39;: &#39;The Red Fairy Book&#39;}
{&#39;title&#39;: &#39;The Golden Mermaid&#39;, &#39;book&#39;: &#39;The Green Fairy Book&#39;}
{&#39;title&#39;: &#39;The Tale Of A Youth Who Set Out To Learn What Fear Was&#39;, &#39;book&#39;: &#39;The Blue Fairy Book&#39;}
</pre></div>
</div>
</div>
</div>
<p>Okay, so let’s check the end of one of those:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;SELECT last_para FROM books WHERE text LIKE &quot;</span><span class="si">%G</span><span class="s1">rimm%&quot;&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;last_para&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">200</span><span class="p">:])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] Grimm.
[1] Grimm.
[1] Grimm.
[1] Grimm.
[1] Grimm.
[1] Grimm.
ut them up in the cellar, but in the morning they shall be led forth into the forest and shall serve a charcoal burner until they have improved, and will never again suffer poor animals to go hungry.&#39;
 ill and died the two others were so deeply grieved that they were also taken ill and died too. And so, because they had all been so clever, and so fond of each other, they were all laid in one grave.
 and Mrs. Skovgaard-Pedersen has done &#39;The Green Knight&#39; from the Danish. I must especially thank Monsieur Macler for permitting us to use some of his Contes Armeniens (Paris: Ernest Leroux, Editeur).
^32:1 Grimm.
ffer in colour; language, religion, and almost everything else; but they all love a nursery tale. The stories have mainly been adapted or translated by Mrs. Lang, a few by Miss Lang and Miss Blackley.
ill not be dull. So good-bye, and when you have read a fairy book, lend it to other children who have none, or tell them the stories in your own way, which is a very pleasant mode of passing the time.
Grimm.
Grimm.
Grimm.
Grimm.
Grimm.
Grimm.
Grimm.
Grimm.
Grimm.
Grimm.
Grimm.
Grimm.
Grimm.
Grimm.
Grimm.
Grimm.
Grimm.
[6] Grimm.
[19] Grimm.
[22] Grimm.
[23] Grimm.
[26] Grimm.
[29] Grimm.
[30] Grimm.
[32] Grimm.
</pre></div>
</div>
</div>
</div>
<p>How about some stories that don’t reference Grimm?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This query was used to help iterate the regular expressions used to extract the provenance</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;SELECT last_para, provenance FROM books WHERE text NOT LIKE &quot;</span><span class="si">%G</span><span class="s1">rimm%&quot; LIMIT 10&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;provenance&quot;</span><span class="p">],</span><span class="s2">&quot;::&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;last_para&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">200</span><span class="p">:])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traditions Populaires de l&#39;Asie Mineure. Carnoy et Nicolaides. Paris: Maisonneuve, 1889. :: [1] Traditions Populaires de l&#39;Asie Mineure. Carnoy et Nicolaides. Paris: Maisonneuve, 1889.
Le Prince Desir et la Princesse Mignonne. Par Madame Leprince de Beaumont. :: [1] Le Prince Desir et la Princesse Mignonne. Par Madame Leprince de Beaumont.
Asbjornsen and Moe. :: [1] Asbjornsen and Moe.
Madame d&#39;Aulnoy. :: [1] Madame d&#39;Aulnoy.
 :: And, saying these words, this wicked wolf fell upon Little Red Riding-Hood, and ate her all up.
 ::  creatures she had ordered to be thrown into it for others. The King could not but be very sorry, for she was his mother; but he soon comforted himself with his beautiful wife and his pretty children.
Charles Perrault. :: [1] Charles Perrault.
Arabian Nights. :: [1] Arabian Nights.
La Belle et la Bete. Par Madame de Villeneuve. :: [1] La Belle et la Bete. Par Madame de Villeneuve.
Asbjornsen and Moe. :: [1] Asbjornsen and Moe.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;SELECT DISTINCT provenance, COUNT(*) AS num FROM books GROUP BY provenance ORDER BY num DESC LIMIT 10&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;provenance&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>126 
31 Grimm.
5 Lapplandische Mahrchen.
5 Japanische Marchen.
5 From &#39;West Highland Tales.&#39;
5 Ehstnische Marchen.
5 Charles Perrault.
4 Volksmarchen der Serben.
4 Madame d&#39;Aulnoy.
4 From Ungarische Mahrchen.
</pre></div>
</div>
</div>
</div>
<p>Hmm.. it seemed like there were more mentions of Grimm than that?</p>
</div>
<div class="section" id="making-pandas-based-database-queries">
<h2>Making <em>pandas</em> based Database Queries<a class="headerlink" href="#making-pandas-based-database-queries" title="Permalink to this headline">¶</a></h2>
<p>For convenience, let’s set up a database connection so we can easily run <em>pandas</em> mediated queries:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="entity-extraction">
<h2>Entity Extraction…<a class="headerlink" href="#entity-extraction" title="Permalink to this headline">¶</a></h2>
<p>So what entities can we find in the stories…?!</p>
<p>Let’s load in the <code class="docutils literal notranslate"><span class="pre">spacy</span></code> natural language processing toolkit:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#%pip install --upgrade spacy</span>
<span class="kn">import</span> <span class="nn">spacy</span>
<span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;en_core_web_sm&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Get a dataframe of data frm the database:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM books&quot;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s have a go at extracting some entities:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract a set of entities, rather than a list...</span>
<span class="n">get_entities</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">desc</span><span class="p">:</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">label_</span><span class="si">}</span><span class="s2"> :: </span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">nlp</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span><span class="o">.</span><span class="n">ents</span><span class="p">}</span>

<span class="c1"># The full run takes some time....</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;entities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_entities</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><em>We should probably just do this once and add an appropriate table of entities to the database…</em></p>
<p>We can explode these out into a long format dataframe:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">Series</span>

<span class="c1"># Explode the entities one per row...</span>
<span class="n">df_long</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s1">&#39;entities&#39;</span><span class="p">)</span>
<span class="n">df_long</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;entities&quot;</span><span class="p">:</span><span class="s2">&quot;entity&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># And then separate out entity type and value</span>
<span class="n">df_long</span><span class="p">[[</span><span class="s2">&quot;entity_typ&quot;</span><span class="p">,</span> <span class="s2">&quot;entity_value&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; :: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">Series</span><span class="p">)</span>
<span class="n">df_long</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>And explore…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;entity_typ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>What sort of money has been identified in the stories?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_long</span><span class="p">[</span><span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;entity_typ&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;MONEY&quot;</span><span class="p">][</span><span class="s2">&quot;entity_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Dollars? Really??? What about gold coins?! Do I need to train a new classifier?! Or was the original text really like that… Or has the text been got at? <em>(Maybe I should do my own digitisation project to extract the text from copies of the original books on the Internet Archive? Hmmm.. that could be interesting for when we go on strike…)</em></p>
<p>What about other quantities?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_long</span><span class="p">[</span><span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;entity_typ&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;QUANTITY&quot;</span><span class="p">][</span><span class="s2">&quot;entity_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>What people have been identified?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_long</span><span class="p">[</span><span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;entity_typ&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;PERSON&quot;</span><span class="p">][</span><span class="s2">&quot;entity_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>How about geo-political entities (GPEs)?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_long</span><span class="p">[</span><span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;entity_typ&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;GPE&quot;</span><span class="p">][</span><span class="s2">&quot;entity_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>When did things happen?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_long</span><span class="p">[</span><span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;entity_typ&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;DATE&quot;</span><span class="p">][</span><span class="s2">&quot;entity_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And how about time considerations?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_long</span><span class="p">[</span><span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;entity_typ&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;TIME&quot;</span><span class="p">][</span><span class="s2">&quot;entity_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>How were things organised?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_long</span><span class="p">[</span><span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;entity_typ&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;ORG&quot;</span><span class="p">][</span><span class="s2">&quot;entity_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>What’s a <code class="docutils literal notranslate"><span class="pre">NORP</span></code>? (Ah… <em>Nationalities Or Religious or Political groups.)</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_long</span><span class="p">[</span><span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;entity_typ&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;NORP&quot;</span><span class="p">][</span><span class="s2">&quot;entity_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="add-wikipedia-links">
<h2>Add Wikipedia Links<a class="headerlink" href="#add-wikipedia-links" title="Permalink to this headline">¶</a></h2>
<p>The Wikipedia page <a class="reference external" href="https://en.wikipedia.org/wiki/Lang%27s_Fairy_Books"><code class="docutils literal notranslate"><span class="pre">Lang's_Fairy_Books</span></code></a> lists the contents of Lang’s coloured fairy books (as well as several other books), along with links to the Wikipedia page associated with each tale, if available.</p>
<p>This means we can have a go at annotating our database with Wikipedia links for each story. From those pages in turn, or associated <em>DBpedia</em> pages, we might also be able to extract Aarne-Thompson classification codes for the corresponding stories.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://en.wikipedia.org/wiki/Lang&#39;s_Fairy_Books&quot;</span>

<span class="n">html</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="n">wp_soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find the span for a particular book</span>
<span class="n">wp_book_loc</span> <span class="o">=</span>  <span class="n">wp_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;The_Blue_Fairy_Book_(1889)&quot;</span><span class="p">)</span>

<span class="c1"># Then navigate relative to this to get the (linked) story list</span>
<span class="n">wp_book_stories</span> <span class="o">=</span> <span class="n">wp_book_loc</span><span class="o">.</span><span class="n">find_parent</span><span class="p">()</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="s2">&quot;ul&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">)</span>
<span class="n">wp_book_stories</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;li&gt;&quot;&lt;a href=&quot;/wiki/The_Bronze_Ring&quot; title=&quot;The Bronze Ring&quot;&gt;The Bronze Ring&lt;/a&gt;&quot;&lt;/li&gt;,
 &lt;li&gt;&quot;&lt;a href=&quot;/wiki/Prince_Hyacinth_and_the_Dear_Little_Princess&quot; title=&quot;Prince Hyacinth and the Dear Little Princess&quot;&gt;Prince Hyacinth and the Dear Little Princess&lt;/a&gt;&quot;&lt;/li&gt;,
 &lt;li&gt;&quot;&lt;a href=&quot;/wiki/East_of_the_Sun_and_West_of_the_Moon&quot; title=&quot;East of the Sun and West of the Moon&quot;&gt;East of the Sun and West of the Moon&lt;/a&gt;&quot;&lt;/li&gt;]
</pre></div>
</div>
</div>
</div>
<p>Get the Wikipedia path for stories with a Wikipedia page:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wp_book_paths</span> <span class="o">=</span> <span class="p">[(</span><span class="n">li</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">),</span> <span class="n">li</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">wp_book_stories</span><span class="p">]</span>

<span class="n">wp_book_paths</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;The Bronze Ring&#39;, &#39;/wiki/The_Bronze_Ring&#39;),
 (&#39;Prince Hyacinth and the Dear Little Princess&#39;,
  &#39;/wiki/Prince_Hyacinth_and_the_Dear_Little_Princess&#39;),
 (&#39;East of the Sun and West of the Moon&#39;,
  &#39;/wiki/East_of_the_Sun_and_West_of_the_Moon&#39;)]
</pre></div>
</div>
</div>
</div>
<p>Useful as a list of <code class="docutils literal notranslate"><span class="pre">dict</span></code>s or <em>pandas</em> <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">wp_book_paths_wide</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">wp_book_paths</span><span class="p">:</span>
    <span class="n">wp_book_paths_wide</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span> <span class="p">)</span>
    
<span class="n">wp_book_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">wp_book_paths_wide</span><span class="p">)</span>
<span class="n">wp_book_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>path</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>The Bronze Ring</td>
      <td>/wiki/The_Bronze_Ring</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Prince Hyacinth and the Dear Little Princess</td>
      <td>/wiki/Prince_Hyacinth_and_the_Dear_Little_Prin...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>East of the Sun and West of the Moon</td>
      <td>/wiki/East_of_the_Sun_and_West_of_the_Moon</td>
    </tr>
    <tr>
      <th>3</th>
      <td>The Yellow Dwarf</td>
      <td>/wiki/The_Yellow_Dwarf</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Little Red Riding Hood</td>
      <td>/wiki/Little_Red_Riding_Hood</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Sleeping Beauty</td>
      <td>/wiki/Sleeping_Beauty</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Cinderella</td>
      <td>/wiki/Cinderella</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Aladdin</td>
      <td>/wiki/Aladdin</td>
    </tr>
    <tr>
      <th>8</th>
      <td>The Story of the Youth Who Went Forth to Learn...</td>
      <td>/wiki/The_Story_of_the_Youth_Who_Went_Forth_to...</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Rumpelstiltskin</td>
      <td>/wiki/Rumpelstiltskin</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Beauty and the Beast</td>
      <td>/wiki/Beauty_and_the_Beast</td>
    </tr>
    <tr>
      <th>11</th>
      <td>The Master Maid</td>
      <td>/wiki/The_Master_Maid</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Why the Sea Is Salt</td>
      <td>/wiki/Why_the_Sea_Is_Salt</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Puss in Boots</td>
      <td>/wiki/Puss_in_Boots</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Felicia and the Pot of Pinks</td>
      <td>/wiki/Felicia_and_the_Pot_of_Pinks</td>
    </tr>
    <tr>
      <th>15</th>
      <td>The White Cat (fairy tale)</td>
      <td>/wiki/The_White_Cat_(fairy_tale)</td>
    </tr>
    <tr>
      <th>16</th>
      <td>The Water-lily. The Gold-spinners</td>
      <td>/wiki/The_Water-lily._The_Gold-spinners</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Perseus</td>
      <td>/wiki/Perseus</td>
    </tr>
    <tr>
      <th>18</th>
      <td>The Story of Pretty Goldilocks</td>
      <td>/wiki/The_Story_of_Pretty_Goldilocks</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Dick Whittington</td>
      <td>/wiki/Dick_Whittington</td>
    </tr>
    <tr>
      <th>20</th>
      <td>The Wonderful Sheep</td>
      <td>/wiki/The_Wonderful_Sheep</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Hop o' My Thumb</td>
      <td>/wiki/Hop_o%27_My_Thumb</td>
    </tr>
    <tr>
      <th>22</th>
      <td>Ali Baba</td>
      <td>/wiki/Ali_Baba</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Hansel and Gretel</td>
      <td>/wiki/Hansel_and_Gretel</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Snow-White and Rose-Red</td>
      <td>/wiki/Snow-White_and_Rose-Red</td>
    </tr>
    <tr>
      <th>25</th>
      <td>The Goose Girl</td>
      <td>/wiki/The_Goose_Girl</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Diamonds and Toads</td>
      <td>/wiki/Diamonds_and_Toads</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Prince Darling</td>
      <td>/wiki/Prince_Darling</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Bluebeard</td>
      <td>/wiki/Bluebeard</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Trusty John</td>
      <td>/wiki/Trusty_John</td>
    </tr>
    <tr>
      <th>30</th>
      <td>The Valiant Little Tailor</td>
      <td>/wiki/The_Valiant_Little_Tailor</td>
    </tr>
    <tr>
      <th>31</th>
      <td>Gulliver's Travels</td>
      <td>/wiki/Gulliver%27s_Travels#Part_I:_A_Voyage_to...</td>
    </tr>
    <tr>
      <th>32</th>
      <td>The Princess on the Glass Hill</td>
      <td>/wiki/The_Princess_on_the_Glass_Hill</td>
    </tr>
    <tr>
      <th>33</th>
      <td>Ahmed (Arabian Nights)</td>
      <td>/wiki/Ahmed_(Arabian_Nights)</td>
    </tr>
    <tr>
      <th>34</th>
      <td>Jack the Giant Killer</td>
      <td>/wiki/Jack_the_Giant_Killer</td>
    </tr>
    <tr>
      <th>35</th>
      <td>The Black Bull of Norroway</td>
      <td>/wiki/The_Black_Bull_of_Norroway</td>
    </tr>
    <tr>
      <th>36</th>
      <td>The Red Ettin</td>
      <td>/wiki/The_Red_Ettin</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>See if we can then cross reference these with stories in the database?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;SELECT book, title, chapter_order FROM books WHERE book=&#39;The Blue Fairy Book&#39; ORDER BY chapter_order ASC&quot;</span>
<span class="n">df_blue</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>

<span class="n">df_blue</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>book</th>
      <th>title</th>
      <th>chapter_order</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>The Blue Fairy Book</td>
      <td>The Bronze Ring</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>The Blue Fairy Book</td>
      <td>Prince Hyacinth And The Dear Little Princess</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>The Blue Fairy Book</td>
      <td>East Of The Sun And West Of The Moon</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>The Blue Fairy Book</td>
      <td>The Yellow Dwarf</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>The Blue Fairy Book</td>
      <td>Little Red Riding Hood</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let’s see if the chapters align in terms of order as presented:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;book&quot;</span><span class="p">:</span><span class="n">df_blue</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="s2">&quot;wp&quot;</span><span class="p">:</span><span class="n">wp_book_df</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="s2">&quot;wp_path&quot;</span><span class="p">:</span><span class="n">wp_book_df</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>book</th>
      <th>wp</th>
      <th>wp_path</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>The Bronze Ring</td>
      <td>The Bronze Ring</td>
      <td>/wiki/The_Bronze_Ring</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Prince Hyacinth And The Dear Little Princess</td>
      <td>Prince Hyacinth and the Dear Little Princess</td>
      <td>/wiki/Prince_Hyacinth_and_the_Dear_Little_Prin...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>East Of The Sun And West Of The Moon</td>
      <td>East of the Sun and West of the Moon</td>
      <td>/wiki/East_of_the_Sun_and_West_of_the_Moon</td>
    </tr>
    <tr>
      <th>3</th>
      <td>The Yellow Dwarf</td>
      <td>The Yellow Dwarf</td>
      <td>/wiki/The_Yellow_Dwarf</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Little Red Riding Hood</td>
      <td>Little Red Riding Hood</td>
      <td>/wiki/Little_Red_Riding_Hood</td>
    </tr>
    <tr>
      <th>5</th>
      <td>The Sleeping Beauty In The Wood</td>
      <td>Sleeping Beauty</td>
      <td>/wiki/Sleeping_Beauty</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Cinderella, Or The Little Glass Slipper</td>
      <td>Cinderella</td>
      <td>/wiki/Cinderella</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Aladdin And The Wonderful Lamp</td>
      <td>Aladdin</td>
      <td>/wiki/Aladdin</td>
    </tr>
    <tr>
      <th>8</th>
      <td>The Tale Of A Youth Who Set Out To Learn What ...</td>
      <td>The Story of the Youth Who Went Forth to Learn...</td>
      <td>/wiki/The_Story_of_the_Youth_Who_Went_Forth_to...</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Rumpelstiltzkin</td>
      <td>Rumpelstiltskin</td>
      <td>/wiki/Rumpelstiltskin</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Beauty And The Beast</td>
      <td>Beauty and the Beast</td>
      <td>/wiki/Beauty_and_the_Beast</td>
    </tr>
    <tr>
      <th>11</th>
      <td>The Master-Maid</td>
      <td>The Master Maid</td>
      <td>/wiki/The_Master_Maid</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Why The Sea Is Salt</td>
      <td>Why the Sea Is Salt</td>
      <td>/wiki/Why_the_Sea_Is_Salt</td>
    </tr>
    <tr>
      <th>13</th>
      <td>The Master Cat; Or, Puss In Boots</td>
      <td>Puss in Boots</td>
      <td>/wiki/Puss_in_Boots</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Felicia And The Pot Of Pinks</td>
      <td>Felicia and the Pot of Pinks</td>
      <td>/wiki/Felicia_and_the_Pot_of_Pinks</td>
    </tr>
    <tr>
      <th>15</th>
      <td>The White Cat</td>
      <td>The White Cat (fairy tale)</td>
      <td>/wiki/The_White_Cat_(fairy_tale)</td>
    </tr>
    <tr>
      <th>16</th>
      <td>The Water-Lily. The Gold-Spinners</td>
      <td>The Water-lily. The Gold-spinners</td>
      <td>/wiki/The_Water-lily._The_Gold-spinners</td>
    </tr>
    <tr>
      <th>17</th>
      <td>The Terrible Head</td>
      <td>Perseus</td>
      <td>/wiki/Perseus</td>
    </tr>
    <tr>
      <th>18</th>
      <td>The Story Of Pretty Goldilocks</td>
      <td>The Story of Pretty Goldilocks</td>
      <td>/wiki/The_Story_of_Pretty_Goldilocks</td>
    </tr>
    <tr>
      <th>19</th>
      <td>The History Of Whittington</td>
      <td>Dick Whittington</td>
      <td>/wiki/Dick_Whittington</td>
    </tr>
    <tr>
      <th>20</th>
      <td>The Wonderful Sheep</td>
      <td>The Wonderful Sheep</td>
      <td>/wiki/The_Wonderful_Sheep</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Little Thumb</td>
      <td>Hop o' My Thumb</td>
      <td>/wiki/Hop_o%27_My_Thumb</td>
    </tr>
    <tr>
      <th>22</th>
      <td>The Forty Thieves</td>
      <td>Ali Baba</td>
      <td>/wiki/Ali_Baba</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Hansel And Grettel</td>
      <td>Hansel and Gretel</td>
      <td>/wiki/Hansel_and_Gretel</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Snow-White And Rose-Red</td>
      <td>Snow-White and Rose-Red</td>
      <td>/wiki/Snow-White_and_Rose-Red</td>
    </tr>
    <tr>
      <th>25</th>
      <td>The Goose-Girl</td>
      <td>The Goose Girl</td>
      <td>/wiki/The_Goose_Girl</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Toads And Diamonds</td>
      <td>Diamonds and Toads</td>
      <td>/wiki/Diamonds_and_Toads</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Prince Darling</td>
      <td>Prince Darling</td>
      <td>/wiki/Prince_Darling</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Blue Beard</td>
      <td>Bluebeard</td>
      <td>/wiki/Bluebeard</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Trusty John</td>
      <td>Trusty John</td>
      <td>/wiki/Trusty_John</td>
    </tr>
    <tr>
      <th>30</th>
      <td>The Brave Little Tailor</td>
      <td>The Valiant Little Tailor</td>
      <td>/wiki/The_Valiant_Little_Tailor</td>
    </tr>
    <tr>
      <th>31</th>
      <td>A Voyage To Lilliput</td>
      <td>Gulliver's Travels</td>
      <td>/wiki/Gulliver%27s_Travels#Part_I:_A_Voyage_to...</td>
    </tr>
    <tr>
      <th>32</th>
      <td>The Princess On The Glass Hill</td>
      <td>The Princess on the Glass Hill</td>
      <td>/wiki/The_Princess_on_the_Glass_Hill</td>
    </tr>
    <tr>
      <th>33</th>
      <td>The Story Of Prince Ahmed And The Fairy Paribanou</td>
      <td>Ahmed (Arabian Nights)</td>
      <td>/wiki/Ahmed_(Arabian_Nights)</td>
    </tr>
    <tr>
      <th>34</th>
      <td>The History Of Jack The Giant-Killer</td>
      <td>Jack the Giant Killer</td>
      <td>/wiki/Jack_the_Giant_Killer</td>
    </tr>
    <tr>
      <th>35</th>
      <td>The Black Bull Of Norroway</td>
      <td>The Black Bull of Norroway</td>
      <td>/wiki/The_Black_Bull_of_Norroway</td>
    </tr>
    <tr>
      <th>36</th>
      <td>The Red Etin</td>
      <td>The Red Ettin</td>
      <td>/wiki/The_Red_Ettin</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Yes, they do so we can use that as a basis of a merge. That said, in the genral case it would probably also be useful to generate a fuzzy match score between matched titles with a report on any low scoring matches, just in case the alignment has gone awry.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TO DO  - wp table for links, story and story order?</span>
<span class="c1"># TO DO fuzzy match score test just to check ingest and allow user to check poor matches</span>
</pre></div>
</div>
</div>
</div>
<p>In passing,what if we wanted to try to match on the titles themselves?</p>
<p>If we use decased, but otherwise exact, matching, we see it’s bit flaky….</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_blue</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="n">wp_book_df</span><span class="p">,</span>
         <span class="n">left_on</span><span class="o">=</span><span class="n">df_blue</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
         <span class="n">right_on</span><span class="o">=</span><span class="n">wp_book_df</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
         <span class="n">how</span> <span class="o">=</span><span class="s2">&quot;left&quot;</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key_0</th>
      <th>title_x</th>
      <th>title_y</th>
      <th>path</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>the bronze ring</td>
      <td>The Bronze Ring</td>
      <td>The Bronze Ring</td>
      <td>/wiki/The_Bronze_Ring</td>
    </tr>
    <tr>
      <th>1</th>
      <td>prince hyacinth and the dear little princess</td>
      <td>Prince Hyacinth And The Dear Little Princess</td>
      <td>Prince Hyacinth and the Dear Little Princess</td>
      <td>/wiki/Prince_Hyacinth_and_the_Dear_Little_Prin...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>east of the sun and west of the moon</td>
      <td>East Of The Sun And West Of The Moon</td>
      <td>East of the Sun and West of the Moon</td>
      <td>/wiki/East_of_the_Sun_and_West_of_the_Moon</td>
    </tr>
    <tr>
      <th>3</th>
      <td>the yellow dwarf</td>
      <td>The Yellow Dwarf</td>
      <td>The Yellow Dwarf</td>
      <td>/wiki/The_Yellow_Dwarf</td>
    </tr>
    <tr>
      <th>4</th>
      <td>little red riding hood</td>
      <td>Little Red Riding Hood</td>
      <td>Little Red Riding Hood</td>
      <td>/wiki/Little_Red_Riding_Hood</td>
    </tr>
    <tr>
      <th>5</th>
      <td>the sleeping beauty in the wood</td>
      <td>The Sleeping Beauty In The Wood</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6</th>
      <td>cinderella, or the little glass slipper</td>
      <td>Cinderella, Or The Little Glass Slipper</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7</th>
      <td>aladdin and the wonderful lamp</td>
      <td>Aladdin And The Wonderful Lamp</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>8</th>
      <td>the tale of a youth who set out to learn what ...</td>
      <td>The Tale Of A Youth Who Set Out To Learn What ...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>9</th>
      <td>rumpelstiltzkin</td>
      <td>Rumpelstiltzkin</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>10</th>
      <td>beauty and the beast</td>
      <td>Beauty And The Beast</td>
      <td>Beauty and the Beast</td>
      <td>/wiki/Beauty_and_the_Beast</td>
    </tr>
    <tr>
      <th>11</th>
      <td>the master-maid</td>
      <td>The Master-Maid</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>12</th>
      <td>why the sea is salt</td>
      <td>Why The Sea Is Salt</td>
      <td>Why the Sea Is Salt</td>
      <td>/wiki/Why_the_Sea_Is_Salt</td>
    </tr>
    <tr>
      <th>13</th>
      <td>the master cat; or, puss in boots</td>
      <td>The Master Cat; Or, Puss In Boots</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>14</th>
      <td>felicia and the pot of pinks</td>
      <td>Felicia And The Pot Of Pinks</td>
      <td>Felicia and the Pot of Pinks</td>
      <td>/wiki/Felicia_and_the_Pot_of_Pinks</td>
    </tr>
    <tr>
      <th>15</th>
      <td>the white cat</td>
      <td>The White Cat</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>16</th>
      <td>the water-lily. the gold-spinners</td>
      <td>The Water-Lily. The Gold-Spinners</td>
      <td>The Water-lily. The Gold-spinners</td>
      <td>/wiki/The_Water-lily._The_Gold-spinners</td>
    </tr>
    <tr>
      <th>17</th>
      <td>the terrible head</td>
      <td>The Terrible Head</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>18</th>
      <td>the story of pretty goldilocks</td>
      <td>The Story Of Pretty Goldilocks</td>
      <td>The Story of Pretty Goldilocks</td>
      <td>/wiki/The_Story_of_Pretty_Goldilocks</td>
    </tr>
    <tr>
      <th>19</th>
      <td>the history of whittington</td>
      <td>The History Of Whittington</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>20</th>
      <td>the wonderful sheep</td>
      <td>The Wonderful Sheep</td>
      <td>The Wonderful Sheep</td>
      <td>/wiki/The_Wonderful_Sheep</td>
    </tr>
    <tr>
      <th>21</th>
      <td>little thumb</td>
      <td>Little Thumb</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>22</th>
      <td>the forty thieves</td>
      <td>The Forty Thieves</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>23</th>
      <td>hansel and grettel</td>
      <td>Hansel And Grettel</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>24</th>
      <td>snow-white and rose-red</td>
      <td>Snow-White And Rose-Red</td>
      <td>Snow-White and Rose-Red</td>
      <td>/wiki/Snow-White_and_Rose-Red</td>
    </tr>
    <tr>
      <th>25</th>
      <td>the goose-girl</td>
      <td>The Goose-Girl</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>26</th>
      <td>toads and diamonds</td>
      <td>Toads And Diamonds</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>27</th>
      <td>prince darling</td>
      <td>Prince Darling</td>
      <td>Prince Darling</td>
      <td>/wiki/Prince_Darling</td>
    </tr>
    <tr>
      <th>28</th>
      <td>blue beard</td>
      <td>Blue Beard</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>29</th>
      <td>trusty john</td>
      <td>Trusty John</td>
      <td>Trusty John</td>
      <td>/wiki/Trusty_John</td>
    </tr>
    <tr>
      <th>30</th>
      <td>the brave little tailor</td>
      <td>The Brave Little Tailor</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>31</th>
      <td>a voyage to lilliput</td>
      <td>A Voyage To Lilliput</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>32</th>
      <td>the princess on the glass hill</td>
      <td>The Princess On The Glass Hill</td>
      <td>The Princess on the Glass Hill</td>
      <td>/wiki/The_Princess_on_the_Glass_Hill</td>
    </tr>
    <tr>
      <th>33</th>
      <td>the story of prince ahmed and the fairy paribanou</td>
      <td>The Story Of Prince Ahmed And The Fairy Paribanou</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>34</th>
      <td>the history of jack the giant-killer</td>
      <td>The History Of Jack The Giant-Killer</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>35</th>
      <td>the black bull of norroway</td>
      <td>The Black Bull Of Norroway</td>
      <td>The Black Bull of Norroway</td>
      <td>/wiki/The_Black_Bull_of_Norroway</td>
    </tr>
    <tr>
      <th>36</th>
      <td>the red etin</td>
      <td>The Red Etin</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>A fuzzy match might be able to improve things…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reused from on https://stackoverflow.com/a/56315491/454773</span>
<span class="kn">from</span> <span class="nn">fuzzywuzzy</span> <span class="kn">import</span> <span class="n">fuzz</span>
<span class="kn">from</span> <span class="nn">fuzzywuzzy</span> <span class="kn">import</span> <span class="n">process</span>

<span class="k">def</span> <span class="nf">fuzzy_merge</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param df_1: the left table to join</span>
<span class="sd">    :param df_2: the right table to join</span>
<span class="sd">    :param key1: key column of the left table</span>
<span class="sd">    :param key2: key column of the right table</span>
<span class="sd">    :param threshold: how close the matches should be to return a match, based on Levenshtein distance</span>
<span class="sd">    :param limit: the amount of matches that will get returned, these are sorted high to low</span>
<span class="sd">    :return: dataframe with boths keys and matches</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="n">key2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="n">m</span> <span class="o">=</span> <span class="n">df_1</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">process</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">))</span>  
    <span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;matches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
    
    <span class="n">m2</span> <span class="o">=</span> <span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;matches&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">]))</span>
    <span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;matches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m2</span>
    <span class="k">return</span> <span class="n">df_1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fuzzy_merge</span><span class="p">(</span><span class="n">df_blue</span><span class="p">,</span> <span class="n">wp_book_df</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;matches&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>matches</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>The Bronze Ring</td>
      <td>The Bronze Ring</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Prince Hyacinth And The Dear Little Princess</td>
      <td>Prince Hyacinth and the Dear Little Princess</td>
    </tr>
    <tr>
      <th>2</th>
      <td>East Of The Sun And West Of The Moon</td>
      <td>East of the Sun and West of the Moon</td>
    </tr>
    <tr>
      <th>3</th>
      <td>The Yellow Dwarf</td>
      <td>The Yellow Dwarf</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Little Red Riding Hood</td>
      <td>Little Red Riding Hood</td>
    </tr>
    <tr>
      <th>5</th>
      <td>The Sleeping Beauty In The Wood</td>
      <td>Sleeping Beauty</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Cinderella, Or The Little Glass Slipper</td>
      <td>Cinderella</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Aladdin And The Wonderful Lamp</td>
      <td>Aladdin</td>
    </tr>
    <tr>
      <th>8</th>
      <td>The Tale Of A Youth Who Set Out To Learn What ...</td>
      <td></td>
    </tr>
    <tr>
      <th>9</th>
      <td>Rumpelstiltzkin</td>
      <td>Rumpelstiltskin</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Beauty And The Beast</td>
      <td>Beauty and the Beast</td>
    </tr>
    <tr>
      <th>11</th>
      <td>The Master-Maid</td>
      <td>The Master Maid</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Why The Sea Is Salt</td>
      <td>Why the Sea Is Salt</td>
    </tr>
    <tr>
      <th>13</th>
      <td>The Master Cat; Or, Puss In Boots</td>
      <td>Puss in Boots</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Felicia And The Pot Of Pinks</td>
      <td>Felicia and the Pot of Pinks</td>
    </tr>
    <tr>
      <th>15</th>
      <td>The White Cat</td>
      <td>The White Cat (fairy tale)</td>
    </tr>
    <tr>
      <th>16</th>
      <td>The Water-Lily. The Gold-Spinners</td>
      <td>The Water-lily. The Gold-spinners</td>
    </tr>
    <tr>
      <th>17</th>
      <td>The Terrible Head</td>
      <td></td>
    </tr>
    <tr>
      <th>18</th>
      <td>The Story Of Pretty Goldilocks</td>
      <td>The Story of Pretty Goldilocks</td>
    </tr>
    <tr>
      <th>19</th>
      <td>The History Of Whittington</td>
      <td></td>
    </tr>
    <tr>
      <th>20</th>
      <td>The Wonderful Sheep</td>
      <td>The Wonderful Sheep</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Little Thumb</td>
      <td></td>
    </tr>
    <tr>
      <th>22</th>
      <td>The Forty Thieves</td>
      <td></td>
    </tr>
    <tr>
      <th>23</th>
      <td>Hansel And Grettel</td>
      <td>Hansel and Gretel</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Snow-White And Rose-Red</td>
      <td>Snow-White and Rose-Red</td>
    </tr>
    <tr>
      <th>25</th>
      <td>The Goose-Girl</td>
      <td>The Goose Girl</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Toads And Diamonds</td>
      <td>Diamonds and Toads</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Prince Darling</td>
      <td>Prince Darling</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Blue Beard</td>
      <td>Bluebeard</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Trusty John</td>
      <td>Trusty John</td>
    </tr>
    <tr>
      <th>30</th>
      <td>The Brave Little Tailor</td>
      <td></td>
    </tr>
    <tr>
      <th>31</th>
      <td>A Voyage To Lilliput</td>
      <td></td>
    </tr>
    <tr>
      <th>32</th>
      <td>The Princess On The Glass Hill</td>
      <td>The Princess on the Glass Hill</td>
    </tr>
    <tr>
      <th>33</th>
      <td>The Story Of Prince Ahmed And The Fairy Paribanou</td>
      <td></td>
    </tr>
    <tr>
      <th>34</th>
      <td>The History Of Jack The Giant-Killer</td>
      <td>Jack the Giant Killer</td>
    </tr>
    <tr>
      <th>35</th>
      <td>The Black Bull Of Norroway</td>
      <td>The Black Bull of Norroway</td>
    </tr>
    <tr>
      <th>36</th>
      <td>The Red Etin</td>
      <td>The Red Ettin</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#https://github.com/jsoma/fuzzy_pandas/</span>

<span class="c1"># This is probably overkill...</span>
<span class="c1">#%pip install fuzzy_pandas</span>
<span class="kn">import</span> <span class="nn">fuzzy_pandas</span> <span class="k">as</span> <span class="nn">fpd</span>

<span class="n">fpd</span><span class="o">.</span><span class="n">fuzzy_merge</span><span class="p">(</span><span class="n">df_blue</span><span class="p">[[</span><span class="s2">&quot;title&quot;</span><span class="p">]],</span> <span class="n">wp_book_df</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
            <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
            <span class="n">ignore_case</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ignore_nonalpha</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;jaro&#39;</span><span class="p">,</span> <span class="c1">#bilenko, levenshtein, metaphone, jaro</span>
            <span class="n">threshold</span><span class="o">=</span><span class="mf">0.86</span><span class="p">,</span> <span class="c1"># If we move to 0.86 wee get a false positive...</span>
            <span class="n">keep_left</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
            <span class="n">keep_right</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>
               <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>title</th>
      <th>path</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>The Bronze Ring</td>
      <td>The Bronze Ring</td>
      <td>/wiki/The_Bronze_Ring</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Prince Hyacinth And The Dear Little Princess</td>
      <td>Prince Hyacinth and the Dear Little Princess</td>
      <td>/wiki/Prince_Hyacinth_and_the_Dear_Little_Prin...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>East Of The Sun And West Of The Moon</td>
      <td>East of the Sun and West of the Moon</td>
      <td>/wiki/East_of_the_Sun_and_West_of_the_Moon</td>
    </tr>
    <tr>
      <th>3</th>
      <td>The Yellow Dwarf</td>
      <td>The Yellow Dwarf</td>
      <td>/wiki/The_Yellow_Dwarf</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Little Red Riding Hood</td>
      <td>Little Red Riding Hood</td>
      <td>/wiki/Little_Red_Riding_Hood</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Cinderella, Or The Little Glass Slipper</td>
      <td>Cinderella</td>
      <td>/wiki/Cinderella</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Rumpelstiltzkin</td>
      <td>Rumpelstiltskin</td>
      <td>/wiki/Rumpelstiltskin</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Beauty And The Beast</td>
      <td>Beauty and the Beast</td>
      <td>/wiki/Beauty_and_the_Beast</td>
    </tr>
    <tr>
      <th>8</th>
      <td>The Master-Maid</td>
      <td>The Master Maid</td>
      <td>/wiki/The_Master_Maid</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Why The Sea Is Salt</td>
      <td>Why the Sea Is Salt</td>
      <td>/wiki/Why_the_Sea_Is_Salt</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Felicia And The Pot Of Pinks</td>
      <td>Felicia and the Pot of Pinks</td>
      <td>/wiki/Felicia_and_the_Pot_of_Pinks</td>
    </tr>
    <tr>
      <th>11</th>
      <td>The White Cat</td>
      <td>The White Cat (fairy tale)</td>
      <td>/wiki/The_White_Cat_(fairy_tale)</td>
    </tr>
    <tr>
      <th>12</th>
      <td>The Water-Lily. The Gold-Spinners</td>
      <td>The Water-lily. The Gold-spinners</td>
      <td>/wiki/The_Water-lily._The_Gold-spinners</td>
    </tr>
    <tr>
      <th>13</th>
      <td>The Story Of Pretty Goldilocks</td>
      <td>The Story of Pretty Goldilocks</td>
      <td>/wiki/The_Story_of_Pretty_Goldilocks</td>
    </tr>
    <tr>
      <th>14</th>
      <td>The Wonderful Sheep</td>
      <td>The Wonderful Sheep</td>
      <td>/wiki/The_Wonderful_Sheep</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Hansel And Grettel</td>
      <td>Hansel and Gretel</td>
      <td>/wiki/Hansel_and_Gretel</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Snow-White And Rose-Red</td>
      <td>Snow-White and Rose-Red</td>
      <td>/wiki/Snow-White_and_Rose-Red</td>
    </tr>
    <tr>
      <th>17</th>
      <td>The Goose-Girl</td>
      <td>The Goose Girl</td>
      <td>/wiki/The_Goose_Girl</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Prince Darling</td>
      <td>Prince Darling</td>
      <td>/wiki/Prince_Darling</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Blue Beard</td>
      <td>Bluebeard</td>
      <td>/wiki/Bluebeard</td>
    </tr>
    <tr>
      <th>20</th>
      <td>Trusty John</td>
      <td>Trusty John</td>
      <td>/wiki/Trusty_John</td>
    </tr>
    <tr>
      <th>21</th>
      <td>The Princess On The Glass Hill</td>
      <td>The Princess on the Glass Hill</td>
      <td>/wiki/The_Princess_on_the_Glass_Hill</td>
    </tr>
    <tr>
      <th>22</th>
      <td>The Black Bull Of Norroway</td>
      <td>The Black Bull of Norroway</td>
      <td>/wiki/The_Black_Bull_of_Norroway</td>
    </tr>
    <tr>
      <th>23</th>
      <td>The Red Etin</td>
      <td>The Red Ettin</td>
      <td>/wiki/The_Red_Ettin</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpd</span><span class="o">.</span><span class="n">fuzzy_merge</span><span class="p">(</span><span class="n">df_blue</span><span class="p">[[</span><span class="s2">&quot;title&quot;</span><span class="p">]],</span> <span class="n">wp_book_df</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
            <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
            <span class="n">ignore_case</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ignore_nonalpha</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;metaphone&#39;</span><span class="p">,</span> <span class="c1">#levenshtein, metaphone, jaro, bilenko</span>
            <span class="n">threshold</span><span class="o">=</span><span class="mf">0.86</span><span class="p">,</span>
            <span class="n">keep_left</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
            <span class="n">keep_right</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>
               <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>title</th>
      <th>path</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>The Bronze Ring</td>
      <td>The Bronze Ring</td>
      <td>/wiki/The_Bronze_Ring</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Prince Hyacinth And The Dear Little Princess</td>
      <td>Prince Hyacinth and the Dear Little Princess</td>
      <td>/wiki/Prince_Hyacinth_and_the_Dear_Little_Prin...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>East Of The Sun And West Of The Moon</td>
      <td>East of the Sun and West of the Moon</td>
      <td>/wiki/East_of_the_Sun_and_West_of_the_Moon</td>
    </tr>
    <tr>
      <th>3</th>
      <td>The Yellow Dwarf</td>
      <td>The Yellow Dwarf</td>
      <td>/wiki/The_Yellow_Dwarf</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Little Red Riding Hood</td>
      <td>Little Red Riding Hood</td>
      <td>/wiki/Little_Red_Riding_Hood</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Rumpelstiltzkin</td>
      <td>Rumpelstiltskin</td>
      <td>/wiki/Rumpelstiltskin</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Beauty And The Beast</td>
      <td>Beauty and the Beast</td>
      <td>/wiki/Beauty_and_the_Beast</td>
    </tr>
    <tr>
      <th>7</th>
      <td>The Master-Maid</td>
      <td>The Master Maid</td>
      <td>/wiki/The_Master_Maid</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Why The Sea Is Salt</td>
      <td>Why the Sea Is Salt</td>
      <td>/wiki/Why_the_Sea_Is_Salt</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Felicia And The Pot Of Pinks</td>
      <td>Felicia and the Pot of Pinks</td>
      <td>/wiki/Felicia_and_the_Pot_of_Pinks</td>
    </tr>
    <tr>
      <th>10</th>
      <td>The Water-Lily. The Gold-Spinners</td>
      <td>The Water-lily. The Gold-spinners</td>
      <td>/wiki/The_Water-lily._The_Gold-spinners</td>
    </tr>
    <tr>
      <th>11</th>
      <td>The Story Of Pretty Goldilocks</td>
      <td>The Story of Pretty Goldilocks</td>
      <td>/wiki/The_Story_of_Pretty_Goldilocks</td>
    </tr>
    <tr>
      <th>12</th>
      <td>The Wonderful Sheep</td>
      <td>The Wonderful Sheep</td>
      <td>/wiki/The_Wonderful_Sheep</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Hansel And Grettel</td>
      <td>Hansel and Gretel</td>
      <td>/wiki/Hansel_and_Gretel</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Snow-White And Rose-Red</td>
      <td>Snow-White and Rose-Red</td>
      <td>/wiki/Snow-White_and_Rose-Red</td>
    </tr>
    <tr>
      <th>15</th>
      <td>The Goose-Girl</td>
      <td>The Goose Girl</td>
      <td>/wiki/The_Goose_Girl</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Prince Darling</td>
      <td>Prince Darling</td>
      <td>/wiki/Prince_Darling</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Blue Beard</td>
      <td>Bluebeard</td>
      <td>/wiki/Bluebeard</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Trusty John</td>
      <td>Trusty John</td>
      <td>/wiki/Trusty_John</td>
    </tr>
    <tr>
      <th>19</th>
      <td>The Princess On The Glass Hill</td>
      <td>The Princess on the Glass Hill</td>
      <td>/wiki/The_Princess_on_the_Glass_Hill</td>
    </tr>
    <tr>
      <th>20</th>
      <td>The Black Bull Of Norroway</td>
      <td>The Black Bull of Norroway</td>
      <td>/wiki/The_Black_Bull_of_Norroway</td>
    </tr>
    <tr>
      <th>21</th>
      <td>The Red Etin</td>
      <td>The Red Ettin</td>
      <td>/wiki/The_Red_Ettin</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>## Other Things to Link In</p>
<p>Have other people generated data sets that can be linked in?</p>
<ul class="simple">
<li><p><a class="reference external" href="http://www.mythfolklore.net/andrewlang/indexbib.htm">http://www.mythfolklore.net/andrewlang/indexbib.htm</a> /via &#64;OnlineCrsLady</p></li>
</ul>
</div>
<div class="section" id="common-refrains-repeating-phrases">
<h2>Common Refrains / Repeating Phrases<a class="headerlink" href="#common-refrains-repeating-phrases" title="Permalink to this headline">¶</a></h2>
<p>Many stories incorporate a repeating phrase or refrain in the story, but you may need to read quite a long way into a story before you can identify that repeating phrase. So are there any tools we might be able to use</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#db = Database(db_name)</span>
              
<span class="n">q2</span> <span class="o">=</span> <span class="s1">&#39;&quot;pretty hen&quot;&#39;</span>

<span class="n">_q</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT * FROM books_fts WHERE books_fts MATCH </span><span class="si">{</span><span class="n">db</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span><span class="si">}</span><span class="s1"> ;&#39;</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">_q</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The House In The Wood
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">from</span> <span class="nn">nltk.util</span> <span class="kn">import</span> <span class="n">ngrams</span> <span class="k">as</span> <span class="n">nltk_ngrams</span>

<span class="n">tokens</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span>

<span class="n">size</span> <span class="o">=</span> <span class="mi">5</span>
<span class="c1">#for i in nltk_ngrams(tokens, size):</span>
<span class="c1">#    print(&#39; &#39;.join(i))</span>
</pre></div>
</div>
</div>
</div>
<p>We could then look for repeating phrases:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;phrase&#39;</span><span class="p">:[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nltk_ngrams</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">size</span><span class="p">)]})</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;phrase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>, pretty brindled cow ,        4
And you , pretty brindled      4
you , pretty brindled cow      4
pretty brindled cow , What     4
brindled cow , What do         4
                              ..
leaving him all day without    1
for leaving him all day        1
wife for leaving him all       1
his wife for leaving him       1
to go hungry . &#39;               1
Name: phrase, Length: 1787, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Really, we need to do a scan down from large token size until we find a match (longest match phrase).</p>
<p>But for now, let’s see what repeating elements we get from one of those search phrases:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="n">_q</span> <span class="o">=</span> <span class="s1">&#39;pretty brindled cow&#39;</span>

<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">_q</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]):</span>
    <span class="c1"># Display the matched terms and the 50 characters</span>
    <span class="c1"># immediately preceding and following the phrase </span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;===</span><span class="se">\n</span><span class="si">{</span><span class="n">q2</span><span class="si">}</span><span class="s1">: &#39;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">(),</span> <span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span><span class="o">-</span><span class="mi">50</span><span class="p">):</span><span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">()</span><span class="o">+</span><span class="mi">50</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===
&quot;pretty hen&quot;:  1566 1585 
The man said:

Pretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?

&#39;Duks,&#39; answered the beast
===
&quot;pretty hen&quot;:  3505 3524 ed the beasts:

Pretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?

The beasts answered, &#39;Duks
===
&quot;pretty hen&quot;:  4932 4951  beasts again:

Pretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?

&#39;Duks,&#39; they said. Then th
===
&quot;pretty hen&quot;:  6119 6138  to rest now?&#39;

Pretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?

The animals said, &#39;Duks:
</pre></div>
</div>
</div>
</div>
<p>Make a function for that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_contexts</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">phrase</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the context(s) of the phrase.&quot;&quot;&quot;</span>
    <span class="n">contexts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">phrase</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="c1"># Display the matched terms and the `width` characters</span>
        <span class="c1"># immediately preceding and following the phrase </span>
        <span class="n">contexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span><span class="o">-</span><span class="n">width</span><span class="p">):</span><span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">()</span><span class="o">+</span><span class="n">width</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">contexts</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">find_contexts</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="s1">&#39;pretty brindled cow&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">==&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The man said:

Pretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?

&#39;Duks,&#39; answered the beast 
==
ed the beasts:

Pretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?

The beasts answered, &#39;Duks 
==
 beasts again:

Pretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?

&#39;Duks,&#39; they said. Then th 
==
 to rest now?&#39;

Pretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?

The animals said, &#39;Duks:

 
==
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">find_contexts</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="s1">&#39;pretty brindled cow&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&quot;\nThe man said:\n\nPretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?\n\n&#39;Duks,&#39; answered the beast&quot;,
 &quot;ed the beasts:\n\nPretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?\n\nThe beasts answered, &#39;Duks&quot;,
 &quot; beasts again:\n\nPretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?\n\n&#39;Duks,&#39; they said. Then th&quot;,
 &quot; to rest now?&#39;\n\nPretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?\n\nThe animals said, &#39;Duks:\n\n&quot;]
</pre></div>
</div>
</div>
</div>
<p>We can also make this a SQLite lookup function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">vtfunc</span> <span class="kn">import</span> <span class="n">TableFunction</span>

<span class="k">def</span> <span class="nf">concordances</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">phrase</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the concordances of a phrase in a text.&quot;&quot;&quot;</span>
    <span class="n">contexts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">phrase</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="c1"># Display the matched terms and the `width` characters</span>
        <span class="c1"># immediately preceding and following the phrase</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span><span class="o">-</span><span class="n">width</span><span class="p">):</span><span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">()</span><span class="o">+</span><span class="n">width</span><span class="p">]</span>
        <span class="n">contexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">(),</span> <span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">())</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">contexts</span>


<span class="k">class</span> <span class="nc">Concordances</span><span class="p">(</span><span class="n">TableFunction</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;phrase&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">]</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;match&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;concordance&#39;</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phrase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">concordances</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">phrase</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,)</span>

<span class="n">Concordances</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">concordances</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="s1">&#39;pretty brindled cow&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&quot;\nThe man said:\n\nPretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?\n\n&#39;Duks,&#39; answered the beast&quot;,
  1566,
  1585),
 (&quot;ed the beasts:\n\nPretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?\n\nThe beasts answered, &#39;Duks&quot;,
  3505,
  3524),
 (&quot; beasts again:\n\nPretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?\n\n&#39;Duks,&#39; they said. Then th&quot;,
  4932,
  4951),
 (&quot; to rest now?&#39;\n\nPretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?\n\nThe animals said, &#39;Duks:\n\n&quot;,
  6119,
  6138)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT matched.* FROM books, concordance(&quot;pretty brindled cow&quot;, books.text) as matched WHERE title=&quot;The House In The Wood&quot;;&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&quot;\nThe man said:\n\nPretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?\n\n&#39;Duks,&#39; answered the beast&quot;, 1566, 1585)
(&quot;ed the beasts:\n\nPretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?\n\nThe beasts answered, &#39;Duks&quot;, 3505, 3524)
(&quot; beasts again:\n\nPretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?\n\n&#39;Duks,&#39; they said. Then th&quot;, 4932, 4951)
(&quot; to rest now?&#39;\n\nPretty cock, Pretty hen, And you, pretty brindled cow, What do you say now?\n\nThe animals said, &#39;Duks:\n\n&quot;, 6119, 6138)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">scanner</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">minlen</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">startlen</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">min_repeats</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">autostop</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Search a text for repeated phrases above a minimum length.&quot;&quot;&quot;</span>
    <span class="c1"># Tokenise the text</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">RegexpTokenizer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w+&#39;</span><span class="p">)</span>
    <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="s1">&#39;Eighty-seven miles to go, yet.  Onward!&#39;</span><span class="p">)</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    
    <span class="c1">#nltk_ngrams returns an empty list if we ask for an ngram longer than the sentence</span>
    <span class="c1"># So set the (long) start length to the lesser of the original provided</span>
    <span class="c1"># start length or the token length of the original text;</span>
    <span class="c1"># which is to say, the minimum of the provided start length </span>
    <span class="c1"># or the length of the text</span>
    <span class="n">startlen</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">startlen</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>
    
    <span class="c1"># Start with a long sequence then iterate down to a minumum length sequence</span>
    <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startlen</span><span class="p">,</span> <span class="n">minlen</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Generate a dataframe containing all the ngrams, one row per ngram</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;phrase&#39;</span><span class="p">:[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nltk_ngrams</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">size</span><span class="p">)]})</span>
        
        <span class="c1"># Find the occurrence counts of each phrase</span>
        <span class="n">value_counts_series</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;phrase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

        <span class="c1"># If we have at least the specified number of occurrences</span>
        <span class="c1"># don&#39;t bother searching for any more</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">value_counts_series</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_repeats</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">autostop</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">pass</span>
    <span class="c1"># Return a pandas series (an indexed list, essentially)</span>
    <span class="c1"># containing the longest (or phrases) we found</span>
    
    <span class="k">return</span> <span class="n">value_counts_series</span><span class="p">[(</span><span class="n">value_counts_series</span><span class="o">&gt;=</span><span class="n">min_repeats</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">value_counts_series</span><span class="o">==</span><span class="nb">max</span><span class="p">(</span><span class="n">value_counts_series</span><span class="p">))]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scanner</span><span class="p">(</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>: Pretty cock , Pretty hen , And you , pretty brindled cow , What do you say now ?    3
Name: phrase, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display the first (0&#39;th indexed) item</span>
<span class="c1"># (In this case there is only one item hat repeats this number of times anyway.)</span>
<span class="n">scanner</span><span class="p">(</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scanner</span><span class="p">(</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;: Pretty cock , Pretty hen , And you , pretty brindled cow , What do you say now ?&#39;,
 3)
</pre></div>
</div>
</div>
</div>
<p>If we constrain this function to return a single item, we can create a simple SQLite function that will search through records and return the longest phrase above a certain minimum length (or the first longest phrase, if several long phrases of the same length are found):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_repeating_phrase</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the longest repeating phrase found in a text.</span>
<span class="sd">       If there are more than one of the same length, return the first.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">phrase</span> <span class="o">=</span> <span class="n">scanner</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    
    <span class="c1">#If there is at least one response, take the first</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">phrase</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">phrase</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">find_repeating_phrase</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;: Pretty cock , Pretty hen , And you , pretty brindled cow , What do you say now ?&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The `db` object is a sqlite_utils database object</span>
<span class="c1"># Pass in:</span>
<span class="c1"># - the name of the function we want to use in the database</span>
<span class="c1"># - the number of arguments it takes</span>
<span class="c1"># - the function we want to invoke</span>
<span class="n">db</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s1">&#39;find_repeating_phrase&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">find_repeating_phrase</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_q</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT book, title, find_repeating_phrase(text) AS phrase </span>
<span class="s2">FROM books WHERE title=&quot;The House In The Wood&quot; ;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">for</span> <span class="n">row2</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">_q</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;book&#39;: &#39;The Pink Fairy Book&#39;, &#39;title&#39;: &#39;The House In The Wood&#39;, &#39;phrase&#39;: &#39;: Pretty cock , Pretty hen , And you , pretty brindled cow , What do you say now ?&#39;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_q</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT title, find_repeating_phrase(text) AS phrase</span>
<span class="s2">FROM books WHERE book=&quot;The Pink Fairy Book&quot; ;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">for</span> <span class="n">row3</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">_q</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">row3</span><span class="p">[</span><span class="s1">&#39;phrase&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">row3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;title&#39;: &#39;Catherine And Her Destiny&#39;, &#39;phrase&#39;: &#39;the court , and&#39;}
{&#39;title&#39;: &#39;Esben And The Witch&#39;, &#39;phrase&#39;: &quot;? &#39; &#39;Ye -- e -- s ! &#39; &#39;Are you coming back again ? &#39; &#39;That may be , &#39; said Esben . &#39;Then you &#39;ll catch it , &#39;&quot;}
{&#39;title&#39;: &quot;Hans, The Mermaid&#39;s Son&quot;, &#39;phrase&#39;: &quot;, &#39; said Hans ; &#39; I&quot;}
{&#39;title&#39;: &#39;How The Dragon Was Tricked&#39;, &#39;phrase&#39;: &quot;, &#39; said the dragon&quot;}
{&#39;title&#39;: &quot;How The Hermit Helped To Win The King&#39;s Daughter&quot;, &#39;phrase&#39;: &quot;&#39;Ask him if he will come with us&quot;}
{&#39;title&#39;: &#39;I Know What I Have Learned&#39;, &#39;phrase&#39;: &#39;and asked his wife whether the cow had calved&#39;}
{&#39;title&#39;: &#39;King Lindorm&#39;, &#39;phrase&#39;: &#39;rode out into the forest&#39;}
{&#39;title&#39;: &#39;Maiden Bright-Eye&#39;, &#39;phrase&#39;: &quot;. &#39;Good evening , &#39; it said . &#39;Thanks , Maiden Bright-eye , &#39; said the dog . &#39;Where is my brother ? &#39; &#39;He is in the serpent-pit . &#39; &#39;Where is my wicked sister ? &#39; &#39;She is with the noble king . &#39; &#39;Alas ! alas !&quot;}
{&#39;title&#39;: &#39;Master And Pupil&#39;, &#39;phrase&#39;: &quot;, &#39; said the boy .&quot;}
{&#39;title&#39;: &#39;Peter Bull&#39;, &#39;phrase&#39;: &quot;&#39;Oh , yes , &#39; said the&quot;}
{&#39;title&#39;: &#39;Princess Minon-Minette&#39;, &#39;phrase&#39;: &quot;, &#39; replied the old woman&quot;}
{&#39;title&#39;: &quot;The Bird &#39;Grip&#39;&quot;, &#39;phrase&#39;: &#39;the horse with the golden shoes&#39;}
{&#39;title&#39;: &#39;The Cunning Shoemaker&#39;, &#39;phrase&#39;: &quot;, &#39; replied the shoemaker&quot;}
{&#39;title&#39;: &#39;The Fir-Tree&#39;, &#39;phrase&#39;: &quot;&#39; thought the tree .&quot;}
{&#39;title&#39;: &#39;The Flying Trunk&#39;, &#39;phrase&#39;: &quot;. &#39;&#39; &#39; &#39;&#39;&quot;}
{&#39;title&#39;: &#39;The Goblin And The Grocer&#39;, &#39;phrase&#39;: &#39;, and he had&#39;}
{&#39;title&#39;: &#39;The Golden Lion&#39;, &#39;phrase&#39;: &#39;, and the young man&#39;}
{&#39;title&#39;: &#39;The House In The Wood&#39;, &#39;phrase&#39;: &#39;: Pretty cock , Pretty hen , And you , pretty brindled cow , What do you say now ?&#39;}
{&#39;title&#39;: &#39;The Jackal, The Dove, And The Panther&#39;, &#39;phrase&#39;: &quot;which side do you turn to ? &#39;&quot;}
{&#39;title&#39;: &#39;The King Who Would Have A Beautiful Wife&#39;, &#39;phrase&#39;: &quot;. &#39; &#39;And I&quot;}
{&#39;title&#39;: &#39;The Little Hare&#39;, &#39;phrase&#39;: &#39;the little hare , the little hare ,&#39;}
{&#39;title&#39;: &#39;The Man Without A Heart&#39;, &#39;phrase&#39;: &quot;, &#39; said the&quot;}
{&#39;title&#39;: &#39;The Merry Wives&#39;, &#39;phrase&#39;: &quot;, &#39; said the&quot;}
{&#39;title&#39;: &#39;The Princess In The Chest&#39;, &#39;phrase&#39;: &quot;&#39;Sentry , where are you ? Sentry , where are you ?&quot;}
{&#39;title&#39;: &#39;The Shirt-Collar&#39;, &#39;phrase&#39;: &quot;! &#39; said the shirt-collar ,&quot;}
{&#39;title&#39;: &#39;The Slaying Of The Tanuki&#39;, &#39;phrase&#39;: &#39;. The Tanuki ,&#39;}
{&#39;title&#39;: &#39;The Snow-Man&#39;, &#39;phrase&#39;: &quot;? &#39; asked the Snow-man .&quot;}
{&#39;title&#39;: &#39;The Snow-Queen&#39;, &#39;phrase&#39;: &quot;, &#39; said the crow ,&quot;}
{&#39;title&#39;: &#39;The Sparrow With The Slit Tongue&#39;, &#39;phrase&#39;: &#39;the house , and&#39;}
{&#39;title&#39;: &#39;The Sprig Of Rosemary&#39;, &#39;phrase&#39;: &quot;&#39;Do you , rich as you are ,&quot;}
{&#39;title&#39;: &#39;The Story Of Ciccu&#39;, &#39;phrase&#39;: &quot;accept them with my humble duty . &#39;&quot;}
{&#39;title&#39;: &#39;The Three Brothers&#39;, &#39;phrase&#39;: &quot;the house . &#39;&quot;}
{&#39;title&#39;: &quot;The Troll&#39;s Daughter&quot;, &#39;phrase&#39;: &#39;at the bottom of the sea .&#39;}
{&#39;title&#39;: &#39;The Two Brothers&#39;, &#39;phrase&#39;: &#39;seven years and seven months&#39;}
{&#39;title&#39;: &#39;The Water Of Life&#39;, &#39;phrase&#39;: &#39;the talking bird , and a branch of the tree of beauty&#39;}
{&#39;title&#39;: &#39;The White Dove&#39;, &#39;phrase&#39;: &quot;, &#39; said the prince ,&quot;}
{&#39;title&#39;: &#39;The Wounded Lion&#39;, &#39;phrase&#39;: &#39;will hire me for a servant ?&#39;}
{&#39;title&#39;: &#39;Uraschimataro And The Turtle&#39;, &#39;phrase&#39;: &#39;the sea , and&#39;}
</pre></div>
</div>
</div>
</div>
<p>The punctuation gets in the way somewhat, so it might be useful if removed the punctuation and tried again:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Allow</span> <span class="n">param</span> <span class="ow">and</span> <span class="n">de</span><span class="o">-</span><span class="n">punctuate</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># allow different tokenisers</span>
<span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">RegexpTokenizer</span>

<span class="k">def</span> <span class="nf">scanner2</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">minlen</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">startlen</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">min_repeats</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">autostop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tokeniser</span><span class="o">=</span><span class="s1">&#39;word&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Search a text for repeated phrases above a minimum length.&quot;&quot;&quot;</span>
    <span class="c1"># Tokenise the text</span>
    <span class="k">if</span> <span class="n">tokeniser</span> <span class="o">==</span> <span class="s1">&#39;depunc_word&#39;</span><span class="p">:</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">RegexpTokenizer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w+&#39;</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">tokeniser</span> <span class="o">==</span> <span class="s1">&#39;sent&#39;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># eg for default: tokeniser=&#39;word&#39;</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">RegexpTokenizer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w+&#39;</span><span class="p">)</span>
        <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="s1">&#39;Eighty-seven miles to go, yet.  Onward!&#39;</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    
    <span class="c1">#nltk_ngrams returns an empty list if we ask for an ngram longer than the sentence</span>
    <span class="c1"># So set the (long) start length to the lesser of the original provided</span>
    <span class="c1"># start length or the token length of the original text;</span>
    <span class="c1"># which is to say, the minimum of the provided start length </span>
    <span class="c1"># or the lenth of the text</span>
    <span class="n">startlen</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">startlen</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>
    
    <span class="c1"># Start with a long sequence then iterate down to a minumum length sequence</span>
    <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startlen</span><span class="p">,</span> <span class="n">minlen</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        
        <span class="c1"># Generate a dataframe containing all the ngrams, one row per ngram</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;phrase&#39;</span><span class="p">:[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nltk_ngrams</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span><span class="n">size</span><span class="p">)]})</span>
        
        <span class="c1"># Find the occurrence counts of each phrase</span>
        <span class="n">value_counts_series</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;phrase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        
        <span class="c1"># If we have at least the specified number of occurrences</span>
        <span class="c1"># don&#39;t bother searching for any more</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">value_counts_series</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_repeats</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">autostop</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">pass</span>
    <span class="c1"># Return a pandas series (an indexed list, essentially)</span>
    <span class="c1"># containing the long phrase (or phrases) we found</span>
    <span class="k">return</span> <span class="n">value_counts_series</span><span class="p">[(</span><span class="n">value_counts_series</span><span class="o">&gt;=</span><span class="n">min_repeats</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">value_counts_series</span><span class="o">==</span><span class="nb">max</span><span class="p">(</span><span class="n">value_counts_series</span><span class="p">))]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_repeating_phrase_depunc</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">minlen</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the longest repeating phrase found in a text.</span>
<span class="sd">       If there are more than one of the same lentgh, return the first.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Accepts a specified minimum phrase length (minlin)</span>
    <span class="c1"># Reduce the required number of repeats</span>
    <span class="n">phrase</span> <span class="o">=</span> <span class="n">scanner2</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">minlen</span><span class="o">=</span><span class="n">minlen</span><span class="p">,</span> <span class="n">min_repeats</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">tokeniser</span><span class="o">=</span><span class="s1">&#39;depunc_word&#39;</span><span class="p">)</span>
    
    <span class="c1">#If there is at least one response, take the first</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">phrase</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">phrase</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">find_repeating_phrase_depunc</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Pretty cock Pretty hen And you pretty brindled cow What do you say now&#39;
</pre></div>
</div>
</div>
</div>
<p>Register the function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note we need to update the number of arguments (max. 2)</span>
<span class="n">db</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s1">&#39;find_repeating_phrase_depunc&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">find_repeating_phrase_depunc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Try again:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_q</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT book, title, find_repeating_phrase_depunc(text, 7) AS phrase</span>
<span class="s2">FROM books WHERE book=&quot;The Pink Fairy Book&quot; ;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">for</span> <span class="n">row5</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">_q</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">row5</span><span class="p">[</span><span class="s1">&#39;phrase&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">row5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;book&#39;: &#39;The Pink Fairy Book&#39;, &#39;title&#39;: &#39;Esben And The Witch&#39;, &#39;phrase&#39;: &#39;Ye e s Are you coming back again That may be said Esben Then you ll catch it&#39;}
{&#39;book&#39;: &#39;The Pink Fairy Book&#39;, &#39;title&#39;: &quot;How The Hermit Helped To Win The King&#39;s Daughter&quot;, &#39;phrase&#39;: &#39;Ask him if he will come with us&#39;}
{&#39;book&#39;: &#39;The Pink Fairy Book&#39;, &#39;title&#39;: &#39;I Know What I Have Learned&#39;, &#39;phrase&#39;: &#39;and asked his wife whether the cow had calved&#39;}
{&#39;book&#39;: &#39;The Pink Fairy Book&#39;, &#39;title&#39;: &#39;Maiden Bright-Eye&#39;, &#39;phrase&#39;: &#39;Good evening it said Thanks Maiden Bright eye said the dog Where is my brother He is in the serpent pit Where is my wicked sister She is with the noble king Alas alas&#39;}
{&#39;book&#39;: &#39;The Pink Fairy Book&#39;, &#39;title&#39;: &quot;The Bird &#39;Grip&#39;&quot;, &#39;phrase&#39;: &#39;the horse with the golden shoes and&#39;}
{&#39;book&#39;: &#39;The Pink Fairy Book&#39;, &#39;title&#39;: &#39;The House In The Wood&#39;, &#39;phrase&#39;: &#39;Pretty cock Pretty hen And you pretty brindled cow What do you say now&#39;}
{&#39;book&#39;: &#39;The Pink Fairy Book&#39;, &#39;title&#39;: &#39;The Princess In The Chest&#39;, &#39;phrase&#39;: &#39;My father has set no sentry in War and Pest&#39;}
{&#39;book&#39;: &#39;The Pink Fairy Book&#39;, &#39;title&#39;: &#39;The Shirt-Collar&#39;, &#39;phrase&#39;: &#39;a boot jack and a hair brush&#39;}
{&#39;book&#39;: &#39;The Pink Fairy Book&#39;, &#39;title&#39;: &#39;The Sprig Of Rosemary&#39;, &#39;phrase&#39;: &#39;listened and was sorry for her and&#39;}
{&#39;book&#39;: &#39;The Pink Fairy Book&#39;, &#39;title&#39;: &quot;The Troll&#39;s Daughter&quot;, &#39;phrase&#39;: &#39;at the bottom of the sea He&#39;}
{&#39;book&#39;: &#39;The Pink Fairy Book&#39;, &#39;title&#39;: &#39;The Water Of Life&#39;, &#39;phrase&#39;: &#39;the talking bird and a branch of the tree of beauty&#39;}
{&#39;book&#39;: &#39;The Pink Fairy Book&#39;, &#39;title&#39;: &#39;The Wounded Lion&#39;, &#39;phrase&#39;: &#39;Who will hire me for a servant&#39;}
</pre></div>
</div>
</div>
</div>
<p>Check the context:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_q</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT text, find_repeating_phrase(text) AS phrase</span>
<span class="s2">FROM books WHERE title=&quot;Maiden Bright-Eye&quot; ;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">for</span> <span class="n">row6</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">_q</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">find_contexts</span><span class="p">(</span><span class="n">row6</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="s2">&quot;Where is my wicked &quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">===&quot;</span><span class="p">)</span>
    <span class="c1">#print(row6[&#39;phrase&#39;])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Thanks, Maiden Bright-eye,&#39; said the dog.

&#39;Where is my brother?&#39;

&#39;He is in the serpent-pit.&#39;

&#39;Where is my wicked sister?&#39;

&#39;She is with the noble king.&#39;

&#39;Alas! alas! I am here this evening, and shall be for two e 
===


&#39;Thanks, Maiden Bright-eye,&#39; said the dog.

&#39;Where is my brother?&#39;

&#39;He is in the serpent-pit.&#39;

&#39;Where is my wicked sister?&#39;

&#39;She is with the noble king.&#39;

&#39;Alas! alas! I am here this evening, and shall be for one e 
===


&#39;Thanks, Maiden Bright-eye,&#39; said the dog.

&#39;Where is my brother?&#39;

&#39;He is in the serpent-pit.&#39;

&#39;Where is my wicked sister?&#39;

&#39;She is with the noble king.&#39;

&#39;Alas! alas! now I shall never come again.&#39; With this it sl 
===
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row6</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">_q</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">find_contexts</span><span class="p">(</span><span class="n">row6</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="s2">&quot;the king&#39;s palace&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">===&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> something about the stepson. He had gone out into the world to look about him, and took service in the king&#39;s palace. About this time he got permission to go home and see his sister, and when he saw how lovely and be 
===
 he saw how lovely and beautiful she was, he was so pleased and delighted that when he came back to the king&#39;s palace everyone there wanted to know what he was always so happy about. He told them that it was because h 
===
r life, and she was at once transformed into a duck. The duck swam away after the ship, and came to the king&#39;s palace on the next evening. There it waddled up the drain, and so into the kitchen, where her little dog l 
===
it.

At this time the brother in the serpent-pit dreamed that his right sister had come swimming to the king&#39;s palace in the shape of a duck, and that she could not regain her own form until her beak was cut off. He g 
===
</pre></div>
</div>
</div>
</div>
<p>We need to be able to find short sentences down to the minimum that are not in a longer phrase:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">scanner_all</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">minlen</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">startlen</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">min_repeats</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">autostop</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">long_phrases</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startlen</span><span class="p">,</span> <span class="n">minlen</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;phrase&#39;</span><span class="p">:[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nltk_ngrams</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)))]})</span>
        <span class="n">value_counts_series</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;phrase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">value_counts_series</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_repeats</span><span class="p">:</span>
            <span class="n">test_phrases</span> <span class="o">=</span> <span class="n">value_counts_series</span><span class="p">[</span><span class="n">value_counts_series</span><span class="o">==</span><span class="nb">max</span><span class="p">(</span><span class="n">value_counts_series</span><span class="p">)]</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">test_phrase</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">test_phrases</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">test_phrase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">long_phrases</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">test_phrase</span> <span class="ow">in</span> <span class="n">long_phrase</span> <span class="k">for</span> <span class="n">long_phrase</span> <span class="ow">in</span> <span class="n">long_phrases</span><span class="p">):</span>
                    <span class="n">long_phrases</span><span class="p">[</span><span class="n">test_phrase</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            
    <span class="k">return</span> <span class="n">long_phrases</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">txt_reps</span> <span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Nota that There once was a thing that and 5 There once was a thing that and 4 There once was a thing that and 3</span>
<span class="s2">There once was a thing that and 1 There once was a thing that and  6 There once was a thing that and 7</span>
<span class="s2">there was another that 1 and there was another that 2 and there was another that 3 and there was another that and</span>
<span class="s2">there was another that and there was another that 5 and there was another that 9 and there was another that</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scanner</span><span class="p">(</span> <span class="n">txt_reps</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There once was a thing that and    6
Name: phrase, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scanner_all</span><span class="p">(</span><span class="n">txt_reps</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;There once was a thing that and&#39;: 6, &#39;and there was another that&#39;: 7}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scanner_all</span><span class="p">(</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;Pretty cock , Pretty hen , And you , pretty brindled cow , What do you say now ?&#39;: 4}
</pre></div>
</div>
</div>
</div>
<p>## Longest Common Substring</p>
<p>Could we use <code class="docutils literal notranslate"><span class="pre">difflib.SequenceMatcher.find_longest_match()</span></code> on first and second half of doc, or various docs samples, to try to find common refrains?</p>
<p>Or chunk into paragraphs and compare every paragraph with every other paragraph?</p>
<p>Here’s how the to call the <code class="docutils literal notranslate"><span class="pre">SequenceMatcher().find_longest_match()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">SequenceMatcher</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">txt_reps</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">txt_reps</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">find_longest_match</span><span class="p">()</span>
<span class="n">m</span><span class="p">,</span> <span class="n">txt_reps</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="n">m</span><span class="o">.</span><span class="n">a</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(Match(a=9, b=33, size=33), &#39; There once was a thing that and &#39;)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="doc2vec-search-engine">
<h2>Doc2Vec Search Engine<a class="headerlink" href="#doc2vec-search-engine" title="Permalink to this headline">¶</a></h2>
<p>To explore: a simple <code class="docutils literal notranslate"><span class="pre">Doc2Vec</span></code> powered search engine based on <a class="reference external" href="https://www.kaggle.com/hgilles06/a-doc2vec-search-engine-cord19-new-version">https://www.kaggle.com/hgilles06/a-doc2vec-search-engine-cord19-new-version</a> .</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="preface.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Preface</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="Ashliman_folk_texts_scraper.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Ashliman “Folklore and Mythology Electronic Texts” Scraper</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Tony Hirst<br/>
        
            &copy; Copyright 2022.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>