
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>World of Tales Online Story Collection &#8212; Story Notes - Technical Recipes</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Exploring Notes &amp; Queries" href="Notes_and_Queries_DB.html" />
    <link rel="prev" title="Gibbs Tiny Tales Collection" href="gibbs_tiny_tales.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Story Notes - Technical Recipes</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="preface.html">
                    Preface
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="how-to-read-this-book.html">
   How To Read This Book (Do Not Be Afraid)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="running-the-book-code.html">
   Invoking the Incantations Contained in This Book
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Story Collection Scrapers and Search
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="lang-fairy-books-db.html">
   A Full Text Searchable Database of Lang’s Fairy Books
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lang-fairy-books-db_PART_2.html">
   Finding Book Index-Like Things In Lang’s Fairy Stories…
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lang-fairy-books-db_PART_3.html">
   Annotating Lang’s Fairy Tales With Wikipedia Links
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lang-fairy-books-db_PART_4.html">
   Identifying Common Refrains / Repeating Phrases In Lang’s Fairy Story Collections
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ashliman_folk_texts_scraper.html">
   Ashliman “Folklore and Mythology Electronic Texts” Scraper
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="MFTD-Multilingual_Folk_Tale_Database.html">
   Multilingual Folk Tale Database (MFTD)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Duncan_Williamson_Tobar_Audio.html">
   Duncan Williamson Audio Recordings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="gibbs_tiny_tales.html">
   Gibbs Tiny Tales Collection
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   World of Tales Online Story Collection
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Notes &amp; Queries
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Notes_and_Queries_DB.html">
   Exploring Notes &amp; Queries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Notes_and_Queries_DB_PART_2.html">
   Generating a Full Text Searchable Database for
   <em>
    Notes &amp; Queries
   </em>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Notes_and_Queries_DB_PART_3.html">
   Building a 19th c. Notes &amp; Queries Full Text Search Engine
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Notes_and_Queries_DB_PART_4.html">
   Creating a 19th c. Notes &amp; Queries Index Database
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Advanced Search Techniques
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Lang_Doc2Vec.html">
   Doc2Vec Searching of Lang Database
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tale Types
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Missouri_Tale_Types.html">
   Tale Types Scraper
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Thompson_Motif_Index.html">
   Thompson Motif Index
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Wikipedia and DBPedia
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="DBPedia_Aarne-Thompson-Uther_Search.html">
   Aarne-Thompson-Uther (ATU) Search
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/psychemedia/storynotes/main?urlpath=lab/tree/./world_of_tales.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="./lite/retro/notebooks?path=./world_of_tales.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch via RetroLite"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_jupyterlite.svg">
  </span>
<span class="headerbtn__text-container">RetroLite</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/psychemedia/storynotes"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#identify-books-available">
   Identify Books Available
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scraping-book-index-pages">
   Scraping Book Index Pages
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scraping-the-story-pages">
   Scraping the Story Pages
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>World of Tales Online Story Collection</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#identify-books-available">
   Identify Books Available
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scraping-book-index-pages">
   Scraping Book Index Pages
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scraping-the-story-pages">
   Scraping the Story Pages
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="world-of-tales-online-story-collection">
<h1>World of Tales Online Story Collection<a class="headerlink" href="#world-of-tales-online-story-collection" title="Permalink to this headline">#</a></h1>
<p>The <a class="reference external" href="https://www.worldoftales.com/">World of Tales</a> website, published by Viktor Andonov, contains a wide range of tales extracted from a large number of out of copyright stroy collections.</p>
<p>The majority of the content is in the public domain.</p>
<p>A data download of the stories does not appear to be available: so let’s make one…</p>
<div class="section" id="identify-books-available">
<h2>Identify Books Available<a class="headerlink" href="#identify-books-available" title="Permalink to this headline">#</a></h2>
<p>The book collections are organised geographically, with geogprahpical regions listed in a sidebar on the website homepage. However, a full list of books is also available on a single page, with a regular structure describing each book.</p>
<p><img alt="" src="_images/world_of_tales_books.png" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># These packages make it easy to download web pages so that we can work with them</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="c1"># &quot;Cacheing&quot; pages mans grabbing a local copy of the page so we only need to download it once</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="n">requests_cache</span><span class="o">.</span><span class="n">install_cache</span><span class="p">(</span><span class="s1">&#39;web_cache&#39;</span><span class="p">,</span>
                             <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;sqlite&#39;</span><span class="p">,</span>
                             <span class="n">expire_after</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll be adding things to a database…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils</span> <span class="kn">import</span> <span class="n">Database</span>

<span class="n">db_name</span> <span class="o">=</span> <span class="s2">&quot;word_of_tales.db&quot;</span>

<span class="c1"># Uncomment the following lines to connect to a pre-existing database</span>
<span class="c1">#db = Database(db_name)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">books_index_url</span> <span class="o">=</span> <span class="s2">&quot;https://www.worldoftales.com/all_books.html&quot;</span>

<span class="c1"># And then grab the page</span>
<span class="n">html</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">books_index_url</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Each book description is contained in an HTML <code class="docutils literal notranslate"><span class="pre">div</span></code> element with class <code class="docutils literal notranslate"><span class="pre">box2</span> <span class="pre">GM</span> <span class="pre">books</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The BeautifulSoup package provides a range of tools</span>
<span class="c1"># that help us work with the downloaded web page,</span>
<span class="c1"># such as extracting particular elements from it</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="c1"># The &quot;soup&quot; is a parsed and structured form of the page we downloaded</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

<span class="c1"># We can use browser developer tools to grab a CSS selector</span>
<span class="c1"># for the books list, then extend it to pull just the links</span>
<span class="n">class_</span> <span class="o">=</span> <span class="s2">&quot;box2&quot;</span>
<span class="c1"># Find the span elements containing the links</span>
<span class="c1"># The first item is just a header</span>
<span class="n">items_</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">class_</span><span class="o">=</span><span class="n">class_</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

<span class="nb">len</span><span class="p">(</span><span class="n">items_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>73
</pre></div>
</div>
</div>
</div>
<p>The structure inside each record appears to be consistent, although some records have more fields than others.</p>
<p>Let’s see what a sample record looks like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">items_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;div align=&quot;justify&quot; class=&quot;box2 GM books&quot; style=&quot;margin-top:50px;&quot;&gt;
&lt;h2 class=&quot;GL&quot;&gt;&lt;a href=&quot;Chinese_wonder_book.html&quot;&gt;A Chinese Wonder Book&lt;/a&gt;&lt;/h2&gt;
&lt;span class=&quot;pic&quot;&gt;&lt;a href=&quot;Chinese_wonder_book.html&quot;&gt;&lt;img alt=&quot;Chinese folktales&quot; border=&quot;0&quot; height=&quot;165&quot; src=&quot;media/Chinese_folktales.jpg&quot; width=&quot;112&quot;/&gt;&lt;/a&gt;&lt;/span&gt;
&lt;p&gt;&lt;strong&gt;Notes&lt;/strong&gt;: Read 15 Chinese folktales &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Author&lt;/strong&gt;: Norman Hinsdale Pitman &lt;br/&gt;
&lt;strong&gt;Editor&lt;/strong&gt;: Andrew Lang &lt;br/&gt;
&lt;strong&gt;Published&lt;/strong&gt;: 1919&lt;br/&gt;
&lt;strong&gt;Publisher&lt;/strong&gt;: E. P. Dutton &amp;amp; Co., 681 Fifth Avenue, New York&lt;/p&gt;
&lt;br/&gt;
&lt;/div&gt;
</pre></div>
</div>
</div>
</div>
<p>Okay, so there is a mixture of paragrap and <code class="docutils literal notranslate"><span class="pre">&lt;br/&gt;</span></code> separated elements. Let’s treat things as lines. One of the easiest ways to do that is to view the record in a simple text form by casting the HTML to markdown.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">markdownify</span> <span class="kn">import</span> <span class="n">markdownify</span>

<span class="c1"># We can convert the soup element to html text</span>
<span class="c1"># by casting it as a string</span>
<span class="n">record_txt</span> <span class="o">=</span> <span class="n">markdownify</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">items_</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">record_txt</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;[A Chinese Wonder Book](Chinese_wonder_book.html)\n-------------------------------------------------\n\n\n[![Chinese folktales](media/Chinese_folktales.jpg)](Chinese_wonder_book.html)\n**Notes**: Read 15 Chinese folktales \n\n\n**Author**: Norman Hinsdale Pitman   \n\n**Editor**: Andrew Lang   \n\n**Published**: 1919  \n\n**Publisher**: E. P. Dutton &amp; Co., 681 Fifth Avenue, New York&#39;
</pre></div>
</div>
</div>
</div>
<p>This gives us a link in the heading, a book cover image, and then a series of metadata fields, each on a new line, with an emboldened header.</p>
<p>Let’s create a parser for that structure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># We could split on three or more &quot;-&quot; characters</span>
<span class="c1">#parts = [p.strip() for p in re.split(&quot;---+&quot;, record_txt)]</span>
<span class="c1"># However, not all the records hav a header defined that way</span>
<span class="c1"># (at least one is defined with a leading ###)</span>
<span class="c1"># Instead, remove any heading chars then break when we find the linked image</span>
<span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[-</span><span class="se">\n</span><span class="s2">\s]+\[&quot;</span><span class="p">,</span> <span class="n">record_txt</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())]</span>

<span class="n">parts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;[A Chinese Wonder Book](Chinese_wonder_book.html)&#39;,
 &#39;![Chinese folktales](media/Chinese_folktales.jpg)](Chinese_wonder_book.html)\n**Notes**: Read 15 Chinese folktales \n\n\n**Author**: Norman Hinsdale Pitman   \n\n**Editor**: Andrew Lang   \n\n**Published**: 1919  \n\n**Publisher**: E. P. Dutton &amp; Co., 681 Fifth Avenue, New York&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">parse</span> <span class="kn">import</span> <span class="n">parse</span>

<span class="n">title_parts</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{title}</span><span class="s2">](</span><span class="si">{path}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># This gives us the book title and the path to it</span>
<span class="p">(</span><span class="n">title_parts</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="n">title_parts</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;A Chinese Wonder Book&#39;, &#39;Chinese_wonder_book.html&#39;)
</pre></div>
</div>
</div>
</div>
<p>The next thing we need to do is extract out the image alt text, the image path, the book path, and the metadata lines:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Remember, we lost the opening [ in the split</span>
<span class="n">body_parts</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;![</span><span class="si">{alt}</span><span class="s2">](</span><span class="si">{img_path}</span><span class="s2">)](</span><span class="si">{path}</span><span class="s2">)</span><span class="si">{body}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="p">(</span><span class="n">body_parts</span><span class="p">[</span><span class="s2">&quot;alt&quot;</span><span class="p">],</span> <span class="n">body_parts</span><span class="p">[</span><span class="s2">&quot;img_path&quot;</span><span class="p">],</span> <span class="n">body_parts</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="n">body_parts</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;Chinese folktales&#39;,
 &#39;media/Chinese_folktales.jpg&#39;,
 &#39;Chinese_wonder_book.html&#39;,
 &#39;\n**Notes**: Read 15 Chinese folktales \n\n\n**Author**: Norman Hinsdale Pitman   \n\n**Editor**: Andrew Lang   \n\n**Published**: 1919  \n\n**Publisher**: E. P. Dutton &amp; Co., 681 Fifth Avenue, New York&#39;)
</pre></div>
</div>
</div>
</div>
<p>We could parse the metadata by splitting on the lines (<code class="docutils literal notranslate"><span class="pre">\n+</span></code>) and then extracting the metadata filed and text, but this may be a little brittle if metadata fields are split over several lines. So instead split on a new header:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metadata_</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">\s*\*&quot;</span><span class="p">,</span> <span class="n">body_parts</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())]</span>
<span class="n">metadata_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;**Notes**: Read 15 Chinese folktales&#39;,
 &#39;*Author**: Norman Hinsdale Pitman&#39;,
 &#39;*Editor**: Andrew Lang&#39;,
 &#39;*Published**: 1919&#39;,
 &#39;*Publisher**: E. P. Dutton &amp; Co., 681 Fifth Avenue, New York&#39;]
</pre></div>
</div>
</div>
</div>
<p>And make a dictionary from that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="p">:</span>
    <span class="n">m_parts</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;**:&quot;</span><span class="p">)</span>
    <span class="n">metadata</span><span class="p">[</span><span class="n">m_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">m_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="n">metadata</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;Notes&#39;: &#39;Read 15 Chinese folktales&#39;,
 &#39;Author&#39;: &#39;Norman Hinsdale Pitman&#39;,
 &#39;Editor&#39;: &#39;Andrew Lang&#39;,
 &#39;Published&#39;: &#39;1919&#39;,
 &#39;Publisher&#39;: &#39;E. P. Dutton &amp; Co., 681 Fifth Avenue, New York&#39;}
</pre></div>
</div>
</div>
</div>
<p>From a quick skim of the book page, at least the following fields appear (there may be others… I’m sure we’ll find them!): <em>Notes</em>, <em>Author</em>, <em>Editor</em>, <em>Translator</em>, <em>Translators</em>, <em>Published</em>, <em>Publisher</em>.</p>
<p>One simplification we might make when generating the metadata keys is to stem the key by removeing any trailing letter <em>s</em> (for example, using <code class="docutils literal notranslate"><span class="pre">.rstrip(&quot;s&quot;)</span></code>)</p>
<p>Let’s get all the book metadata:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="n">book_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract the metadata from each book record.&quot;&quot;&quot;</span>
    <span class="n">record_txt</span> <span class="o">=</span> <span class="n">markdownify</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">book_item</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># Instead, break when we find the linked image</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[-</span><span class="se">\n</span><span class="s2">\s]+\[&quot;</span><span class="p">,</span>
                                                 <span class="n">record_txt</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())]</span>
    
    <span class="c1"># Splitting when we find the image</span>
    <span class="c1"># HACK: in a couple of case, we have text after the link</span>
    <span class="c1"># For now, dump it and repair the break token...</span>
    <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="c1"># In at least one case, we need to strip embolden tags</span>
    <span class="n">title_parts</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{title}</span><span class="s2">](</span><span class="si">{path}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
    <span class="c1"># Remember, we have lost the opening [ in the split...</span>
    <span class="n">body_parts</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;![</span><span class="si">{alt}</span><span class="s2">](</span><span class="si">{img_path}</span><span class="s2">)](</span><span class="si">{path}</span><span class="s2">)</span><span class="si">{body}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">metadata_</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">\s*\*&quot;</span><span class="p">,</span> <span class="n">body_parts</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())]</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="p">:</span>
        <span class="n">m_parts</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;**:&quot;</span><span class="p">)</span>
        <span class="c1"># Simplify metadta keys by removing plurals</span>
        <span class="n">metadata</span><span class="p">[</span><span class="n">m_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">m_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># Clean the title </span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\s\n]+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span>  <span class="n">title_parts</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
    <span class="n">record</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
              <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">title_parts</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
              <span class="s2">&quot;img_alt&quot;</span><span class="p">:</span> <span class="n">body_parts</span><span class="p">[</span><span class="s2">&quot;alt&quot;</span><span class="p">],</span>
              <span class="s2">&quot;img_path&quot;</span><span class="p">:</span> <span class="n">body_parts</span><span class="p">[</span><span class="s2">&quot;img_path&quot;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="c1"># Use the py3.9 dict merge operator</span>
    <span class="n">record</span> <span class="o">=</span> <span class="n">record</span> <span class="o">|</span> <span class="n">metadata</span>

    <span class="k">return</span> <span class="n">record</span>
</pre></div>
</div>
</div>
</div>
<p>Extract the metadata for all the books:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">book_records</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items_</span><span class="p">:</span>
    <span class="n">book_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>

<span class="n">book_records</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;title&#39;: &#39;A Chinese Wonder Book&#39;,
  &#39;path&#39;: &#39;Chinese_wonder_book.html&#39;,
  &#39;img_alt&#39;: &#39;Chinese folktales&#39;,
  &#39;img_path&#39;: &#39;media/Chinese_folktales.jpg&#39;,
  &#39;Note&#39;: &#39;Read 15 Chinese folktales&#39;,
  &#39;Author&#39;: &#39;Norman Hinsdale Pitman&#39;,
  &#39;Editor&#39;: &#39;Andrew Lang&#39;,
  &#39;Published&#39;: &#39;1919&#39;,
  &#39;Publisher&#39;: &#39;E. P. Dutton &amp; Co., 681 Fifth Avenue, New York&#39;},
 {&#39;title&#39;: &#39;A Hundred fables of La Fontaine&#39;,
  &#39;path&#39;: &#39;fables/LaFontaine_fables.html&#39;,
  &#39;img_alt&#39;: &#39;La Fontaine book cover &#39;,
  &#39;img_path&#39;: &#39;media/La_Fontaine_book.jpg&#39;,
  &#39;Note&#39;: &#39;&quot;A Hundred fables of La Fontaine&quot; offers a selection of some of Jean de La Fontaine\&#39;s best known fables. These are all in verse.&#39;,
  &#39;Author&#39;: &#39;Jean de La Fontaine&#39;,
  &#39;Published&#39;: &#39;1900&#39;,
  &#39;Publisher&#39;: &#39;John Lane Co., London; New York&#39;},
 {&#39;title&#39;: &#39;A Treasury of Eskimo Tales&#39;,
  &#39;path&#39;: &#39;Treasury_Eskimo_Tales.html&#39;,
  &#39;img_alt&#39;: &#39;A Treasury of Eskimo Tales&#39;,
  &#39;img_path&#39;: &#39;media/Eskimo_Tales.jpg&#39;,
  &#39;Note&#39;: &#39;Contains 31 folktales gathered from the Eskimo living in North America.&#39;,
  &#39;Author&#39;: &#39;Clara Kern Bayliss&#39;,
  &#39;Published&#39;: &#39;1922&#39;,
  &#39;Publisher&#39;: &#39;Thomas Y. Crowell Company, USA&#39;}]
</pre></div>
</div>
</div>
</div>
<p>Get a superset list of all the metadata keys so we can define an appropiate metadata table in the database:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metadata_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">book_records</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
<span class="n">metadata_keys</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;Author&#39;,
 &#39;Compiler&#39;,
 &#39;Editor&#39;,
 &#39;Note&#39;,
 &#39;Published&#39;,
 &#39;Publisher&#39;,
 &#39;Translator&#39;,
 &#39;img_alt&#39;,
 &#39;img_path&#39;,
 &#39;path&#39;,
 &#39;title&#39;}
</pre></div>
</div>
</div>
</div>
<p>Let’s create a database table to store the metadata:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do not run this cell if your database already exists!</span>

<span class="c1"># While developing the script, recreate database each time...</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">recreate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># This schema has been evolved iteratively as I have identified structure</span>
<span class="c1"># that can be usefully mined...</span>

<span class="n">db</span><span class="p">[</span><span class="s2">&quot;books_metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;img_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;img_alt&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Author&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Compiler&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Editor&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Note&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Published&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;Publisher&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>   
    <span class="s2">&quot;Translator&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    
<span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">))</span>

<span class="c1"># Enable full text search</span>
<span class="c1"># This creates an extra virtual table (books_fts) to support the full text search</span>
<span class="n">db</span><span class="p">[</span><span class="s2">&quot;books_metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">enable_fts</span><span class="p">([</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Author&quot;</span><span class="p">,</span> <span class="s2">&quot;Translator&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;Compiler&quot;</span><span class="p">,</span> <span class="s2">&quot;Editor&quot;</span><span class="p">,</span> <span class="s2">&quot;Note&quot;</span><span class="p">,</span> <span class="s2">&quot;Publisher&quot;</span><span class="p">],</span> <span class="n">create_triggers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Table books_metadata (title, path, img_path, img_alt, Author, Compiler, Editor, Note, Published, Publisher, Translator)&gt;
</pre></div>
</div>
</div>
</div>
<p>Now we can add our data to it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;books_metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upsert_all</span><span class="p">(</span><span class="n">book_records</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Table books_metadata (title, path, img_path, img_alt, Author, Compiler, Editor, Note, Published, Publisher, Translator)&gt;
</pre></div>
</div>
</div>
</div>
<p>Try a query:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM books_metadata LIMIT 3&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;title&#39;: &#39;A Chinese Wonder Book&#39;, &#39;path&#39;: &#39;Chinese_wonder_book.html&#39;, &#39;img_path&#39;: &#39;media/Chinese_folktales.jpg&#39;, &#39;img_alt&#39;: &#39;Chinese folktales&#39;, &#39;Author&#39;: &#39;Norman Hinsdale Pitman&#39;, &#39;Compiler&#39;: None, &#39;Editor&#39;: &#39;Andrew Lang&#39;, &#39;Note&#39;: &#39;Read 15 Chinese folktales&#39;, &#39;Published&#39;: &#39;1919&#39;, &#39;Publisher&#39;: &#39;E. P. Dutton &amp; Co., 681 Fifth Avenue, New York&#39;, &#39;Translator&#39;: None}
{&#39;title&#39;: &#39;A Hundred fables of La Fontaine&#39;, &#39;path&#39;: &#39;fables/LaFontaine_fables.html&#39;, &#39;img_path&#39;: &#39;media/La_Fontaine_book.jpg&#39;, &#39;img_alt&#39;: &#39;La Fontaine book cover &#39;, &#39;Author&#39;: &#39;Jean de La Fontaine&#39;, &#39;Compiler&#39;: None, &#39;Editor&#39;: None, &#39;Note&#39;: &#39;&quot;A Hundred fables of La Fontaine&quot; offers a selection of some of Jean de La Fontaine\&#39;s best known fables. These are all in verse.&#39;, &#39;Published&#39;: &#39;1900&#39;, &#39;Publisher&#39;: &#39;John Lane Co., London; New York&#39;, &#39;Translator&#39;: None}
{&#39;title&#39;: &#39;A Treasury of Eskimo Tales&#39;, &#39;path&#39;: &#39;Treasury_Eskimo_Tales.html&#39;, &#39;img_path&#39;: &#39;media/Eskimo_Tales.jpg&#39;, &#39;img_alt&#39;: &#39;A Treasury of Eskimo Tales&#39;, &#39;Author&#39;: &#39;Clara Kern Bayliss&#39;, &#39;Compiler&#39;: None, &#39;Editor&#39;: None, &#39;Note&#39;: &#39;Contains 31 folktales gathered from the Eskimo living in North America.&#39;, &#39;Published&#39;: &#39;1922&#39;, &#39;Publisher&#39;: &#39;Thomas Y. Crowell Company, USA&#39;, &#39;Translator&#39;: None}
</pre></div>
</div>
</div>
</div>
<p>We can also search for books using free text search over the metadata:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;Langmans&quot;</span> <span class="c1"># This is a publisher</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search on: </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">story</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;books_metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">quote_fts</span><span class="p">(</span><span class="n">q</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">story</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Search on: Langmans

{&#39;rowid&#39;: 60, &#39;title&#39;: &#39;The Green Fairy Book&#39;, &#39;path&#39;: &#39;fairy_tales/Andrew_Lang_green_fairy_tale_book.html&#39;, &#39;img_path&#39;: &#39;media/green_fairy_book.jpg&#39;, &#39;img_alt&#39;: &#39;Green fairy book Andrew Lang cover&#39;, &#39;Author&#39;: &#39;Various&#39;, &#39;Compiler&#39;: None, &#39;Editor&#39;: &#39;Andrew Lang&#39;, &#39;Note&#39;: &quot;The third book from Andrew Lang&#39;s collection was first published in 1892 and contains 42 fairy tales.&quot;, &#39;Published&#39;: &#39;1892&#39;, &#39;Publisher&#39;: &#39;Langmans, Green, and Co., London; New York&#39;, &#39;Translator&#39;: None}
{&#39;rowid&#39;: 66, &#39;title&#39;: &#39;The Red Fairy Book&#39;, &#39;path&#39;: &#39;fairy_tales/Andrew_Lang_red_fairy_tale_book.html&#39;, &#39;img_path&#39;: &#39;media/red_fairy_book.jpg&#39;, &#39;img_alt&#39;: &#39;Red fairy book Andrew Lang cover&#39;, &#39;Author&#39;: &#39;Various&#39;, &#39;Compiler&#39;: None, &#39;Editor&#39;: &#39;Andrew Lang&#39;, &#39;Note&#39;: &quot;The second book from Andrew Lang&#39;s collection was first published in 1890 and contains 37 fairy tales.&quot;, &#39;Published&#39;: &#39;1890&#39;, &#39;Publisher&#39;: &#39;Langmans, Green, and Co., London; New York&#39;, &#39;Translator&#39;: None}
{&#39;rowid&#39;: 58, &#39;title&#39;: &#39;The Blue Fairy Book&#39;, &#39;path&#39;: &#39;fairy_tales/Andrew_Lang_blue_fairy_tale_book.html&#39;, &#39;img_path&#39;: &#39;media/blue_fairy_book.jpg&#39;, &#39;img_alt&#39;: &#39;Blue fairy book Andrew Lang cover&#39;, &#39;Author&#39;: &#39;Various&#39;, &#39;Compiler&#39;: None, &#39;Editor&#39;: &#39;Andrew Lang&#39;, &#39;Note&#39;: &#39;The first of a collection of twelve fairy tale books, gathered by Andrew Lang from various sources. Published in 1889, the Blue Fairy Book contains 37 stories.&#39;, &#39;Published&#39;: &#39;1889&#39;, &#39;Publisher&#39;: &#39;Langmans, Green, and Co., London; New York&#39;, &#39;Translator&#39;: None}
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="scraping-book-index-pages">
<h2>Scraping Book Index Pages<a class="headerlink" href="#scraping-book-index-pages" title="Permalink to this headline">#</a></h2>
<p>The book index pages have links to separate pages for each story.</p>
<p>We need to grab the links to the story pages so we can then scrape each story.</p>
<p>From a quick glance, it looks like links can be found listed in a <code class="docutils literal notranslate"><span class="pre">div</span></code> element with selector <code class="docutils literal notranslate"><span class="pre">p.GM</span> <span class="pre">&gt;</span> <span class="pre">a</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://www.worldoftales.com/&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get an example page</span>
<span class="n">html</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">book_records</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

<span class="n">items_</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;p.GM &gt; a&quot;</span><span class="p">)]</span>
<span class="n">items_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;1.The Golden Beetle or Why the Dog Hates the Cat&#39;,
  &#39;Asian_folktales/Chinese_Folktale_1.html&#39;),
 (&#39;2.The Great Bell&#39;, &#39;Asian_folktales/Chinese_Folktale_2.html&#39;),
 (&#39;3.The Strange Tale of Doctor Dog&#39;,
  &#39;Asian_folktales/Chinese_Folktale_3.html&#39;),
 (&#39;4.How Footbinding Started&#39;, &#39;Asian_folktales/Chinese_Folktale_4.html&#39;),
 (&#39;5.The Talking Fish&#39;, &#39;Asian_folktales/Chinese_Folktale_5.html&#39;),
 (&#39;6.Bamboo and the Turtle&#39;, &#39;Asian_folktales/Chinese_Folktale_6.html&#39;),
 (&#39;7.The Mad Goose and the Tiger Forest&#39;,
  &#39;Asian_folktales/Chinese_Folktale_7.html&#39;),
 (&#39;8.The Nodding Tiger&#39;, &#39;Asian_folktales/Chinese_Folktale_8.html&#39;),
 (&#39;9.The Princess Kwan-Yin&#39;, &#39;Asian_folktales/Chinese_Folktale_9.html&#39;),
 (&#39;10.The Two Jugglers&#39;, &#39;Asian_folktales/Chinese_Folktale_10.html&#39;),
 (&#39;11.The Phantom Vessel&#39;, &#39;Asian_folktales/Chinese_Folktale_11.html&#39;),
 (&#39;12.The Wooden Tablet&#39;, &#39;Asian_folktales/Chinese_Folktale_12.html&#39;),
 (&#39;13.The Golden Nugget&#39;, &#39;Asian_folktales/Chinese_Folktale_13.html&#39;),
 (&#39;14.The Man Who Would Not Scold&#39;,
  &#39;Asian_folktales/Chinese_Folktale_14.html&#39;),
 (&#39;15.Lu-San, Daughter of Heaven&#39;, &#39;Asian_folktales/Chinese_Folktale_15.html&#39;)]
</pre></div>
</div>
</div>
</div>
<p>Let’s see if we can do that for everything…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">storylinks</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">book_records</span><span class="p">:</span>
    <span class="n">story_links</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">book</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

    <span class="n">book</span><span class="p">[</span><span class="s2">&quot;storylinks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;p.GM &gt; a&quot;</span><span class="p">)]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">book</span><span class="p">[</span><span class="s2">&quot;storylinks&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1"> found for </span><span class="si">{</span><span class="n">book</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>15 found for A Chinese Wonder Book
0 found for A Hundred fables of La Fontaine
0 found for A Treasury of Eskimo Tales
0 found for Aesop&#39;s fables
0 found for Andersen&#39;s fairy tales
32 found for Australian Legendary Tales
0 found for Canadian fairy tales
27 found for Celtic Fairy Tales
8 found for Child-Life in Japan and Japanese Child Stories
11 found for Chinese Folk-lore Tales
0 found for Christmas stories
28 found for Cossack Fairy Tales and Folk Tales
16 found for Czechoslovak Fairy Tales
0 found for Dutch Fairy Tales for Young Folks
0 found for East of the Sun and West of the Moon
0 found for English Fairy Tales
0 found for English Fairy Tales
12 found for Fairies and Folk of Ireland
18 found for Fairy tales from Brazil
0 found for Fairy Tales from the German Forests
21 found for Fairy Tales of the Slav Peasants and Herdsmen
0 found for Folk-lore and Legends: Germany
0 found for Folk-Lore and Legends: Oriental
0 found for Folk-lore and Legends: Scandinavia
34 found for Folk-Lore and Legends: Scotland
1 found for Folk Stories from Southern Nigeria
10 found for Folk Tales from the Russian
0 found for Green willow and other Japanese fairy tales
0 found for Grimm&#39;s Fairy Stories
0 found for Grimm&#39;s fairy tales
0 found for Hans Andersen&#39;s Fairy Tales
0 found for Hans Andersen&#39;s Fairy Tales Second Series
0 found for Hindu Tales from the Sanskrit
0 found for Household Stories by the Brothers Grimm
0 found for Household tales by the Brothers Grimm
0 found for Indian fairy tales
8 found for Irish Fairy Tales
0 found for Japanese fairy tales
0 found for Momotaro or Little Peachling
0 found for More English Fairy Tales
20 found for Myths and Folk Tales of Ireland
0 found for Myths And Legends Of Our Own Land Vol. I The Hudson And Its Hills
0 found for Myths And Legends Of Our Own Land Vol. II The isle of Manhattoes and nearby
40 found for Old French fairy tales
0 found for Old Hendrik&#39;s Tales
0 found for Old Indian legends
22 found for Old Peter&#39;s Russian tales
0 found for Outa Karel&#39;s Stories South African Folk-Lore Tales
0 found for Philippine Folk Tales
8 found for Polish Fairy Tales
18 found for Roumanian Fairy Tales
32 found for Stories from Pentamerone
6 found for Stories of King Arthur&#39;s Knights
22 found for Tales from the Lands of Nuts and Grapes Spanish and Portuguese Folklore
12 found for Tales of Giants from Brazil
0 found for Tales of the Sun or Folklore of Southern India
17 found for The adventures of Maya the bee
0 found for The Arabian Nights /One Thousand and One Nights/
0 found for The Blue Fairy Book
0 found for The Chinese Fairy Book
0 found for The Green Fairy Book
0 found for The Indian Fairy Book
35 found for The Islands of Magic Legends, Folk and Fairy Tales from the Azores
15 found for The Laughing Prince
0 found for The Magic Bed
0 found for The Oriental Story Book
0 found for The Red Fairy Book
18 found for The Russian Garland
21 found for The Shoemaker&#39;s Apron
0 found for The Swedish Fairy Book
0 found for The Tales of Mother Goose
24 found for Welsh Fairy-Tales And Other Stories
0 found for Zanzibar Tales
</pre></div>
</div>
</div>
</div>
<p>Okay, so that strategy doesn’t work for quite a lot of the index pages…</p>
<p>What if we just grab <em>all</em> the links, and then use the heuristic that the chapter link text appears to start with a numerical indicator, followed by a <code class="docutils literal notranslate"><span class="pre">.</span></code>, and then the title (for example, <code class="docutils literal notranslate"><span class="pre">3.</span></code>, <code class="docutils literal notranslate"><span class="pre">IX.</span></code>), at least for the pages I looked at…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;1&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;1&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">book_records</span><span class="p">:</span>
    <span class="c1"># We&#39;ve cached the pages, so requesting them again is fine...</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">book</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
    <span class="c1"># It seems we have a number, then a . at the start of many pages</span>
    <span class="n">story_links</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="c1"># Extract out a number</span>
            <span class="n">a_</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># Does it look like a nunmerical index value, howsoever defined</span>
            <span class="k">if</span> <span class="n">a_</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a_</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;ivxl&quot;</span><span class="p">]:</span>
                <span class="n">href</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">)</span>
                <span class="c1"># NOTE: the paths are relative, so we need to fix any</span>
                <span class="c1"># relative offsets</span>
                <span class="n">_path</span> <span class="o">=</span> <span class="n">book</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_path</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">href</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">href</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">story_links</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">a_</span><span class="p">,</span>
                                    <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                                    <span class="n">href</span><span class="p">))</span>

    <span class="n">book</span><span class="p">[</span><span class="s2">&quot;storylinks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">story_links</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">book</span><span class="p">[</span><span class="s2">&quot;storylinks&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1"> found for </span><span class="si">{</span><span class="n">book</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>15 found for A Chinese Wonder Book
20 found for A Hundred fables of La Fontaine
32 found for A Treasury of Eskimo Tales
16 found for Aesop&#39;s fables
18 found for Andersen&#39;s fairy tales
32 found for Australian Legendary Tales
27 found for Canadian fairy tales
27 found for Celtic Fairy Tales
8 found for Child-Life in Japan and Japanese Child Stories
11 found for Chinese Folk-lore Tales
16 found for Christmas stories
28 found for Cossack Fairy Tales and Folk Tales
16 found for Czechoslovak Fairy Tales
21 found for Dutch Fairy Tales for Young Folks
16 found for East of the Sun and West of the Moon
44 found for English Fairy Tales
41 found for English Fairy Tales
12 found for Fairies and Folk of Ireland
18 found for Fairy tales from Brazil
10 found for Fairy Tales from the German Forests
21 found for Fairy Tales of the Slav Peasants and Herdsmen
0 found for Folk-lore and Legends: Germany
25 found for Folk-Lore and Legends: Oriental
28 found for Folk-lore and Legends: Scandinavia
34 found for Folk-Lore and Legends: Scotland
41 found for Folk Stories from Southern Nigeria
10 found for Folk Tales from the Russian
39 found for Green willow and other Japanese fairy tales
25 found for Grimm&#39;s Fairy Stories
62 found for Grimm&#39;s fairy tales
21 found for Hans Andersen&#39;s Fairy Tales
29 found for Hans Andersen&#39;s Fairy Tales Second Series
10 found for Hindu Tales from the Sanskrit
52 found for Household Stories by the Brothers Grimm
211 found for Household tales by the Brothers Grimm
30 found for Indian fairy tales
8 found for Irish Fairy Tales
23 found for Japanese fairy tales
0 found for Momotaro or Little Peachling
45 found for More English Fairy Tales
20 found for Myths and Folk Tales of Ireland
46 found for Myths And Legends Of Our Own Land Vol. I The Hudson And Its Hills
15 found for Myths And Legends Of Our Own Land Vol. II The isle of Manhattoes and nearby
40 found for Old French fairy tales
13 found for Old Hendrik&#39;s Tales
14 found for Old Indian legends
22 found for Old Peter&#39;s Russian tales
16 found for Outa Karel&#39;s Stories South African Folk-Lore Tales
67 found for Philippine Folk Tales
8 found for Polish Fairy Tales
18 found for Roumanian Fairy Tales
32 found for Stories from Pentamerone
6 found for Stories of King Arthur&#39;s Knights
22 found for Tales from the Lands of Nuts and Grapes Spanish and Portuguese Folklore
12 found for Tales of Giants from Brazil
35 found for Tales of the Sun or Folklore of Southern India
17 found for The adventures of Maya the bee
35 found for The Arabian Nights /One Thousand and One Nights/
37 found for The Blue Fairy Book
75 found for The Chinese Fairy Book
42 found for The Green Fairy Book
26 found for The Indian Fairy Book
35 found for The Islands of Magic Legends, Folk and Fairy Tales from the Azores
15 found for The Laughing Prince
6 found for The Magic Bed
7 found for The Oriental Story Book
37 found for The Red Fairy Book
18 found for The Russian Garland
21 found for The Shoemaker&#39;s Apron
29 found for The Swedish Fairy Book
8 found for The Tales of Mother Goose
23 found for Welsh Fairy-Tales And Other Stories
11 found for Zanzibar Tales
</pre></div>
</div>
</div>
</div>
<p>That looks much more interesting with just a couple of exceptions… The <em>Momotaro</em> contains just a single story on the index page, and <em>Folk-lore and Legends: Germany</em> actually points to a list of books that we already have.</p>
<p>Our book records should now be annotated with links to their stories:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">book_records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;title&#39;: &#39;A Chinese Wonder Book&#39;,
 &#39;path&#39;: &#39;Chinese_wonder_book.html&#39;,
 &#39;img_alt&#39;: &#39;Chinese folktales&#39;,
 &#39;img_path&#39;: &#39;media/Chinese_folktales.jpg&#39;,
 &#39;Note&#39;: &#39;Read 15 Chinese folktales&#39;,
 &#39;Author&#39;: &#39;Norman Hinsdale Pitman&#39;,
 &#39;Editor&#39;: &#39;Andrew Lang&#39;,
 &#39;Published&#39;: &#39;1919&#39;,
 &#39;Publisher&#39;: &#39;E. P. Dutton &amp; Co., 681 Fifth Avenue, New York&#39;,
 &#39;storylinks&#39;: [(&#39;1&#39;,
   &#39;The Golden Beetle or Why the Dog Hates the Cat&#39;,
   &#39;Asian_folktales/Chinese_Folktale_1.html&#39;),
  (&#39;2&#39;, &#39;The Great Bell&#39;, &#39;Asian_folktales/Chinese_Folktale_2.html&#39;),
  (&#39;3&#39;,
   &#39;The Strange Tale of Doctor Dog&#39;,
   &#39;Asian_folktales/Chinese_Folktale_3.html&#39;),
  (&#39;4&#39;, &#39;How Footbinding Started&#39;, &#39;Asian_folktales/Chinese_Folktale_4.html&#39;),
  (&#39;5&#39;, &#39;The Talking Fish&#39;, &#39;Asian_folktales/Chinese_Folktale_5.html&#39;),
  (&#39;6&#39;, &#39;Bamboo and the Turtle&#39;, &#39;Asian_folktales/Chinese_Folktale_6.html&#39;),
  (&#39;7&#39;,
   &#39;The Mad Goose and the Tiger Forest&#39;,
   &#39;Asian_folktales/Chinese_Folktale_7.html&#39;),
  (&#39;8&#39;, &#39;The Nodding Tiger&#39;, &#39;Asian_folktales/Chinese_Folktale_8.html&#39;),
  (&#39;9&#39;, &#39;The Princess Kwan-Yin&#39;, &#39;Asian_folktales/Chinese_Folktale_9.html&#39;),
  (&#39;10&#39;, &#39;The Two Jugglers&#39;, &#39;Asian_folktales/Chinese_Folktale_10.html&#39;),
  (&#39;11&#39;, &#39;The Phantom Vessel&#39;, &#39;Asian_folktales/Chinese_Folktale_11.html&#39;),
  (&#39;12&#39;, &#39;The Wooden Tablet&#39;, &#39;Asian_folktales/Chinese_Folktale_12.html&#39;),
  (&#39;13&#39;, &#39;The Golden Nugget&#39;, &#39;Asian_folktales/Chinese_Folktale_13.html&#39;),
  (&#39;14&#39;,
   &#39;The Man Who Would Not Scold&#39;,
   &#39;Asian_folktales/Chinese_Folktale_14.html&#39;),
  (&#39;15&#39;,
   &#39;Lu-San, Daughter of Heaven&#39;,
   &#39;Asian_folktales/Chinese_Folktale_15.html&#39;)]}
</pre></div>
</div>
</div>
</div>
<p>We could create a simple database table at this point to just how the titles, but let’s wait until we have the story text and then create a more complete table.</p>
</div>
<div class="section" id="scraping-the-story-pages">
<h2>Scraping the Story Pages<a class="headerlink" href="#scraping-the-story-pages" title="Permalink to this headline">#</a></h2>
<p>The next step is to scrape a story page. Once again, let’s assume there is a regular structure, build a scraper for a single story, selected more or less at random, and then see how far we get…</p>
<p>From a skim of some pages, it looks like we might be in a luck, with the text appearing in a <code class="docutils literal notranslate"><span class="pre">div</span></code> tag with <code class="docutils literal notranslate"><span class="pre">id=text</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get an example page</span>
<span class="n">html</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">book_records</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;storylinks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

<span class="n">markdownify</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;#text&quot;</span><span class="p">)))[:</span><span class="mi">100</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;[\nWhat we shall eat to-morrow, I haven\&#39;t the slightest idea!&quot; said Widow Wang to her eldest son, as &#39;
</pre></div>
</div>
</div>
</div>
<p>So… are we lucky?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">get_story</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">nice</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get story text.&quot;&quot;&quot;</span>
    <span class="c1"># Be nice in the scrape</span>
    <span class="k">if</span> <span class="n">nice</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nice</span><span class="p">)</span>

    <span class="n">html</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">markdownify</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;#text&quot;</span><span class="p">)))</span>
    
    <span class="k">return</span> <span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">txt</span>
</pre></div>
</div>
</div>
</div>
<p>We have a cache set up, so for now it doesn’t matter if we keep requesting pages (the cache will handle repeated requests.) We’ve also added a delay into the page request to try to be nice to the hosting server.</p>
<p>Let’s try to track down books where we don’t appear to be getting stories back:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">book_records</span><span class="p">):</span>
    <span class="c1"># Once the requests cache has been built, we don&#39;t need to be nice</span>
    <span class="c1"># and can set the delay to 0</span>
    <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">book</span><span class="p">[</span><span class="s2">&quot;storylinks&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">get_story</span><span class="p">(</span><span class="n">book</span><span class="p">[</span><span class="s2">&quot;storylinks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">delay</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span> <span class="c1"># i.e. not may characters</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No story text for: </span><span class="si">{</span><span class="n">book</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> on </span><span class="si">{</span><span class="n">book</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> at </span><span class="si">{</span><span class="n">book</span><span class="p">[</span><span class="s2">&quot;storylinks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8a9f768962694638ba9e3c3790efd4d1", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No story text for: A Hundred fables of La Fontaine on fables/LaFontaine_fables.html at (&#39;I&#39;, &#39;1.The Grasshopper and the Ant; 2.The Thieves and the Ass; 3.The Wolf Accusing the Fox; 4.The Lion and the Ass Hunting; 5.The Wolf turned Shepherd&#39;, &#39;fables/LaFontaine_fables/LaFontaine_Fables_1.html&#39;)
</pre></div>
</div>
</div>
</div>
<p>Let’s add that to a database.</p>
<p>First, create a story table:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;tales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;book&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;chapter&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;book&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">))</span>

<span class="c1"># Enable full text search</span>
<span class="c1"># This creates an extra virtual table (books_fts) to support the full text search</span>
<span class="n">db</span><span class="p">[</span><span class="s2">&quot;tales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">enable_fts</span><span class="p">([</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">create_triggers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Table tales (title, path, book, text, chapter)&gt;
</pre></div>
</div>
</div>
</div>
<p>And add all the tales to it…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">book_records</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;title&#39;: &#39;A Hundred fables of La Fontaine&#39;,
 &#39;path&#39;: &#39;fables/LaFontaine_fables.html&#39;,
 &#39;img_alt&#39;: &#39;La Fontaine book cover &#39;,
 &#39;img_path&#39;: &#39;media/La_Fontaine_book.jpg&#39;,
 &#39;Note&#39;: &#39;&quot;A Hundred fables of La Fontaine&quot; offers a selection of some of Jean de La Fontaine\&#39;s best known fables. These are all in verse.&#39;,
 &#39;Author&#39;: &#39;Jean de La Fontaine&#39;,
 &#39;Published&#39;: &#39;1900&#39;,
 &#39;Publisher&#39;: &#39;John Lane Co., London; New York&#39;,
 &#39;storylinks&#39;: [(&#39;I&#39;,
   &#39;1.The Grasshopper and the Ant; 2.The Thieves and the Ass; 3.The Wolf Accusing the Fox; 4.The Lion and the Ass Hunting; 5.The Wolf turned Shepherd&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_1.html&#39;),
  (&#39;II&#39;,
   &#39;1.The Swan and the Cook; 2.The Weasel in the Granary; 3.The Shepherd and the Sea; 4.The Ass and the Little Dog; 5.The Man and the Wooden God&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_2.html&#39;),
  (&#39;III&#39;,
   &#39;1.The Ears of the Hare; 2.The Old Woman and Her Servants; 3.The Ass Carrying Relics; 4.The Hare and the Partridge; 5.The Lion Going to War&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_3.html&#39;),
  (&#39;IV&#39;,
   &#39;1.The Old Man and the Ass; 2.The Ass and his Masters; 3.The Wax-Candle; 4.The Shepherd and his Flock; 5.The Tortoise and the Two Ducks&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_4.html&#39;),
  (&#39;V&#39;,
   &#39;1.The Two Asses; 2.The Shepherd and his Dog; 3.The Two Mules; 4.The Heifer, the Goat, and the Sheep; 5.The Two Rats, the Fox and the Egg&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_5.html&#39;),
  (&#39;VI&#39;,
   &#39;1.The Man and his Image; 2.The Dragon with Many Heads; 3.Death and the Woodman; 4.The Hornets and the Bees; 5.The Oak and the Reed&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_6.html&#39;),
  (&#39;VII&#39;,
   &#39;1.The Council held by the Rats; 2.The Two Bulls and the Frog; 3.The Bat and the Two Weasels; 4.The Bird wounded by an Arrow; 5.The Lion and the Gnat&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_7.html&#39;),
  (&#39;VIII&#39;,
   &#39;1.The Ass Loaded with Sponges; 2.The Dove and the Ant; 3.The Cock and the Fox; 4.The Lion beaten by the Man; 5.Philomel and Progne&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_8.html&#39;),
  (&#39;XI&#39;,
   &#39;1.The Camel and the Floating Sticks; 2.The Wolf, the Goat and the Kid; 3.The Rat Retired from the World; 4.The Cunning Fox; 5.The Ape&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_9.html&#39;),
  (&#39;X&#39;,
   &#39;1.The Fox, the Flies, and the Hedgehog; 2.The Eagle and the Magpie; 3.The Lion and the Hunter; 4.The Fox, the Monkey, and the Animals; 5.The Sun and the Frogs&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_10.html&#39;),
  (&#39;XI&#39;,
   &quot;1.The Countryman and the Serpent; 2.The Carter in the Mire; 3.The Heron; 4.The Head and the Tail of the Serpent; 5.The Dog And His Master&#39;s Dinner&quot;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_11.html&#39;),
  (&#39;XII&#39;,
   &#39;1.The Joker and the Fishes; 2.The Rat and the Oyster; 3.The Hog, the Goat, and the Sheep; 4.The Rat and the Elephant; 5.The Ass and the Dog&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_12.html&#39;),
  (&#39;XIII&#39;,
   &#39;1.Education; 2.The Two Dogs and the Dead Ass; 3.The Monkey and the Leopard; 4.The Acorn and the Pumpkin; 5.The fool who sold wisdom&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_13.html&#39;),
  (&#39;XIV&#39;,
   &#39;1.The Oyster and the Litigants; 2.The Wolf and the Lean Dog; 3.Nothing too Much; 4.The Cat and the Fox; 5.The Monkey and the Cat&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_14.html&#39;),
  (&#39;XV&#39;,
   &#39;1.The Spider and the Swallow; 2.The Dog whose Ears were Cropped; 3.The Lioness and the Bear; 4.The Mice and the Owl; 5.The Cat and the Two Sparrows&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_15.html&#39;),
  (&#39;XVI&#39;,
   &#39;1.The Two Goats; 2.The Old Cat and the Young Mouse; 3.The Sick Stag; 4.The Quarrel of the Dogs and Cats; 5.The Wolf and the Fox&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_16.html&#39;),
  (&#39;XVII&#39;,
   &quot;1.The Lobster and her Daughter; 2.The Ploughman and his Sons; 3.The Ass Dressed in the Lion&#39;s Skin; 4.The Lion and the Ass Hunting; 5.The Fox, the Wolf, and the horse&quot;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_17.html&#39;),
  (&#39;XVIII&#39;,
   &#39;1.The Fox and the Turkeys; 2.The Wallet; 3.The Woodman and Mercury; 4.The Lion and the Monkey; 5.The Shepherd and the Lion&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_18.html&#39;),
  (&#39;XIX&#39;,
   &#39;1.The Horse and the Wolf; 2.The Eagle and the Owl; 3.The Miser and the Monkey; 4.The Vultures and the Pigeons; 5.The Stag and the Vine&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_19.html&#39;),
  (&#39;XX&#39;,
   &#39;1.The Earthen Pot and the Iron Pot; 2.The Bear and the Two Companions; 3.The Lion, the Wolf, and the Fox; 4.The Battle of the Rats and Weasels; 5.The Animals Sick of the Plague&#39;,
   &#39;fables/LaFontaine_fables/LaFontaine_Fables_20.html&#39;)]}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">book_records</span><span class="p">):</span>
    <span class="n">tales</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">book</span><span class="p">[</span><span class="s2">&quot;storylinks&quot;</span><span class="p">]:</span>
        <span class="c1"># If have the cache - no delay necessary</span>
        <span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_story</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">5</span><span class="p">:</span>
            <span class="n">tales</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;book&quot;</span><span class="p">:</span> <span class="n">book</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span>
                          <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                          <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">link</span><span class="p">,</span>
                          <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">txt</span><span class="p">,</span>
                          <span class="s2">&quot;chapter&quot;</span><span class="p">:</span> <span class="n">num</span><span class="p">}</span>
                        <span class="p">)</span>

    <span class="n">db</span><span class="p">[</span><span class="s2">&quot;tales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upsert_all</span><span class="p">(</span><span class="n">tales</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;book&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "718ca78a0bbe4da98e7de1546e13ccd6", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Let’s check we have some tales…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM tales LIMIT 1&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;title&#39;: &#39;The Golden Beetle or Why the Dog Hates the Cat&#39;, &#39;path&#39;: &#39;[&quot;1&quot;, &quot;The Golden Beetle or Why the Dog Hates the Cat&quot;, &quot;Asian_folktales/Chinese_Folktale_1.html&quot;]&#39;, &#39;book&#39;: &#39;A Chinese Wonder Book&#39;, &#39;text&#39;: &#39;[\nWhat we shall eat to-morrow, I haven\&#39;t the slightest idea!&quot; said Widow Wang to her eldest son, as he started out one morning in search of work. \n\n\n &quot;Oh, the gods will provide. I\&#39;ll find a few coppers somewhere,&quot; replied the boy, trying to speak cheerfully, although in his heart he also had not the slightest idea in which direction to turn. \n\n\n The winter had been a hard one: extreme cold, deep snow, and violent winds. The Wang house had suffered greatly. The roof had fallen in, weighed down by heavy snow. Then a hurricane had blown a wall over, and Ming-li, the son, up all night and exposed to a bitter cold wind, had caught pneumonia. Long days of illness followed, with the spending of extra money for medicine. All their scant savings had soon melted away, and at the shop where Ming-li had been employed his place was filled by another. When at last he arose from his sick-bed he was too weak for hard labour and there seemed to be no work in the neighbouring villages for him to do. Night after night he came home, trying not to be discouraged, but in his heart feeling the deep pangs of sorrow that come to the good son who sees his mother suffering for want of food and clothing. \n\n\n &quot;Bless his good heart!&quot; said the poor widow after he had gone. &quot;No mother ever had a better boy. I hope he is right in saying the gods will provide. It has been getting so much worse these past few weeks that it seems now as if my stomach were as empty as a rich man\&#39;s brain. Why, even the rats have deserted our cottage, and there\&#39;s nothing left for poor Tabby, while old Blackfoot is nearly dead from starvation.&quot; \n\n\n When the old woman referred to the sorrows of her pets, her remarks were answered by a pitiful mewing and woebegone barking from the corner where the two unfed creatures were curled up together trying to keep warm. \n\n\n Just then there was a loud knocking at the gate. When the widow Wang called out, &quot;Come in!&quot; she was surprised to see an old bald-headed priest standing in the doorway. &quot;Sorry, but we have nothing,&quot; she went on, feeling sure the visitor had come in search of food. &quot;We have fed on scraps these two weeks—on scraps and scrapings—and now we are living on the memories of what we used to have when my son\&#39;s father was living. Our cat was so fat she couldn\&#39;t climb to the roof. Now look at her. You can hardly see her, she\&#39;s so thin. No, I\&#39;m sorry we can\&#39;t help you, friend priest, but you see how it is.&quot; \n\n\n &quot;I didn\&#39;t come for alms,&quot; cried the clean-shaven one, looking at her kindly, &quot;but only to see what I could do to help you. The gods have listened long to the prayers of your devoted son. They honour him because he has not waited till you die to do sacrifice for you. They have seen how faithfully he has served you ever since his illness, and now, when he is worn out and unable to work, they are resolved to reward him for his virtue. You likewise have been a good mother and shall receive the gift I am now bringing.&quot; \n\n\n &quot;What do you mean?&quot; faltered Mrs. Wang, hardly believing her ears at hearing a priest speak of bestowing mercies. &quot;Have you come here to laugh at our misfortunes?&quot; \n\n\n &quot;By no means. Here in my hand I hold a tiny golden beetle which you will find has a magic power greater than any you ever dreamed of. I will leave this precious thing with you, a present from the god of filial conduct.&quot; \n\n\n &quot;Yes, it will sell for a good sum,&quot; murmured the other, looking closely at the trinket, &quot;and will give us millet for several days. Thanks, good priest, for your kindness.&quot; \n\n\n &quot;But you must by no means sell this golden beetle, for it has the power to fill your stomachs as long as you live.&quot; \n\n\n The widow stared in open-mouthed wonder at the priest\&#39;s surprising words. \n\n\n &quot;Yes, you must not doubt me, but listen carefully to what I tell you. Whenever you wish food, you have only to place this ornament in a kettle of boiling water, saying over and over again the names of what you want to eat. In three minutes take off the lid, and there will be your dinner, smoking hot, and cooked more perfectly than any food you have ever eaten.&quot; \n\n\n &quot;May I try it now?&quot; she asked eagerly. \n\n\n &quot;As soon as I am gone.&quot; \n\n\n When the door was shut, the old woman hurriedly kindled a fire, boiled some water, and then dropped in the golden beetle, repeating these words again and again: \n\n\n\n\n &quot;Dumplings, dumplings, come to me, \n\n\n I am thin as thin can be. \n\n\n Dumplings, dumplings, smoking hot, \n\n\n Dumplings, dumplings, fill the pot.&quot; \n\n\n\n\n Would those three minutes never pass? Could the priest have told the truth? Her old head was nearly wild with excitement as clouds of steam rose from the kettle. Off came the lid! She could wait no longer. Wonder of wonders! There before her unbelieving eyes was a pot, full to the brim of pork dumplings, dancing up and down in the bubbling water, the best, the most delicious dumplings she had ever tasted. She ate and ate till there was no room left in her greedy stomach, and then she feasted the cat and the dog until they were ready to burst. \n\n\n &quot;Good fortune has come at last,&quot; whispered Blackfoot, the dog, to Whitehead, the cat, as they lay down to sun themselves outside. &quot;I fear I couldn\&#39;t have held out another week without running away to look for food. I don\&#39;t know just what\&#39;s happened, but there\&#39;s no use questioning the gods.&quot; \n\n\n Mrs. Wang fairly danced for joy at the thought of her son\&#39;s return and of how she would feast him. \n\n\n &quot;Poor boy, how surprised he will be at our fortune—and it\&#39;s all on account of his goodness to his old mother.&quot; \n\n\n When Ming-li came, with a dark cloud overhanging his brow, the widow saw plainly that disappointment was written there. \n\n\n &quot;Come, come, lad!&quot; she cried cheerily, &quot;clear up your face and smile, for the gods have been good to us and I shall soon show you how richly your devotion has been rewarded.&quot; So saying, she dropped the golden beetle into the boiling water and stirred up the fire. \n\n\n Thinking his mother had gone stark mad for want of food, Ming-li stared solemnly at her. Anything was preferable to this misery. Should he sell his last outer garment for a few pennies and buy millet for her? Blackfoot licked his hand comfortingly, as if to say, &quot;Cheer up, master, fortune has turned in our favour.&quot; Whitehead leaped upon a bench, purring like a sawmill. \n\n\n Ming-li did not have long to wait. Almost in the twinkling of an eye he heard his mother crying out, \n\n\n &quot;Sit down at the table, son, and eat these dumplings while they are smoking hot.&quot; \n\n\n Could he have heard correctly? Did his ears deceive him? No, there on the table was a huge platter full of the delicious pork dumplings he liked better than anything else in all the world, except, of course, his mother. \n\n\n &quot;Eat and ask no questions,&quot; counselled the Widow Wang. &quot;When you are satisfied I will tell you everything.&quot; \n\n\n Wise advice! Very soon the young man\&#39;s chopsticks were twinkling like a little star in the verses. He ate long and happily, while his good mother watched him, her heart overflowing with joy at seeing him at last able to satisfy his hunger. But still the old woman could hardly wait for him to finish, she was so anxious to tell him her wonderful secret. \n\n\n &quot;Here, son!&quot; she cried at last, as he began to pause between mouthfuls, &quot;look at my treasure!&quot; And she held out to him the golden beetle. \n\n\n &quot;First tell me what good fairy of a rich man has been filling our hands with silver?&quot; \n\n\n &quot;That\&#39;s just what I am trying to tell you,&quot; she laughed, &quot;for there was a fairy here this afternoon sure enough, only he was dressed like a bald priest. That golden beetle is all he gave me, but with it comes a secret worth thousands of cash to us.&quot; \n\n\n The youth fingered the trinket idly, still doubting his senses, and waiting impatiently for the secret of his delicious dinner. &quot;But, mother, what has this brass bauble to do with the dumplings, these wonderful pork dumplings, the finest I ever ate?&quot; \n\n\n &quot;Baubles indeed! Brass! Fie, fie, my boy! You little know what you are saying. Only listen and you shall hear a tale that will open your eyes.&quot; \n\n\n She then told him what had happened, and ended by setting all of the left-over dumplings upon the floor for Blackfoot and Whitehead, a thing her son had never seen her do before, for they had been miserably poor and had had to save every scrap for the next meal. \n\n\n Now began a long period of perfect happiness. Mother, son, dog and cat—all enjoyed themselves to their hearts\&#39; content. All manner of new foods such as they had never tasted were called forth from the pot by the wonderful little beetle. Bird-nest soup, shark\&#39;s fins, and a hundred other delicacies were theirs for the asking, and soon Ming-li regained all his strength, but, I fear, at the same time grew somewhat lazy, for it was no longer necessary for him to work. As for the two animals, they became fat and sleek and their hair grew long and glossy. \n\n\n \&#39;HERE SON!\&#39; SHE CRIED, \&#39;HAVE A LOOK AT MY TREASURE!\&#39; \n But alas! according to a Chinese proverb, pride invites sorrow. The little family became so proud of their good fortune that they began to ask friends and relatives to dinner that they might show off their good meals. One day a Mr. and Mrs. Chu came from a distant village. They were much astonished at seeing the high style in which the Wangs lived. They had expected a beggar\&#39;s meal, but went away with full stomachs. \n\n\n &quot;It\&#39;s the best stuff I ever ate,&quot; said Mr. Chu, as they entered their own tumble-down house. \n\n\n &quot;Yes, and I know where it came from,&quot; exclaimed his wife. &quot;I saw Widow Wang take a little gold ornament out of the pot and hide it in a cupboard. It must be some sort of charm, for I heard her mumbling to herself about pork and dumplings just as she was stirring up the fire.&quot; \n\n\n &quot;A charm, eh? Why is it that other people have all the luck? It looks as if we were doomed forever to be poor.&quot; \n\n\n &quot;Why not borrow Mrs. Wang\&#39;s charm for a few days until we can pick up a little flesh to keep our bones from clattering? Turn about\&#39;s fair play. Of course, we\&#39;ll return it sooner or later.&quot; \n\n\n &quot;Doubtless they keep very close watch over it. When would you find them away from home, now that they don\&#39;t have to work any more? As their house only contains one room, and that no bigger than ours, it would be difficult to borrow this golden trinket. It is harder, for more reasons than one, to steal from a beggar than from a king.&quot; \n\n\n &quot;Luck is surely with us,&quot; cried Mrs. Chu, clapping her hands. &quot;They are going this very day to the Temple fair. I overheard Mrs. Wang tell her son that he must not forget he was to take her about the middle of the afternoon. I will slip back then and borrow the little charm from the box in which she hid it.&quot; \n\n\n &quot;Aren\&#39;t you afraid of Blackfoot?&quot; \n\n\n &quot;Pooh! he\&#39;s so fat he can do nothing but roll. If the widow comes back suddenly, I\&#39;ll tell her I came to look for my big hair-pin, that I lost it while I was at dinner.&quot; \n\n\n &quot;All right, go ahead, only of course we must remember we\&#39;re borrowing the thing, not stealing it, for the Wangs have always been good friends to us, and then, too, we have just dined with them.&quot; \n\n\n So skilfully did this crafty woman carry out her plans that within an hour she was back in her own house, gleefully showing the priest\&#39;s charm to her husband. Not a soul had seen her enter the Wang house. The dog had made no noise, and the cat had only blinked her surprise at seeing a stranger and had gone to sleep again on the floor. \n\n\n Great was the clamour and weeping when, on returning from the fair in expectation of a hot supper, the widow found her treasure missing. It was long before she could grasp the truth. She went back to the little box in the cupboard ten times before she could believe it was empty, and the room looked as if a cyclone had struck it, so long and carefully did the two unfortunates hunt for the lost beetle. \n\n\n Then came days of hunger which were all the harder to bear since the recent period of good food and plenty. Oh, if they had only not got used to such dainties! How hard it was to go back to scraps and scrapings! \n\n\n But if the widow and her son were sad over the loss of the good meals, the two pets were even more so. They were reduced to beggary and had to go forth daily upon the streets in search of stray bones and refuse that decent dogs and cats turned up their noses at. \n\n\n One day, after this period of starvation had been going on for some time, Whitehead began suddenly to frisk about in great excitement. \n\n\n &quot;Whatever is the matter with you?&quot; growled Blackfoot. &quot;Are you mad from hunger, or have you caught another flea?&quot; \n\n\n &quot;I was just thinking over our affairs, and now I know the cause of all our trouble.&quot; \n\n\n &quot;Do you indeed?&quot; sneered Blackfoot. \n\n\n &quot;Yes, I do indeed, and you\&#39;d better think twice before you mock me, for I hold your future in my paw, as you will very soon see.&quot; \n\n\n &quot;Well, you needn\&#39;t get angry about nothing. What wonderful discovery have you made—that every rat has one tail?&quot; \n\n\n &quot;First of all, are you willing to help me bring good fortune back to our family?&quot; \n\n\n &quot;Of course I am. Don\&#39;t be silly,&quot; barked the dog, wagging his tail joyfully at the thought of another good dinner. &quot;Surely! surely! I will do anything you like if it will bring Dame Fortune back again.&quot; \n\n\n &quot;All right. Here is the plan. There has been a thief in the house who has stolen our mistress\&#39;s golden beetle. You remember all our big dinners that came from the pot? Well, every day I saw our mistress take a little golden beetle out of the black box and put it into the pot. One day she held it up before me, saying, \&#39;Look, puss, there is the cause of all our happiness. Don\&#39;t you wish it was yours?\&#39; Then she laughed and put it back into the box that stays in the cupboard.&quot; \n\n\n &quot;Is that true?&quot; questioned Blackfoot. &quot;Why didn\&#39;t you say something about it before?&quot; \n\n\n &quot;You remember the day Mr. and Mrs. Chu were here, and how Mrs. Chu returned in the afternoon after master and mistress had gone to the fair? I saw her, out of the tail of my eye, go to that very black box and take out the golden beetle. I thought it curious, but never dreamed she was a thief. Alas! I was wrong! She took the beetle, and if I am not mistaken, she and her husband are now enjoying the feasts that belong to us.&quot; \n\n\n &quot;Let\&#39;s claw them,&quot; growled Blackfoot, gnashing his teeth. \n\n\n &quot;That would do no good,&quot; counselled the other, &quot;for they would be sure to come out best in the end. We want the beetle back—that\&#39;s the main thing. We\&#39;ll leave revenge to human beings; it is none of our business.&quot; \n\n\n &quot;What do you suggest?&quot; said Blackfoot. &quot;I am with you through thick and thin.&quot; \n\n\n &quot;Let\&#39;s go to the Chu house and make off with the beetle.&quot; \n\n\n &quot;Alas, that I am not a cat!&quot; moaned Blackfoot. &quot;If we go there I couldn\&#39;t get inside, for robbers always keep their gates well locked. If I were like you I could scale the wall. It is the first time in all my life I ever envied a cat.&quot; \n\n\n &quot;We will go together,&quot; continued Whitehead. &quot;I will ride on your back when we are fording the river, and you can protect me from strange animals. When we get to the Chu house, I will climb over the wall and manage the rest of the business myself. Only you must wait outside to help me to get home with the prize.&quot; \n\n\n No sooner arranged than done. The companions set out that very night on their adventure. They crossed the river as the cat had suggested, and Blackfoot really enjoyed the swim, for, as he said, it took him back to his puppyhood, while the cat did not get a single drop of water on her face. It was midnight when they reached the Chu house. \n\n\n &quot;Just wait till I return,&quot; purred Whitehead in Blackfoot\&#39;s ear. \n\n\n With a mighty spring she reached the top of the mud wall, and then jumped down to the inside court. While she was resting in the shadow, trying to decide just how to go about her work, a slight rustling attracted her attention, and pop! one giant spring, one stretch-out of the claws, and she had caught a rat that had just come out of his hole for a drink and a midnight walk. \n\n\n Now, Whitehead was so hungry that she would have made short work of this tempting prey if the rat had not opened its mouth and, to her amazement, begun to talk in good cat dialect. \n\n\n &quot;Pray, good puss, not so fast with your sharp teeth! Kindly be careful with your claws! Don\&#39;t you know it is the custom now to put prisoners on their honour? I will promise not to run away.&quot; \n\n\n &quot;Pooh! what honour has a rat?&quot; \n\n\n &quot;Most of us haven\&#39;t much, I grant you, but my family was brought up under the roof of Confucius, and there we picked up so many crumbs of wisdom that we are exceptions to the rule. If you will spare me, I will obey you for life, in fact, will be your humble slave.&quot; Then, with a quick jerk, freeing itself, &quot;See, I am loose now, but honour holds me as if I were tied, and so I make no further attempt to get away.&quot; \n\n\n &quot;Much good it would do you,&quot; purred Whitehead, her fur crackling noisily, and her mouth watering for a taste of rat steak. &quot;However, I am quite willing to put you to the test. First, answer a few polite questions and I will see if you\&#39;re a truthful fellow. What kind of food is your master eating now, that you should be so round and plump when I am thin and scrawny?&quot; \n\n\n &quot;Oh, we have been in luck lately, I can tell you. Master and mistress feed on the fat of the land, and of course we hangers-on get the crumbs.&quot; \n\n\n &quot;But this is a poor tumble-down house. How can they afford such eating?&quot; \n\n\n &quot;That is a great secret, but as I am in honour bound to tell you, here goes. My mistress has just obtained in some manner or other, a fairy\&#39;s charm——&quot; \n\n\n &quot;She stole it from our place,&quot; hissed the cat, &quot;I will claw her eyes out if I get the chance. Why, we\&#39;ve been fairly starving for want of that beetle. She stole it from us just after she had been an invited guest! What do you think of that for honour, Sir Rat? Were your mistress\&#39;s ancestors followers of the sage?&quot; \n\n\n &quot;Oh, oh, oh! Why, that explains everything!&quot; wailed the rat. &quot;I have often wondered how they got the golden beetle, and yet of course I dared not ask any questions.&quot; \n\n\n &quot;No, certainly not! But hark you, friend rat—you get that golden trinket back for me, and I will set you free at once of all obligations. Do you know where she hides it?&quot; \n\n\n &quot;Yes, in a crevice where the wall is broken. I will bring it to you in a jiffy, but how shall we exist when our charm is gone? There will be a season of scanty food, I fear; beggars\&#39; fare for all of us.&quot; \n\n\n &quot;Live on the memory of your good deed,&quot; purred the cat. &quot;It is splendid, you know, to be an honest beggar. Now scoot! I trust you completely, since your people lived in the home of Confucius. I will wait here for your return. Ah!&quot; laughed Whitehead to herself, &quot;luck seems to be coming our way again!&quot; \n\n\n Five minutes later the rat appeared, bearing the trinket in its mouth. It passed the beetle over to the cat, and then with a whisk was off for ever. Its honour was safe, but it was afraid of Whitehead. It had seen the gleam of desire in her green eyes, and the cat might have broken her word if she had not been so anxious to get back home where her mistress could command the wonderful kettle once more to bring forth food. \n\n\n The two adventurers reached the river just as the sun was rising above the eastern hills. \n\n\n &quot;Be careful,&quot; cautioned Blackfoot, as the cat leaped upon his back for her ride across the stream, &quot;be careful not to forget the treasure. In short, remember that even though you are a female, it is necessary to keep your mouth closed till we reach the other side.&quot; \n\n\n &quot;Thanks, but I don\&#39;t think I need your advice,&quot; replied Whitehead, picking up the beetle and leaping on to the dog\&#39;s back. \n\n\n But alas! just as they were nearing the farther shore, the excited cat forgot her wisdom for a moment. A fish suddenly leaped out of the water directly under her nose. It was too great a temptation. Snap! went her jaws in a vain effort to land the scaly treasure, and the golden beetle sank to the bottom of the river. \n\n\n &quot;There!&quot; said the dog angrily, &quot;what did I tell you? Now all our trouble has been in vain—all on account of your stupidity.&quot; \n\n\n For a time there was a bitter dispute, and the companions called each other some very bad names—such as turtle and rabbit. Just as they were starting away from the river, disappointed and discouraged, a friendly frog who had by chance heard their conversation offered to fetch the treasure from the bottom of the stream. No sooner said than done, and after thanking this accommodating animal profusely, they turned homeward once more. \n\n\n When they reached the cottage the door was shut, and, bark as he would, Blackfoot could not persuade his master to open it. There was the sound of loud wailing inside. \n\n\n &quot;Mistress is broken-hearted,&quot; whispered the cat, &quot;I will go to her and make her happy.&quot; \n\n\n So saying, she sprang lightly through a hole in the paper window, which, alas! was too small and too far from the ground for the faithful dog to enter. \n\n\n A sad sight greeted the gaze of Whitehead. The son was lying on the bed unconscious, almost dead for want of food, while his mother, in despair, was rocking backwards and forwards wringing her wrinkled hands and crying at the top of her voice for some one to come and save them. \n\n\n &quot;Here I am, mistress,&quot; cried Whitehead, &quot;and here is the treasure you are weeping for. I have rescued it and brought it back to you.&quot; \n\n\n The widow, wild with joy at sight of the beetle, seized the cat in her scrawny arms and hugged the pet tightly to her bosom. \n\n\n &quot;Breakfast, son, breakfast! Wake up from your swoon! Fortune has come again. We are saved from starvation!&quot; \n\n\n Soon a steaming hot meal was ready, and you may well imagine how the old woman and her son, heaping praises upon Whitehead, filled the beast\&#39;s platter with good things, but never a word did they say of the faithful dog, who remained outside sniffing the fragrant odours and waiting in sad wonder, for all this time the artful cat had said nothing of Blackfoot\&#39;s part in the rescue of the golden beetle. \n\n\n At last, when breakfast was over, slipping away from the others, Whitehead jumped out through the hole in the window. \n\n\n &quot;Oh, my dear Blackfoot,&quot; she began laughingly, &quot;you should have been inside to see what a feast they gave me! Mistress was so delighted at my bringing back her treasure that she could not give me enough to eat, nor say enough kind things about me. Too bad, old fellow, that you are hungry. You\&#39;d better run out into the street and hunt up a bone.&quot; \n\n\n Maddened by the shameful treachery of his companion, the enraged dog sprang upon the cat and in a few seconds had shaken her to death. \n\n\n &quot;So dies the one who forgets a friend and who loses honour,&quot; he cried sadly, as he stood over the body of his companion. \n\n\n Rushing out into the street, he proclaimed the treachery of Whitehead to the members of his tribe, at the same time advising that all self-respecting dogs should from that time onwards make war upon the feline race. \n\n\n And that is why the descendants of old Blackfoot, whether in China or in the great countries of the West, have waged continual war upon the children and grandchildren of Whitehead, for a thousand generations of dogs have fought them and hated them with a great and lasting hatred. \n\n]&#39;, &#39;chapter&#39;: &#39;1&#39;}
</pre></div>
</div>
</div>
</div>
<p>And a free text search:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;king &quot;three princesses&quot;&#39;</span> <span class="c1"># This is a publisher</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search on: </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">story</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;tales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">quote_fts</span><span class="p">(</span><span class="n">q</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">story</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Search on: king &quot;three princesses&quot;

The three dogs (Sweden)
The Three Men of PowerEvening, Midnight, and Sunrise
The princess of the brazen mountain
The three princesses of Whiteland
The Queen Bee
The Three Dogs
Silverwhite and Lillwacker
The Gnome
Queen Crane
The Adventures of a Fishermans Son
Story of the Golden Mountain
Prince Bayaya: The Story of a Magic Horse
The Enchanted Pig
The Wonderful Sheep
The Three Princesses of Whiteland
The three princesses in the blue mountain
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT title, snippet(tales_fts, -1, &quot;__&quot;, &quot;__&quot;, &quot;...&quot;, 30) as clip</span>
<span class="s2">FROM tales_fts</span>
<span class="s2">WHERE tales_fts MATCH &#39;king &quot;three princesses&quot;&#39; LIMIT 5;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;title&#39;: &#39;Prince Bayaya: The Story of a Magic Horse&#39;, &#39;clip&#39;: &#39;...the __king__ was ready to set forth.\n\n\nHe handed over the affairs of the castle to Bayaya and also intrusted to him the safety of the __three princesses__. Bayaya did...&#39;}
{&#39;title&#39;: &#39;The three princesses of Whiteland&#39;, &#39;clip&#39;: &#39;[\nOnce on a time there was a fisherman who lived close by a palace, and fished for the *__King__’s* table. One day when he was out fishing he just...&#39;}
{&#39;title&#39;: &#39;The three princesses in the blue mountain&#39;, &#39;clip&#39;: &#39;[\nThere were once upon a time a *__King__* and *Queen* who had no children, and they took it so much to heart that they hardly ever had a happy moment...&#39;}
{&#39;title&#39;: &#39;The three dogs (Sweden)&#39;, &#39;clip&#39;: &#39;...The __king__ was much distressed, for he loved his children more than anything else in the world. So he gave strict orders that the __three princesses__ should be always kept...&#39;}
{&#39;title&#39;: &#39;The Queen Bee&#39;, &#39;clip&#39;: &quot;[\n\nTwo __king__&#39;s sons once started to seek adventures, and fell into a wild, reckless way of living, and gave up all thoughts of going home again. Their third and...&quot;}
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "psychemedia/storynotes",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="gibbs_tiny_tales.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Gibbs Tiny Tales Collection</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="Notes_and_Queries_DB.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Exploring Notes &amp; Queries</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Tony Hirst<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>